
<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial 2: Explicando INVO &mdash; Phalcon 1.3.0 documentation</title>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700,300italic,400italic,500italic&amp;subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/docs.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Phalcon 1.3.0 documentation" href="../index.html" />
    <link rel="next" title="Tutorial 3: Creating a Simple REST API" href="tutorial-rest.html" />
    <link rel="prev" title="Tutorial 1: Aprendamos usando ejemplos" href="tutorial.html" /> 
  </head>
  <body>
    <div id="wrapper">

        <div class="size-wrap">

            <div class="header clear-fix">
                <a class="header-logo" href="http://phalconphp.com"><span class="logo-text">Phalcon</span></a>
                <div class="header-right">
                    <iframe src="http://ghbtns.com/github-btn.html?user=phalcon&amp;repo=cphalcon&amp;type=watch&amp;count=true&amp;size=large"
allowtransparency="true" frameborder="0" scrolling="0" width="152px" height="30px"></iframe>
                </div>
                <ul class="header-nav">
                    <li><a href="http://phalconphp.com/" class="header-nav-link">Home</a></li>
                    <li><a href="http://phalconphp.com/download" class="header-nav-link">Download</a></li>
                    <li><a href="http://forum.phalconphp.com/" class="header-nav-link active">Forum</a></li>
                    <li><a href="http://blog.phalconphp.com/" class="header-nav-link">Blog</a></li>
                    <li><a href="http://phalconphp.com/support" class="header-nav-link">Support</a></li>
                    <li><a href="http://store.phalconphp.com/" class="header-nav-link">Store</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon" class="header-nav-link">GitHub</a></li>
                </ul>
            </div>

        </div>
    <div class="header-line">
      <div class="size-wrap">
        <div class="header-line-title title-white">Documentation</div>
      </div>
    </div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="tutorial-rest.html" title="Tutorial 3: Creating a Simple REST API"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial 1: Aprendamos usando ejemplos"
             accesskey="P">anterior</a> |</li>
        <li><a href="http://phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon 1.3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="90%" align="center">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            <div>
            <div id="searchbox" style="">
                <!--<form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="search" name="q" size="25" placeholder="Search">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>-->
                <div style="width:200px;padding:10px">
                  <gcse:searchbox-only></gcse:searchbox-only>
                </div>
                <hr>
            </div>
            </div>
            <div style="padding:5px;padding-left:10px">
              <div id="carbonads-container">
                <div class="carbonad"><div id="azcarbon"></div>
                <script type="text/javascript">var z = document.createElement("script"); z.type = "text/javascript"; z.async = true; z.src = "http://engine.carbonads.com/z/56496/azcarbon_2_1_0_VERT"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(z, s);</script>
                </div></div>
            </div>
            <h3><a href="../index.html">Contenidos</a></h3>
            <ul>
<li><a class="reference internal" href="#">Tutorial 2: Explicando INVO</a><ul>
<li><a class="reference internal" href="#estructura-del-proyecto">Estructura del Proyecto</a></li>
<li><a class="reference internal" href="#enrutamiento">Enrutamiento</a></li>
<li><a class="reference internal" href="#configuracion">Configuración</a></li>
<li><a class="reference internal" href="#autocargadores">Autocargadores</a></li>
<li><a class="reference internal" href="#atendiendo-la-peticion">Atendiendo la petición</a></li>
<li><a class="reference internal" href="#inyeccion-de-dependencias">Inyección de Dependencias</a></li>
<li><a class="reference internal" href="#iniciar-sesion-en-la-aplicacion">Iniciar sesión en la Aplicación</a></li>
<li><a class="reference internal" href="#asegurando-el-backend">Asegurando el Backend</a><ul>
<li><a class="reference internal" href="#administracion-de-events">Administración de Events</a></li>
<li><a class="reference internal" href="#crear-una-lista-acl">Crear una lista ACL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#componentes-de-usuario">Componentes de Usuario</a></li>
<li><a class="reference internal" href="#trabajando-con-cruds">Trabajando con CRUDs</a><ul>
<li><a class="reference internal" href="#formulario-de-buscar">Formulario de Buscar</a></li>
<li><a class="reference internal" href="#realizando-una-busqueda">Realizando una búsqueda</a></li>
<li><a class="reference internal" href="#creando-y-actualizando-registros">Creando y Actualizando Registros</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cambiar-el-titulo-dinamicamente">Cambiar el título dinámicamente</a></li>
<li><a class="reference internal" href="#conclusion">Conclusión</a></li>
</ul>
</li>
</ul>

            <h4>Tema anterior</h4>
            <p class="topless"><a href="tutorial.html" title="Capítulo anterior">&lt; Tutorial 1: Aprendamos usando ejemplos</a></p>
            <h4>Próximo tema</h4>
            <p class="topless"><a href="tutorial-rest.html" title="Próximo capítulo">Tutorial 3: Creating a Simple REST API &gt;</a></p>
            <h3>Esta página</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/tutorial-invo.txt" rel="nofollow">Enseñar el código</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body" >
                      
  <div class="section" id="tutorial-2-explicando-invo">
<h1>Tutorial 2: Explicando INVO<a class="headerlink" href="#tutorial-2-explicando-invo" title="Enlazar permanentemente con este título">¶</a></h1>
<p>En este segundo tutorial, explicaremos una aplicación más completa con el objetivo de profundizar en el desarrollo
con Phalcon.</p>
<p>INVO es una de las aplicaciones que hemos creado como ejemplo. INVO es un pequeño sitio web que permite a sus clientes
generar facturas, además de otras tareas como administrar clientes y productos. Puedes clonar su código fuente de <a class="reference external" href="https://github.com/phalcon/invo">Github</a>.</p>
<p>Adicionalmente, INVO fue creada con <a class="reference external" href="http://bootstrap.github.com/">Twitter Bootstrap</a> como framework en el cliente. A pesar que la aplicación
no genera facturas sirve como ejemplo para entender muchos aspectos y funcionalidades en el framework.</p>
<div class="section" id="estructura-del-proyecto">
<h2>Estructura del Proyecto<a class="headerlink" href="#estructura-del-proyecto" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Una vez clones el proyecto en tu raíz de directorios verás la siguiente estructura:</p>
<div class="highlight-bash"><div class="highlight"><pre>invo/
    app/
        app/config/
        app/controllers/
        app/library/
        app/models/
        app/plugins/
        app/views/
    public/
        public/bootstrap/
        public/css/
        public/js/
    schemas/
</pre></div>
</div>
<p>Como sabes, Phalcon no te impone una estructura de directorios en particular. Este proyecto tiene una
estructura de directorios para un MVC sencillo y una raíz pública de documentos.</p>
<p>Una vez abres la aplicación en tu navegador: <a class="reference external" href="http://localhost/invo">http://localhost/invo</a> verás algo como:</p>
<div class="figure align-center">
<img alt="../_images/invo-1.png" src="../_images/invo-1.png" />
</div>
<p>La aplicación está dividida en dos partes, un frontend, que es la parte pública donde los visitante pueden recivir
información además de solicitar información de contácto.</p>
<p>La segunda parte es el backend, un área administrativa donde un usuario registrado puede administrar
sus productos y clientes.</p>
</div>
<div class="section" id="enrutamiento">
<h2>Enrutamiento<a class="headerlink" href="#enrutamiento" title="Enlazar permanentemente con este título">¶</a></h2>
<p>INVO usa la forma estándar de enrutar que viene con el componente de enrutamiento. Estas rutas
usán el patrón que viene con el componente Router. El patrón es: /:controller/:action/:params.
Esto significa que la primera parte de la URI es el controlador, la segunda la acción y el resto
son los parámetros.</p>
<p>La ruta /session/register ejecuta el controlador &#8220;SessionController&#8221; y su acción &#8220;registerAction&#8221;.</p>
</div>
<div class="section" id="configuracion">
<h2>Configuración<a class="headerlink" href="#configuracion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>INVO tiene un archivo de configuración que establece parametros generales en la aplicación.
Este archivo es leído en las primeras líneas del bootstrap (public/index.php):</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Leer la configuración</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Config\Adapter\Ini</span><span class="p">(</span><span class="s1">&#39;../app/config/config.ini&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference internal" href="config.html"><em>Phalcon\Config</em></a> nos permite manipular el archivo usando programación orientada a objetos.
El archivo de configuración contiene la siguiente configuración.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[database]</span>
<span class="na">host</span>     <span class="o">=</span> <span class="s">localhost</span>
<span class="na">username</span> <span class="o">=</span> <span class="s">root</span>
<span class="na">password</span> <span class="o">=</span> <span class="s">secret</span>
<span class="na">name</span>     <span class="o">=</span> <span class="s">invo</span>

<span class="k">[application]</span>
<span class="na">controllersDir</span> <span class="o">=</span> <span class="s">/../app/controllers/</span>
<span class="na">modelsDir</span>      <span class="o">=</span> <span class="s">/../app/models/</span>
<span class="na">viewsDir</span>       <span class="o">=</span> <span class="s">/../app/views/</span>
<span class="na">pluginsDir</span>     <span class="o">=</span> <span class="s">/../app/plugins/</span>
<span class="na">libraryDir</span>     <span class="o">=</span> <span class="s">/../app/library/</span>
<span class="na">baseUri</span>        <span class="o">=</span> <span class="s">/invo/</span>

<span class="c1">;[metadata]</span>
<span class="c1">;adapter = &quot;Apc&quot;</span>
<span class="c1">;suffix = my-suffix</span>
<span class="c1">;lifetime = 3600</span>
</pre></div>
</div>
<p>Phalcon no tiene convenciones de configuración predeterminadas. Las secciones en el archivo nos ayudan a organizar la configuración
de manera apropiada. En este archivo hay trés secciones que se usarán luego.</p>
</div>
<div class="section" id="autocargadores">
<h2>Autocargadores<a class="headerlink" href="#autocargadores" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Una segunda parte que aparece en el bootstrap (public/index.php) es el autocargador (autoloader). Este registra un conjunto
de directorios que la aplicación utilizará para cargar las clases que eventualmente necesitará.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Loader</span><span class="p">();</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">registerDirs</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">controllersDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">pluginsDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">libraryDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">modelsDir</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
</pre></div>
</div>
<p>Lo que se ha hecho es registrar los directorios que están definidos en el archivo de configuración. El único
directorio que no está registrado es el viewsDir&#8217;, porque estas no contienen clases sino HTML y PHP.</p>
</div>
<div class="section" id="atendiendo-la-peticion">
<h2>Atendiendo la petición<a class="headerlink" href="#atendiendo-la-peticion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Vallamos mucho más adelante, al final del archivo, la petición es finalmente atendida por Phalcon\Mvc\Application,
esta clase inicializa y ejecuta todo lo necesario para que la aplicación sea ejecutada:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Mvc\Application</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

<span class="k">echo</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="inyeccion-de-dependencias">
<h2>Inyección de Dependencias<a class="headerlink" href="#inyeccion-de-dependencias" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En el código anterior, la variable $di es pasada al constructor de Phalcon\Mvc\Application.
¿Cuál es el proposito de esta variable? Como Phalcon es un framework altamente desacoplado, necesitamos un componente
que actúe como intermediario entre los distintos componentes para hacer que todo trabaje junto de una manera sencilla.
Este componente es Phalcon\DI. Es un contenedor de servicios que también permite injeccción de dependencias,
instanciando e inicializando todos los componentes a medida que son requeridos por la aplicación.</p>
<p>Hay muchas formas de registrar servicios en el contenedor. En INVO, la mayoría de servicios han sido registrados
usando funciones anonimas. Gracias a esto, Los objetos son instanciados solo cuando son requeridos, reduciendo
la cantidad de recursos requeridos por la aplicación.</p>
<p>Por ejemplo, en el siguiente codigo, el servicio de sesión es registrado, la función anónima solo es ejecutada
si la aplicación requiere acceder a datos de sessión:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Iniciar la sesión solamente la primera vez que un componente requiera el servicio de sesión</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Session\Adapter\Files</span><span class="p">();</span>
    <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$session</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Gracias a esto, tenemos la libertad de cambiar el adaptador, ejecutar inicializaciones adicionales y mucho más.
Ten en cuenta que el servicio se registró usando el nombre &#8220;session&#8221;. Esta es una convención que ayudará a los demás
componentes a solicitar el servicio correcto en el contenedor de servicios.</p>
<p>Una petición puede usar muchos servicios, registrar cada servicio puede ser tedioso. Por esta razón,
el framework proporciona una variante Phalcon\DI llamada Phalcon\DI\FactoryDefault cuyo objetivo es registrar
todos los servicios proporcionados por un framework full-stack.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// El FactoryDefault Dependency Injector registra automáticamente</span>
<span class="c1">// todos los servicios proporcionando un framework full stack</span>
<span class="nv">$di</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\DI\FactoryDefault</span><span class="p">();</span>
</pre></div>
</div>
<p>Así se registran la mayoria de servicios con componentes proporcionados por el framework como estándar. Si queremos
reemplazar la definición de un servicio podemos hacerla como hicimos antes con el servicio &#8220;session&#8221;. Esta es la razón
de la existencia de la variable $di.</p>
</div>
<div class="section" id="iniciar-sesion-en-la-aplicacion">
<h2>Iniciar sesión en la Aplicación<a class="headerlink" href="#iniciar-sesion-en-la-aplicacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El enlace &#8220;Log In&#8221; nos permitirá trabajar en los controladores del backend. La separación entre los controladores
del backend y los del frontend es solo lógica. Todos los controladores se encuentran ubicados en el directorio
(app/controllers/).</p>
<p>Para ingresar al sistema, debemos tener un nombre de usuario y contraseña válidos. Los usuarios son almacenados
en la tabla &#8220;users&#8221; de la base de datos &#8220;invo&#8221;.</p>
<p>Antes de iniciar sesión, necesitamos configurar la conexión a la base de datos de la aplicación. Un servicio
llamado &#8220;db&#8221; esta configurado en el contenedor de servicios con esta información. Así como lo hicimos con el
autocargador también vamos a tomar los parámetros del archivo de configuración.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// La conexión a la base de datos es creada basada en los parámetros definidos en el archivo de configuración</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Mysql</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">&quot;host&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">host</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">,</span>
        <span class="s2">&quot;dbname&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">name</span>
    <span class="p">));</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Este servicio retorna una instancia del adaptador de conexión a MySQL. De llegar a ser requerido, puedes hacer
acciones extra como agregar un logger, un profiler, cambiar el adaptador, agregar más opciones de configuración, etc.</p>
<p>Retomando el login, tenemos un formulario muy sencillo (app/views/session/index.phtml) que solicita los datos de inicio de
sesión. Hemos quitado algo de HTML para hacer el ejemplo más simple:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">form</span><span class="p">(</span><span class="s1">&#39;session/start&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>Nombre de usuario/Correo electrónico<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">textField</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;30&quot;</span><span class="p">))</span> <span class="cp">?&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>Contraseña<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">passwordField</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;30&quot;</span><span class="p">))</span> <span class="cp">?&gt;</span>

    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">submitButton</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;Autenticar&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>SessionController::startAction (app/controllers/SessionController.phtml) tiene la tarea de validar los
datos ingresados verificando si el usuario existe y sus credenciales son validas:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">SessionController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">startAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>

            <span class="c1">//Recibir los datos ingresados por el usuario</span>
            <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">);</span>
            <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

            <span class="nv">$password</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

            <span class="c1">//Buscar el usuario en la base de datos</span>
            <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Users</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;email = :email: AND password = :password: AND active = &#39;Y&#39;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bind&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$password</span><span class="p">)</span>
            <span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">!=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">&#39;Welcome &#39;</span> <span class="o">.</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
                <span class="c1">//Redireccionar la ejecución si el usuario es valido</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;invoices&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
                <span class="p">));</span>
            <span class="p">}</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">&#39;Wrong email/password&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//Redireccionar a el forma de login nuevamente</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
        <span class="p">));</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Por simplicidad, hemos usado &#8220;<a class="reference external" href="http://php.net/manual/en/function.sha1.php">sha1</a>&#8221; para guardar los passwords en la base de datos, sin embargo, este
algoritmo no es recomendado para aplicaciones reales, usa mejor &#8221; <a class="reference internal" href="security.html"><em>bcrypt</em></a>&#8221;.</p>
<p>Como pudiste ver, muchos atributos públicos fueron accedidos desde el controlador como: $this-&gt;flash, $this-&gt;request y $this-&gt;session.
Estos son servicios en el contenedor de servicios anteriormente. Cuando ellos son accedidos la primera vez, son injectados
como parte del controlador.</p>
<p>Estos servicios son compartidos, esto significa que siempre que accedamos a ellos estaremos accediendo a la misma instancia
sin importar desde donde los solicitemos.</p>
<p>Por ejemplo, aquí invocamos el servicio &#8220;session&#8221; y luego almacenamos la identidad del usuario logueado en la variable &#8216;auth&#8217;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
<span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="asegurando-el-backend">
<h2>Asegurando el Backend<a class="headerlink" href="#asegurando-el-backend" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El backend es una área privada donde solamente los usuarios registrados tienen acceso. Por lo tanto, es necesario
verificar que solo usuarios registrados tengan acceso a esos controladores. Si no estás autenticado en la aplicación y
tratas, por ejemplo de acceder al controlador &#8216;products&#8217; (que es privado) entonces verás una pantalla como esta:</p>
<div class="figure align-center">
<img alt="../_images/invo-2.png" src="../_images/invo-2.png" />
</div>
<p>Cada vez que alguien intente acceder a cualquier controlador/acción, la aplicación verifica si el perfil actual (en sesión)
tiene acceso a él, en caso contrario visualiza un mensaje como el anterior y redirecciona el usuario al inicio de la página.</p>
<p>Ahora, descubramos como la aplicación logra esto. Lo primero que debemos saber es que hay un componente llamado
<a class="reference internal" href="dispatching.html"><em>Dispatcher</em></a>. Este es informado sobre la ruta encontrada por componente el <a class="reference internal" href="routing.html"><em>Router</em></a>.
Luego es responsable de cargar el controlador apropiado y ejecutar la acción correspondiente.</p>
<p>Normalmente, el framework crea el despachador (dispatcher) automáticamente. En nuestro caso como debemos verificar
antes de ejecutar las acciones y revisar si el usuario tiene acceso a ellas. Para lograr esto reemplazaremos
la creación automática y crearemos una función en el bootstrap.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$di</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Ahora tenemos total control sobre como el Dispatcher es inicializado y usado en la aplicación. Muchos componentes
del framework lanzan eventos que nos permiten cambiar el funcionamiento interno o su operación. Así como el inyector
de dependencias funciona como intermedario de componentes, un nuevo componente llamado <a class="reference internal" href="events.html"><em>EventsManager</em></a>
nos ayuda a interceptar eventos producidos por un componente enrutando los eventos a los escuchadores.</p>
<div class="section" id="administracion-de-events">
<h3>Administración de Events<a class="headerlink" href="#administracion-de-events" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Un <a class="reference internal" href="events.html"><em>EventsManager</em></a> nos permite agregar escuchadores (listeners) a un tipo particular de evento. El tipo que
nos interesa ahora es &#8220;dispatch&#8221;, el siguiente código filtra todos los eventos producidos por Dispatcher:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$di</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//Crear un administrador de eventos</span>
    <span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Events\Manager</span><span class="p">();</span>

    <span class="c1">//Instanciar el plugin de seguridad</span>
    <span class="nv">$security</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Security</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

    <span class="c1">//Enviar todos los eventos producidos en el Dispatcher al plugin Security</span>
    <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">&#39;dispatch&#39;</span><span class="p">,</span> <span class="nv">$security</span><span class="p">);</span>

    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">();</span>

    <span class="c1">//Asignar el administrador de eventos al dispatcher</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>El plugin Security es una clase úbicada en (app/plugins/Security.php). Esta clase implementa
el método &#8220;beforeExecuteRoute&#8221;. Este tiene el mismo nombre de uno de los eventos producidos en el dispatcher.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Security</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeExecuteRoute</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Los escuchadores de eventos siempre reciben un primer parámetro que contiene información contextual del evento producido
y un segundo que es el objeto que produjo el evento como tal ($dispatcher). No es obligatorio que los plugins extiendan
la clase Phalcon\Mvc\User\Plugin, pero haciendo esto, ellos ganan acceso de forma simple a los servicios disponibles
en la aplicación.</p>
<p>Ahora, verificamos si el pérfil (role) actual en sesión tiene acceso usando una lista de control de acceso ACL.
Si no tiene acceso lo redireccionamos a la pantalla de inicio como explicamos anteriormente:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Security</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeExecuteRoute</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//Verificar si la variable de sesión &#39;auth&#39; está definida, esto indica si hay un usuario autenticado</span>
        <span class="nv">$auth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$auth</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">&#39;Guests&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">&#39;Users&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Obtener el controlador y acción actual desde el Dispatcher</span>
        <span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getControllerName</span><span class="p">();</span>
        <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">();</span>

        <span class="c1">//Obtener la lista ACL</span>
        <span class="nv">$acl</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getAcl</span><span class="p">();</span>

        <span class="c1">//Verificar si el pérfil (role) tiene acceso al controlador/acción</span>
        <span class="nv">$allowed</span> <span class="o">=</span> <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">isAllowed</span><span class="p">(</span><span class="nv">$role</span><span class="p">,</span> <span class="nv">$controller</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$allowed</span> <span class="o">!=</span> <span class="nx">Phalcon\Acl</span><span class="o">::</span><span class="na">ALLOW</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//Si no tiene acceso mostramos un mensaje y lo redireccionamos al inicio</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s2">&quot;No tienes acceso a este módulo.&quot;</span><span class="p">);</span>
            <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
                <span class="p">)</span>
            <span class="p">);</span>

            <span class="c1">//Devolver &quot;false&quot; le indica al Dispatcher que debe detener la operación</span>
            <span class="c1">//y evitar que la acción se ejecute</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="crear-una-lista-acl">
<h3>Crear una lista ACL<a class="headerlink" href="#crear-una-lista-acl" title="Enlazar permanentemente con este título">¶</a></h3>
<p>En el ejemplo anterior, hemos obtenido la lista ACL usando el método $this-&gt;_getAcl(). Este método
también es implementado en el plugin. Ahora, explicaremos paso a paso como construir la lista de control de acceso.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Crear el ACL</span>
<span class="nv">$acl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Adapter\Memory</span><span class="p">();</span>

<span class="c1">//La acción por defecto es denegar (DENY)</span>
<span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">setDefaultAction</span><span class="p">(</span><span class="nx">Phalcon\Acl</span><span class="o">::</span><span class="na">DENY</span><span class="p">);</span>

<span class="c1">//Registrar dos roles, &#39;users&#39; son usuarios registrados</span>
<span class="c1">//y &#39;guests&#39; son los usuarios sin un pérfil definido (invitados)</span>
<span class="nv">$roles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Role</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">),</span>
    <span class="s1">&#39;guests&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Role</span><span class="p">(</span><span class="s1">&#39;Guests&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addRole</span><span class="p">(</span><span class="nv">$role</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ahora definiremos los recursos para cada área respectívamente. Los nombres de controladores son recursos y
sus acciones son accesos a los recursos:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Recursos del área privada (backend)</span>
<span class="nv">$privateResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;companies&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;products&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;producttypes&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;invoices&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Phalcon\Acl\Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//Recursos del área pública (frontend)</span>
<span class="nv">$publicResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;index&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
  <span class="s1">&#39;about&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
  <span class="s1">&#39;session&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">),</span>
  <span class="s1">&#39;contact&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;send&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Phalcon\Acl\Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>El ACL ahora tiene conocimiento de los controladores existentes y sus acciones. El perfil &#8220;Users&#8221;
tiene acceso tanto al backend y al frontend. El perfil &#8220;Guests&#8221; solo tiene acceso al área pública.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Permitir acceso al área pública tanto a usuarios como a invitados</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="nv">$role</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$resource</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Permitir acceso al área privada solo al pérfil &quot;Users&quot;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$actions</span> <span class="k">as</span> <span class="nv">$action</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="nv">$resource</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Super!, la ACL está ahora completa</p>
</div>
</div>
<div class="section" id="componentes-de-usuario">
<h2>Componentes de Usuario<a class="headerlink" href="#componentes-de-usuario" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Todos los elementos visuales en la aplicación han sido logrados usando mayormente con <a class="reference external" href="http://bootstrap.github.com/">Twitter Bootstrap</a>.
Algunos elementos, como la barra de navegación cambian de acuerdo al estado actual de la aplicación.
Por ejemplo, en la esquina superior derecha, el link &#8220;Log in / Sign Up&#8221; cambia a &#8220;Log out&#8221; si un
usuario ha iniciado sesión en la aplicación.</p>
<p>Esta parte de la aplicación es implementada en el componente de usuario &#8220;Elements&#8221; (app/library/Elements.php).</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\User\Component</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Elements</span> <span class="k">extends</span> <span class="nx">Component</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMenu</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTabs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Esta clase extiende de Phalcon\Mvc\User\Component, no es obligatorio que los componentes de usuario extiendan de esa clase,
sin embargo esto ayuda a que puedan acceder facilmente a los servicios de la aplicación. Ahora vamos a registrar
esta clase en el contenedor de servicios:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Registrar un componente de usuario</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;elements&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Elements</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Así como los controladores, plugins o componentes, dentro de una vista, este componente también puede
acceder a los servicios de la aplicación simplemente accediendo a un atributo con el mismo nombre de un
servicio previamente registrado:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>INVO<span class="nt">&lt;/a&gt;</span>
            <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elements</span><span class="o">-&gt;</span><span class="na">getMenu</span><span class="p">()</span> <span class="cp">?&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">()</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;hr&gt;</span>
    <span class="nt">&lt;footer&gt;</span>
        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Company 2012<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>La parte relevante es:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elements</span><span class="o">-&gt;</span><span class="na">getMenu</span><span class="p">()</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="trabajando-con-cruds">
<h2>Trabajando con CRUDs<a class="headerlink" href="#trabajando-con-cruds" title="Enlazar permanentemente con este título">¶</a></h2>
<p>La mayor parte de opciones que manipulan datos (compañias, productos y tipos de productos), han sido desarrollados
usando un básico y común <a class="reference external" href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> (Create, Read, Update and Delete). Cada CRUD contiene los siguientes archivos:</p>
<div class="highlight-bash"><div class="highlight"><pre>invo/
    app/
        app/controllers/
            ProductsController.php
        app/models/
            Products.php
        app/views/
            products/
                edit.phtml
                index.phtml
                new.phtml
                search.phtml
</pre></div>
</div>
<p>Cada controlador implementa las siguientes acciones:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * La acción de inicio, permite buscar productos</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Realiza la búsqueda basada en los parámetros de usuario</span>
<span class="sd">     * devolviendo un paginador</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">searchAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Muestra la vista de crear nuevos productos</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">newAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Muestra la vista para editar productos existentes</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Crea un nuevo producto basado en los datos ingresados en la acción &quot;new&quot;</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Actualiza un producto basado en los datos ingresados en la acción &quot;edit&quot;</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Elimina un producto existente</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">deleteAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="formulario-de-buscar">
<h3>Formulario de Buscar<a class="headerlink" href="#formulario-de-buscar" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Cada CRUD inicia con un formulario de búsqueda. Este formulario muestra cada campo que tiene la tabla (productos),
permitiendo al usuario crear un criterio de búsqueda por cada campo. La tabla &#8220;productos&#8221; tiene una relación
a la tabla &#8220;product_types&#8221;. En este caso, previamente consultamos los registros en esta tabla para facilitar al usuario
su búsqueda por este campo.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd">     * La acción de inicio, permite buscar productos</span>
<span class="sd">     */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">persistent</span><span class="o">-&gt;</span><span class="na">searchParams</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">productTypes</span> <span class="o">=</span> <span class="nx">ProductTypes</span><span class="o">::</span><span class="na">find</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Todos los tipos de productos son consultados y pasados a la vista como una variable local $productTypes. Luego,
en la vista (app/views/index.phtml) mostramos una etiqueta &#8220;select&#8221; llena con esos datos:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;product_types_id&quot;</span><span class="nt">&gt;</span>Product Type<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span>
        <span class="nv">$productTypes</span><span class="p">,</span>
        <span class="s2">&quot;using&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="s2">&quot;useDummy&quot;</span> <span class="o">=&gt;</span> <span class="k">true</span>
    <span class="p">))</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>Fijate que $productTypes contiene todos los datos necesarios para llenar la etiqueta SELECT usando Phalcon\Tag::select.
Una vez el formulario es enviado, la acción &#8220;search&#8221; es ejecutada en el controlado realizando la búsqueda basada en los parámetros entrados
por el usuario.</p>
</div>
<div class="section" id="realizando-una-busqueda">
<h3>Realizando una búsqueda<a class="headerlink" href="#realizando-una-busqueda" title="Enlazar permanentemente con este título">¶</a></h3>
<p>La acción &#8220;search&#8221; tiene un doble objetivo. Cuando es accedida via POST, realiza una búsqueda basada en los parámetros
ingresados por el usuario y cuando se accede via GET mueve la pagína actual en el paginador. Para diferenciar un método del
otro usamos el componente <a class="reference internal" href="request.html"><em>Request</em></a>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Realiza la búsqueda basada en los parámetros de usuario</span>
<span class="sd"> * devolviendo un paginador</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">searchAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">//crear las condiciones de búsqueda</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//paginar usando las condiciones existentes</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Con la ayuda de <a class="reference internal" href="../api/Phalcon_Mvc_Model_Criteria.html"><em>Phalcon\Mvc\Model\Criteria</em></a>, podemos crear una búsqueda
de manera inteligente basada en los tipos de datos enviados en el formulario:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nx">Criteria</span><span class="o">::</span><span class="na">fromInput</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">di</span><span class="p">,</span> <span class="s2">&quot;Products&quot;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span>
</pre></div>
</div>
<p>Este método verifica que valores son diferentes a &#8220;&#8221; (cadena vacia) y nulo y los toma en cuenta para crear el criterio de búsqueda</p>
<ul class="simple">
<li>Si el campo tiene un tipo de dato de texto o similar (char, varchar, text, etc.) Usa el operador SQL &#8220;like&#8221; para filtrar los resultados</li>
<li>Si el tipo de dato no es texto, entonces usará el operador &#8220;=&#8221;</li>
</ul>
<p>Adicionalmente, &#8220;Criteria&#8221; ignora todas las variables $_POST que no correspondan a campos en la tabla.
Los valores son automáticamente escapados usando &#8220;bound parameters&#8221; evitando inyecciones de SQL.</p>
<p>Ahora, almacenamos los parametros producidos en la bolsa de datos de sesión del controlador:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">persistent</span><span class="o">-&gt;</span><span class="na">searchParams</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">();</span>
</pre></div>
</div>
<p>Una bolsa de sesión, es un atributo especial en un controlador que es persistente entre peticiones.
Al ser accedido, este atributo es inyectado con un servicio <a class="reference internal" href="../api/Phalcon_Session_Bag.html"><em>Phalcon\Session\Bag</em></a>
que es independiente por controlador/clase.</p>
<p>Luego, basado en los parámetros construidos anteriormente:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$products</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">notice</span><span class="p">(</span><span class="s2">&quot;No se encontraron productos para la búsqueda realizada.&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si la búsqueda no retorna ningún producto, redireccionamos al usuario a la vista de inicio nuevamente.
Supongamos que retornó registros, entonces creamos un páginador para navegar fácilmente a través de ellos:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$paginator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Paginator\Adapter\Model</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">&quot;data&quot;</span> <span class="o">=&gt;</span> <span class="nv">$products</span><span class="p">,</span>    <span class="c1">//Data to paginate</span>
    <span class="s2">&quot;limit&quot;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>           <span class="c1">//Rows per page</span>
    <span class="s2">&quot;page&quot;</span> <span class="o">=&gt;</span> <span class="nv">$numberPage</span>   <span class="c1">//Active page</span>
<span class="p">));</span>

<span class="c1">//Obtener la página activa</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$paginator</span><span class="o">-&gt;</span><span class="na">getPaginate</span><span class="p">();</span>
</pre></div>
</div>
<p>Finalmente pasamos la página devuelta a la vista:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">page</span> <span class="o">=</span> <span class="nv">$page</span><span class="p">;</span>
</pre></div>
</div>
<p>En la vista (app/views/products/search.phtml), recorremos los resultados correspondientes de la página actual:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$page</span><span class="o">-&gt;</span><span class="na">items</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getProductTypes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">price</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">active</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">linkTo</span><span class="p">(</span><span class="s2">&quot;products/edit/&quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">linkTo</span><span class="p">(</span><span class="s2">&quot;products/delete/&quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;Delete&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="creando-y-actualizando-registros">
<h3>Creando y Actualizando Registros<a class="headerlink" href="#creando-y-actualizando-registros" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Ahora vemos como en un CRUD se puede crear y actualizar registros. Desde las vistas &#8220;new&#8221; y &#8220;edit&#8221; los datos
son ingresados por el usuario y enviados a las acciones &#8220;create&#8221; y &#8220;save&#8221; que realizan las acciones de crear y
actualizar productos respectivamente.</p>
<p>En el caso de creación, recuperamos los datos enviados y los asignamos a una nueva instancia de &#8220;Products&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="nv">$products</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Products</span><span class="p">();</span>

    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">product_types_id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;striptags&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">price</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">active</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Los datos son filtrados antes de ser asignados al objeto. Realizar este filtrado es opcional, el ORM escapa los datos
de entrada y realiza conversiones de tipos de dato antes de guardar. Sin embargo, es recomendable para asegurarnos
que la entrada no contiene caracteres basura ó invalidos.</p>
<p>Al guardar, sabremos si los datos cumplen con las reglas de negocio y validaciones adicionales implementadas en el modulo Products:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$products</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">())</span> <span class="p">{</span>

        <span class="c1">//Guardar falló, mostrar los mensajes</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$products</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/new&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s2">&quot;Product was created successfully&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Ahora, en el caso de la actualización, primero debemos presentar al usuario los datos correspondientes al registro editado:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Muestra la vista para editar un producto existente</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">findFirstById</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">product_types_id</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">price</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">active</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>El método &#8220;<a class="reference external" href="Tag::setDefault">Tag::setDefault</a>&#8221; nos permite asignar un valor predeterminado a un atributo con el mismo nombre en la forma.
Gracias a esto, un usuario puede cambiar cualquier valor y luego enviarlo de vuelta a la base de datos usando la acción &#8220;save&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Actualiza un producto basado en los datos ingresados en la acción &quot;edit&quot;</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="c1">//Buscar el producto a actualizar</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">findFirstById</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s2">&quot;products does not exist &quot;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//... asignar los valores al objeto y guardar</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cambiar-el-titulo-dinamicamente">
<h2>Cambiar el título dinámicamente<a class="headerlink" href="#cambiar-el-titulo-dinamicamente" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Cuando navegas entre una opción y otra verás que el título de la página cambia dinamicamente indicando
donde estamos trabajando actualmente. Esto se logra en el método inicializador de cada controlador:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Establecer el título de la página</span>
        <span class="nx">Tag</span><span class="o">::</span><span class="na">setTitle</span><span class="p">(</span><span class="s1">&#39;Manage your product types&#39;</span><span class="p">);</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">initialize</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>El método parent::initialize() en la clase padre se llama igualmente, esté agrega más información al título:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ControllerBase</span> <span class="k">extends</span> <span class="nx">Phalcon\Mvc\Controller</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Agregar el nombre de la aplicación al principio del título</span>
        <span class="nx">Phalcon\Tag</span><span class="o">::</span><span class="na">prependTitle</span><span class="p">(</span><span class="s1">&#39;INVO | &#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finalmente, el título se imprime en la vista principal (app/views/index.phtml):</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">use</span> <span class="nx">Phalcon\Tag</span> <span class="k">as</span> <span class="nx">Tag</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">getTitle</span><span class="p">()</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusión<a class="headerlink" href="#conclusion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Este tutorial cubre muchos más aspectos del desarrollo de aplicaciones con Phalcon, esperamos te hayan
servido para aprender más y sacar más provecho al framework.</p>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="tutorial-rest.html" title="Tutorial 3: Creating a Simple REST API"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial 1: Aprendamos usando ejemplos"
             >anterior</a> |</li> 
      </ul>
    </div>
        <div id="footer">

          <p>Found a typo or an error? Want to improve this document? The documentation sources are available on <a href="http://github.com/phalcon/docs">Github</a></p>
          <p>Need support or have questions? Check our <a href="http://phalconphp.com/support">Support Page</a></p>

          <p>The Phalcon PHP Framework is released under the <a href="https://github.com/phalcon/cphalcon/blob/master/docs/LICENSE.md">new BSD license</a>.</p>
          <p>Except where otherwise noted, content on this site is licensed under the
            <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License.</a></p>
             Actualizado por última vez en Oct 21, 2014.
            Creado con <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.

          <p>
             &copy; Copyright 2014, Phalcon Team and contributors.
          </p>

            <div class="size-wrap footer-wrap">

                <div class="donate-wrap">
                    Donate to Phalcon: <a href="http://flattr.com/thing/1134206/Phalcon-PHP-Framework" target="_blank" class="button button-small orange">Flattr</a>
                    or
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" style="display: inline">
                        <input type="hidden" name="cmd" value="_s-xclick">
                        <input type="hidden" name="hosted_button_id" value="7LSYMNMFZNG8W">
                        <input class="button button-small orange" style="border: inherit; display: inline; font-weight: bold" type="submit" value="via Paypal" title="PayPal — The safer, easier way to pay online.">
                    </form>
                </div>

                <div class="social-links">
                    <a href="https://twitter.com/phalconphp" class="social-link tw">Twitter</a>
                    <a href="http://www.facebook.com/pages/Phalcon/134230726685897" class="social-link fb">Facebook</a>
                    <a href="https://plus.google.com/102376109340560896457" class="social-link gp">Google Plus</a>
                    <a href="http://vimeo.com/user10964377" class="social-link vm">Vimeo</a>
                </div>

            </div>

        </div>

    </div>
    <script type="text/javascript">
    $(window).on("load", function(){
      var cx = '009733439235723428699:lh9ltjgvdz8';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
      /*window.setTimeout(function(){
        $('.gsc-search-button').css({
          'background': '#f06715',
          'padding': '2px',
          'border': '0'
        });
      }, 1000)*/
    });
    </script>

  </body>
</html>