
<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Security &mdash; Phalcon 1.3.0 documentation</title>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700,300italic,400italic,500italic&amp;subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/docs.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Phalcon 1.3.0 documentation" href="../index.html" />
    <link rel="next" title="Access Control Lists ACL" href="acl.html" />
    <link rel="prev" title="Improving Performance with Cache" href="cache.html" /> 
  </head>
  <body>
    <div id="wrapper">

        <div class="size-wrap">

            <div class="header clear-fix">
                <a class="header-logo" href="http://phalconphp.com"><span class="logo-text">Phalcon</span></a>
                <div class="header-right">
                    <iframe src="http://ghbtns.com/github-btn.html?user=phalcon&amp;repo=cphalcon&amp;type=watch&amp;count=true&amp;size=large"
allowtransparency="true" frameborder="0" scrolling="0" width="152px" height="30px"></iframe>
                </div>
                <ul class="header-nav">
                    <li><a href="http://phalconphp.com/" class="header-nav-link">Home</a></li>
                    <li><a href="http://phalconphp.com/download" class="header-nav-link">Download</a></li>
                    <li><a href="http://forum.phalconphp.com/" class="header-nav-link active">Forum</a></li>
                    <li><a href="http://blog.phalconphp.com/" class="header-nav-link">Blog</a></li>
                    <li><a href="http://phalconphp.com/support" class="header-nav-link">Support</a></li>
                    <li><a href="http://store.phalconphp.com/" class="header-nav-link">Store</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon" class="header-nav-link">GitHub</a></li>
                </ul>
            </div>

        </div>
    <div class="header-line">
      <div class="size-wrap">
        <div class="header-line-title title-white">Documentation</div>
      </div>
    </div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="acl.html" title="Access Control Lists ACL"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="cache.html" title="Improving Performance with Cache"
             accesskey="P">anterior</a> |</li>
        <li><a href="http://phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon 1.3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="90%" align="center">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            <div>
            <div id="searchbox" style="">
                <!--<form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="search" name="q" size="25" placeholder="Search">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>-->
                <div style="width:200px;padding:10px">
                  <gcse:searchbox-only></gcse:searchbox-only>
                </div>
                <hr>
            </div>
            </div>
            <div style="padding:5px;padding-left:10px">
              <div id="carbonads-container">
                <div class="carbonad"><div id="azcarbon"></div>
                <script type="text/javascript">var z = document.createElement("script"); z.type = "text/javascript"; z.async = true; z.src = "http://engine.carbonads.com/z/56496/azcarbon_2_1_0_VERT"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(z, s);</script>
                </div></div>
            </div>
            <h3><a href="../index.html">Contenidos</a></h3>
            <ul>
<li><a class="reference internal" href="#">Security</a><ul>
<li><a class="reference internal" href="#password-hashing">Password Hashing</a></li>
<li><a class="reference internal" href="#cross-site-request-forgery-csrf-protection">Cross-Site Request Forgery (CSRF) protection</a></li>
<li><a class="reference internal" href="#setting-up-the-component">Setting up the component</a></li>
</ul>
</li>
</ul>

            <h4>Tema anterior</h4>
            <p class="topless"><a href="cache.html" title="Capítulo anterior">&lt; Improving Performance with Cache</a></p>
            <h4>Próximo tema</h4>
            <p class="topless"><a href="acl.html" title="Próximo capítulo">Access Control Lists ACL &gt;</a></p>
            <h3>Esta página</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/security.txt" rel="nofollow">Enseñar el código</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body" >
                      
  <div class="section" id="security">
<h1>Security<a class="headerlink" href="#security" title="Enlazar permanentemente con este título">¶</a></h1>
<p>This component aids the developer in common security tasks such as password hashing and Cross-Site Request Forgery protection (CSRF).</p>
<div class="section" id="password-hashing">
<h2>Password Hashing<a class="headerlink" href="#password-hashing" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Storing passwords in plain text is a bad security practice. Anyone with access to the database will immediately have access to all user
accounts thus being able to engage in unauthorized activities. To combat that, many applications use the familiar one way hashing methods
“<a class="reference external" href="http://php.net/manual/en/function.md5.php">md5</a>” and “<a class="reference external" href="http://php.net/manual/en/function.sha1.php">sha1</a>”. However, hardware evolves each day, and becomes faster, these algorithms are becoming vulnerable
to brute force attacks. These attacks are also known as <a class="reference external" href="http://en.wikipedia.org/wiki/Rainbow_table">rainbow tables</a>.</p>
<p>To solve this problem we can use hash algorithms as <a class="reference external" href="http://en.wikipedia.org/wiki/Bcrypt">bcrypt</a>. Why bcrypt? Thanks to its “<a class="reference external" href="http://en.wikipedia.org/wiki/Bcrypt#Algorithm">Eksblowfish</a>” key setup algorithm
we could make the password encryption as “slow” as we want. Slow algorithms make the process to calculate the real
password behind a hash extremely difficult if not impossible. This will protect your for a long time from a
possible attack using rainbow tables.</p>
<p>This component gives you the ability to use this algorithm in a simple way:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

    <span class="k">class</span> <span class="nc">UsersController</span> <span class="k">extends</span> <span class="nx">Phalcon\Mvc\Controller</span>
    <span class="p">{</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">registerAction</span><span class="p">()</span>
        <span class="p">{</span>

            <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Users</span><span class="p">();</span>

            <span class="nv">$login</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
            <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">login</span> <span class="o">=</span> <span class="nv">$login</span><span class="p">;</span>

            <span class="c1">//Store the password hashed</span>
            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
        <span class="p">}</span>

    <span class="p">}</span>
</pre></div>
</div>
<p>We saved the password hashed with a default work factor. A higher work factor will make the password less vulnerable as
its encryption will be slow. We can check if the password is correct as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

    <span class="k">class</span> <span class="nc">SessionController</span> <span class="k">extends</span> <span class="nx">Phalcon\Mvc\Controller</span>
    <span class="p">{</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">loginAction</span><span class="p">()</span>
        <span class="p">{</span>

            <span class="nv">$login</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
            <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

            <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Users</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;login = ?0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bind&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$login</span><span class="p">)</span>
            <span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span><span class="o">-&gt;</span><span class="na">checkHash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">))</span> <span class="p">{</span>
                    <span class="c1">//The password is valid</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">//The validation failed</span>
        <span class="p">}</span>

    <span class="p">}</span>
</pre></div>
</div>
<p>The salt is generated using pseudo-random bytes with the PHP&#8217;s function <a class="reference external" href="http://php.net/manual/en/function.openssl-random-pseudo-bytes.php">openssl_random_pseudo_bytes</a> so is required to have the <a class="reference external" href="http://php.net/manual/en/book.openssl.php">openssl</a> extension loaded.</p>
</div>
<div class="section" id="cross-site-request-forgery-csrf-protection">
<h2>Cross-Site Request Forgery (CSRF) protection<a class="headerlink" href="#cross-site-request-forgery-csrf-protection" title="Enlazar permanentemente con este título">¶</a></h2>
<p>This is another common attack against web sites and applications. Forms designed to perform tasks such as user registration or adding comments
are vulnerable to this attack.</p>
<p>The idea is to prevent the form values from being sent outside our application. To fix this, we generate a <a class="reference external" href="http://en.wikipedia.org/wiki/Cryptographic_nonce">random nonce</a> (token) in each
form, add the token in the session and then validate the token once the form posts data back to our application by comparing the stored
token in the session to the one submitted by the form:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">form</span><span class="p">(</span><span class="s1">&#39;session/login&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>

        <span class="c">&lt;!-- login and password inputs ... --&gt;</span>

        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span><span class="o">-&gt;</span><span class="na">getTokenKey</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="s">&quot;</span>
                <span class="na">value=</span><span class="s">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="s">&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>Then in the controller&#8217;s action you can check if the CSRF token is valid:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">SessionController</span> <span class="k">extends</span> <span class="nx">Phalcon\Mvc\Controller</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">loginAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span><span class="o">-&gt;</span><span class="na">checkToken</span><span class="p">())</span> <span class="p">{</span>
                <span class="c1">//The token is ok</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Adding a <a class="reference external" href="http://www.google.com/recaptcha">captcha</a> to the form is also recommended to completely avoid the risks of this attack.</p>
</div>
<div class="section" id="setting-up-the-component">
<h2>Setting up the component<a class="headerlink" href="#setting-up-the-component" title="Enlazar permanentemente con este título">¶</a></h2>
<p>This component is automatically registered in the services container as &#8216;security&#8217;, you can re-register it
to setup it&#8217;s options:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(){</span>

        <span class="nv">$security</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Security</span><span class="p">();</span>

        <span class="c1">//Set the password hashing factor to 12 rounds</span>
        <span class="nv">$security</span><span class="o">-&gt;</span><span class="na">setWorkFactor</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$security</span><span class="p">;</span>
<span class="p">},</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="acl.html" title="Access Control Lists ACL"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="cache.html" title="Improving Performance with Cache"
             >anterior</a> |</li> 
      </ul>
    </div>
        <div id="footer">

          <p>Found a typo or an error? Want to improve this document? The documentation sources are available on <a href="http://github.com/phalcon/docs">Github</a></p>
          <p>Need support or have questions? Check our <a href="http://phalconphp.com/support">Support Page</a></p>

          <p>The Phalcon PHP Framework is released under the <a href="https://github.com/phalcon/cphalcon/blob/master/docs/LICENSE.md">new BSD license</a>.</p>
          <p>Except where otherwise noted, content on this site is licensed under the
            <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License.</a></p>
             Actualizado por última vez en Oct 21, 2014.
            Creado con <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.

          <p>
             &copy; Copyright 2014, Phalcon Team and contributors.
          </p>

            <div class="size-wrap footer-wrap">

                <div class="donate-wrap">
                    Donate to Phalcon: <a href="http://flattr.com/thing/1134206/Phalcon-PHP-Framework" target="_blank" class="button button-small orange">Flattr</a>
                    or
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" style="display: inline">
                        <input type="hidden" name="cmd" value="_s-xclick">
                        <input type="hidden" name="hosted_button_id" value="7LSYMNMFZNG8W">
                        <input class="button button-small orange" style="border: inherit; display: inline; font-weight: bold" type="submit" value="via Paypal" title="PayPal — The safer, easier way to pay online.">
                    </form>
                </div>

                <div class="social-links">
                    <a href="https://twitter.com/phalconphp" class="social-link tw">Twitter</a>
                    <a href="http://www.facebook.com/pages/Phalcon/134230726685897" class="social-link fb">Facebook</a>
                    <a href="https://plus.google.com/102376109340560896457" class="social-link gp">Google Plus</a>
                    <a href="http://vimeo.com/user10964377" class="social-link vm">Vimeo</a>
                </div>

            </div>

        </div>

    </div>
    <script type="text/javascript">
    $(window).on("load", function(){
      var cx = '009733439235723428699:lh9ltjgvdz8';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
      /*window.setTimeout(function(){
        $('.gsc-search-button').css({
          'background': '#f06715',
          'padding': '2px',
          'border': '0'
        });
      }, 1000)*/
    });
    </script>

  </body>
</html>