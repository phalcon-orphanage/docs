<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Caching in the ORM &mdash; documentación de Phalcon - 3.1.1 (Spanish / Español)</title>
    <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework">
    <link rel="stylesheet" type="text/css" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="//static.phalconphp.com/www/css/phalcon.min.css" />
    <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400' rel='stylesheet' type='text/css'>
    <link href="//fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />
    <!--
    EUROPE <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=latin-ext' rel='stylesheet' type='text/css'>
    GREEK <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=greek-ext' rel='stylesheet' type='text/css'>
    RUSSIA <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=cyrillic-ext,latin' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.1.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/docs.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="documentación de Phalcon - 3.1.1" href="../index.html" />
    <link rel="next" title="ODM (Object-Document Mapper)" href="odm.html" />
    <link rel="prev" title="Phalcon Query Language (PHQL)" href="phql.html" /> 
  </head>
  <body>

<header class="page-header">
    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-container">
                    <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                </button>
                <a class="navbar-brand phalcon-logo" href="/"><span itemprop="name" class="sr-only">Phalcon PHP</span></a>
            </div>

            <div class="collapse navbar-collapse navbar-right" id="main-menu-container">
                <ul class="nav navbar-nav main-menu">
                  <li class="first"><a href="//phalconphp.com/en/download" class="header-nav-link">Download</a></li>
                  <li><a href="//docs.phalconphp.com/en/latest/index.html" class="header-nav-link" target="_blank">Documentation</a></li>
                  <li><a href="//forum.phalconphp.com/" class="header-nav-link" target="_blank">Forum</a></li>
                  <li><a href="//blog.phalconphp.com/" class="header-nav-link" target="_blank">Blog</a></li>
                  <li><a href="//phalconist.com/" class="header-nav-link" target="_blank">Resources</a></li>
                  <li><a href="//phalconphp.com/en/about">About</a></li>
                  <li><div align="right">
                      <iframe src="https://ghbtns.com/github-btn.html?user=phalcon&amp;repo=cphalcon&amp;type=watch&amp;count=true&amp;size=large"
      allowtransparency="true" frameborder="0" scrolling="0" width="152px" height="30px"></iframe>
                    </div></li>
                </ul>
            </div>
        </div>
    </nav>
  </header>

<div class="heading">
    <div class="container">
        <div class="row">
            <h2>Documentation</h2>
        </div>
    </div>
</div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="odm.html" title="ODM (Object-Document Mapper)"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="phql.html" title="Phalcon Query Language (PHQL)"
             accesskey="P">anterior</a> |</li>
        <li><a href="//phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">documentación de Phalcon - 3.1.1</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="100%" align="center" cellpadding="0" cellspacing="0">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            <div>
            <div id="searchbox" style="">
                <!--<form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="search" name="q" size="25" placeholder="Search">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>-->
                <div style="width:200px;padding:10px">
                  <gcse:searchbox-only></gcse:searchbox-only>
                </div>
            </div>
            </div>
            <div style="padding:5px;padding-left:10px">
              <div id="carbonads-container">
                <div class="carbonad"><div id="azcarbon"></div>
                <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=phalconphpcom" id="_carbonads_js"></script>
                </div></div>
            </div>
            <h3><a href="../index.html">Tabla de Contenidos</a></h3>
            <ul>
<li><a class="reference internal" href="#">Caching in the ORM</a><ul>
<li><a class="reference internal" href="#caching-resultsets">Caching Resultsets</a></li>
<li><a class="reference internal" href="#forcing-cache">Forcing Cache</a></li>
<li><a class="reference internal" href="#caching-phql-queries">Caching PHQL Queries</a></li>
<li><a class="reference internal" href="#reusable-related-records">Reusable Related Records</a></li>
<li><a class="reference internal" href="#caching-related-records">Caching Related Records</a></li>
<li><a class="reference internal" href="#caching-related-records-recursively">Caching Related Records Recursively</a></li>
<li><a class="reference internal" href="#caching-based-on-conditions">Caching based on Conditions</a></li>
<li><a class="reference internal" href="#caching-of-phql-planning">Caching of PHQL planning</a></li>
</ul>
</li>
</ul>

            <h4>Tema anterior</h4>
            <p class="topless"><a href="phql.html" title="capítulo anterior">&lt; Phalcon Query Language (PHQL)</a></p>
            <h4>Próximo tema</h4>
            <p class="topless"><a href="odm.html" title="próximo capítulo">ODM (Object-Document Mapper) &gt;</a></p>
            <h3>Esta página</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/models-cache.txt" rel="nofollow">Mostrar el código</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body" >
                      
  <div class="section" id="caching-in-the-orm">
<h1>Caching in the ORM<a class="headerlink" href="#caching-in-the-orm" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Every application is different, we could have models whose data change frequently and others that rarely change.
Accessing database systems is often one of the most common bottlenecks in terms of performance. This is due to
the complex connection/communication processes that PHP must do in each request to obtain data from the database.
Therefore, if we want to achieve good performance we need to add some layers of caching where the
application requires it.</p>
<p>This chapter explains the possible points where it is possible to implement caching to improve performance.
The framework gives you the tools to implement the cache where you demand of it according to the architecture
of your application.</p>
<div class="section" id="caching-resultsets">
<h2>Caching Resultsets<a class="headerlink" href="#caching-resultsets" title="Enlazar permanentemente con este título">¶</a></h2>
<p>A well established technique to avoid continuously accessing to the database is to cache resultsets that don&#8217;t change
frequently using a system with faster access (usually memory).</p>
<p>When <a class="reference internal" href="../api/Phalcon_Mvc_Model.html"><em>Phalcon\Mvc\Model</em></a> requires a service to cache resultsets, it will
request it to the Dependency Injector Container with the convention name &#8220;modelsCache&#8221;.</p>
<p>As Phalcon provides a component to <a class="reference internal" href="cache.html"><em>cache</em></a> any kind of data, we&#8217;ll explain how to integrate it with Models.
First, you must register it as a service in the services container:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Cache\Frontend\Data</span> <span class="k">as</span> <span class="nx">FrontendData</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Cache\Backend\Memcache</span> <span class="k">as</span> <span class="nx">BackendMemcache</span><span class="p">;</span>

<span class="c1">// Set the models cache service</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span>
    <span class="s2">&quot;modelsCache&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Cache data for one day by default</span>
        <span class="nv">$frontCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FrontendData</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;lifetime&quot;</span> <span class="o">=&gt;</span> <span class="mi">86400</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">);</span>

        <span class="c1">// Memcached connection settings</span>
        <span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BackendMemcache</span><span class="p">(</span>
            <span class="nv">$frontCache</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;host&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
                <span class="s2">&quot;port&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;11211&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$cache</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>You have complete control in creating and customizing the cache before being used by registering the service
as an anonymous function. Once the cache setup is properly defined you could cache resultsets as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get products without caching</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">();</span>

<span class="c1">// Just cache the resultset. The cache will expire in 1 hour (3600 seconds)</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;cache&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;key&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;my-cache&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="c1">// Cache the resultset for only for 5 minutes</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;cache&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;key&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;my-cache&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lifetime&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="c1">// Use the &#39;cache&#39; service from the DI instead of &#39;modelsCache&#39;</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;cache&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;key&quot;</span>     <span class="o">=&gt;</span> <span class="s2">&quot;my-cache&quot;</span><span class="p">,</span>
            <span class="s2">&quot;service&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;cache&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Caching could be also applied to resultsets generated using relationships:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Query some post</span>
<span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">// Get comments related to a post, also cache it</span>
<span class="nv">$comments</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">getComments</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;cache&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;key&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;my-key&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="c1">// Get comments related to a post, setting lifetime</span>
<span class="nv">$comments</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">getComments</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;cache&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;key&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;my-key&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lifetime&quot;</span> <span class="o">=&gt;</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>When a cached resultset needs to be invalidated, you can simply delete it from the cache using the previously specified key.</p>
<p>Note that not all resultsets should be cached. Results that change very frequently should not be cached since they
are invalidated very quickly and caching in that case impacts performance. Additionally, large datasets that
do not change frequently could be cached, but that is a decision that the developer has to make based on the
available caching mechanism and whether the performance impact to simply retrieve that data in the
first place is acceptable.</p>
</div>
<div class="section" id="forcing-cache">
<h2>Forcing Cache<a class="headerlink" href="#forcing-cache" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Earlier we saw how <a class="reference internal" href="../api/Phalcon_Mvc_Model.html"><em>Phalcon\Mvc\Model</em></a> integrates with the caching component provided by the framework. To make a record/resultset
cacheable we pass the key &#8216;cache&#8217; in the array of parameters:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Cache the resultset for only for 5 minutes</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;cache&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;key&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;my-cache&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lifetime&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>This gives us the freedom to cache specific queries, however if we want to cache globally every query performed over the model,
we can override the <code class="code docutils literal"><span class="pre">find()/:code:`findFirst()</span></code> method to force every query to be cached:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Implement a method that returns a string key based</span>
<span class="sd">     * on the query parameters</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$uniqueKey</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$parameters</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_scalar</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$uniqueKey</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s2">&quot;:&quot;</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$uniqueKey</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s2">&quot;:[&quot;</span> <span class="o">.</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nv">$uniqueKey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Convert the parameters to an array</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$parameters</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$parameters</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="c1">// Check if a cache key wasn&#39;t passed</span>
        <span class="c1">// and create the cache parameters</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">[</span><span class="s2">&quot;cache&quot;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$parameters</span><span class="p">[</span><span class="s2">&quot;cache&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;key&quot;</span>      <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">),</span>
                <span class="s2">&quot;lifetime&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
            <span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Accessing the database is several times slower than calculating a cache key. You&#8217;re free to implement any
key generation strategy you find to better for your needs. Note that a good key avoids collisions as much as possible -
meaning that different keys should return unrelated records.</p>
<p>This gives you full control on how the cache should be implemented for each model. If this strategy is common to several models
you can create a base class for all of them:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CacheableModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ... Create a cache key based on the parameters</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ... Custom caching strategy</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ... Custom caching strategy</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then use this class as base class for each &#8216;Cacheable&#8217; model:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">CacheableModel</span>
<span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-phql-queries">
<h2>Caching PHQL Queries<a class="headerlink" href="#caching-phql-queries" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Regardless of the syntax we used to create them, all queries in the ORM are handled internally using PHQL.
This language gives you much more freedom to create all kinds of queries. Of course these queries can be cached:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$phql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM Cars WHERE name = :name:&quot;</span><span class="p">;</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;key&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;cars-by-name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lifetime&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="nv">$cars</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Audi&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="reusable-related-records">
<h2>Reusable Related Records<a class="headerlink" href="#reusable-related-records" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Some models may have relationships with other models. This allows us to easily check the records that relate to instances in memory:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get some invoice</span>
<span class="nv">$invoice</span> <span class="o">=</span> <span class="nx">Invoices</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">// Get the customer related to the invoice</span>
<span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span>

<span class="c1">// Print his/her name</span>
<span class="k">echo</span> <span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>This example is very simple, a customer is queried and can be used as required, for example, to show its name.
This also applies if we retrieve a set of invoices to show customers that correspond to these invoices:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get a set of invoices</span>
<span class="c1">// SELECT * FROM invoices;</span>
<span class="nv">$invoices</span> <span class="o">=</span> <span class="nx">Invoices</span><span class="o">::</span><span class="na">find</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$invoices</span> <span class="k">as</span> <span class="nv">$invoice</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Get the customer related to the invoice</span>
    <span class="c1">// SELECT * FROM customers WHERE id = ?;</span>
    <span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span>

    <span class="c1">// Print his/her name</span>
    <span class="k">echo</span> <span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A customer may have one or more bills so, in this example, the same customer record may be unnecessarily queried several times.
To avoid this, we could mark the relationship as reusable; by doing so, we tell the ORM to automatically reuse
the records from memory instead of re-querying them again and again:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span>
            <span class="s2">&quot;customers_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;reusable&quot;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that this type of cache works in memory only, this means that cached data are released when the request is terminated.</p>
</div>
<div class="section" id="caching-related-records">
<h2>Caching Related Records<a class="headerlink" href="#caching-related-records" title="Enlazar permanentemente con este título">¶</a></h2>
<p>When a related record is queried, the ORM internally builds the appropriate condition and gets the required records using <code class="code docutils literal"><span class="pre">find()</span></code>/<code class="code docutils literal"><span class="pre">findFirst()</span></code>
in the target model according to the following table:</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="66%" />
<col width="21%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Description</th>
<th class="head">Implicit Method</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Belongs-To</td>
<td>Returns a model instance of the related record directly</td>
<td><code class="code docutils literal"><span class="pre">findFirst()</span></code></td>
</tr>
<tr class="row-odd"><td>Has-One</td>
<td>Returns a model instance of the related record directly</td>
<td><code class="code docutils literal"><span class="pre">findFirst()</span></code></td>
</tr>
<tr class="row-even"><td>Has-Many</td>
<td>Returns a collection of model instances of the referenced model</td>
<td><code class="code docutils literal"><span class="pre">find()</span></code></td>
</tr>
</tbody>
</table>
<p>This means that when you get a related record you could intercept how the data is obtained by implementing the corresponding method:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get some invoice</span>
<span class="nv">$invoice</span> <span class="o">=</span> <span class="nx">Invoices</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">// Get the customer related to the invoice</span>
<span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span> <span class="c1">// Invoices::findFirst(&quot;...&quot;);</span>

<span class="c1">// Same as above</span>
<span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">getCustomer</span><span class="p">();</span> <span class="c1">// Invoices::findFirst(&quot;...&quot;);</span>
</pre></div>
</div>
<p>Accordingly, we could replace the <code class="code docutils literal"><span class="pre">findFirst()</span></code> method in the Invoices model and implement the cache we consider most appropriate:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ... Custom caching strategy</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-related-records-recursively">
<h2>Caching Related Records Recursively<a class="headerlink" href="#caching-related-records-recursively" title="Enlazar permanentemente con este título">¶</a></h2>
<p>In this scenario, we assume that every time we query a result we also retrieve their associated records.
If we store the records found together with their related entities perhaps we could reduce a bit the overhead required
to obtain all entities:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ... Create a cache key based on the parameters</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_getCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Returns data from a cache</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_setCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$results</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Stores data in the cache</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Create a unique key</span>
        <span class="nv">$key</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>

        <span class="c1">// Check if there are data in the cache</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_getCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>

        <span class="c1">// Valid data is an object</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_object</span><span class="p">(</span><span class="nv">$results</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$results</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$results</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nv">$invoices</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$invoices</span> <span class="k">as</span> <span class="nv">$invoice</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Query the related customer</span>
            <span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span>

            <span class="c1">// Assign it to the record</span>
            <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span> <span class="o">=</span> <span class="nv">$customer</span><span class="p">;</span>

            <span class="nv">$results</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Store the invoices in the cache + their customers</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">_setCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$results</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Add relations and initialize other stuff</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Getting the invoices from the cache already obtains the customer data in just one hit, reducing the overall overhead of the operation.
Note that this process can also be performed with PHQL following an alternative solution:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Add relations and initialize other stuff</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ... Create a cache key based on the parameters</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getInvoicesCustomers</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$params</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$phql</span> <span class="o">=</span> <span class="s2">&quot;SELECT Invoices.*, Customers.* FROM Invoices JOIN Customers WHERE &quot;</span> <span class="o">.</span> <span class="nv">$conditions</span><span class="p">;</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getModelsManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;key&quot;</span>      <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$params</span><span class="p">),</span>
                <span class="s2">&quot;lifetime&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-based-on-conditions">
<h2>Caching based on Conditions<a class="headerlink" href="#caching-based-on-conditions" title="Enlazar permanentemente con este título">¶</a></h2>
<p>In this scenario, the cache is implemented differently depending on the conditions received.
We might decide that the cache backend should be determined by the primary key:</p>
<table border="1" class="docutils">
<colgroup>
<col width="51%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Cache Backend</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1 - 10000</td>
<td>mongo1</td>
</tr>
<tr class="row-odd"><td>10000 - 20000</td>
<td>mongo2</td>
</tr>
<tr class="row-even"><td>&gt; 20000</td>
<td>mongo3</td>
</tr>
</tbody>
</table>
<p>The easiest way is adding a static method to the model that chooses the right cache to be used:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">queryCache</span><span class="p">(</span><span class="nv">$initial</span><span class="p">,</span> <span class="nv">$final</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$initial</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$final</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$service</span> <span class="o">=</span> <span class="s2">&quot;mongo1&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$initial</span> <span class="o">&gt;=</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="nv">$final</span> <span class="o">&lt;=</span> <span class="mi">20000</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$service</span> <span class="o">=</span> <span class="s2">&quot;mongo2&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$initial</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$service</span> <span class="o">=</span> <span class="s2">&quot;mongo3&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;id &gt;= &quot;</span> <span class="o">.</span> <span class="nv">$initial</span> <span class="o">.</span> <span class="s2">&quot; AND id &lt;= &quot;</span> <span class="o">.</span> <span class="nv">$final</span><span class="p">,</span>
                <span class="s2">&quot;cache&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s2">&quot;service&quot;</span> <span class="o">=&gt;</span> <span class="nv">$service</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This approach solves the problem, however, if we want to add other parameters such orders or conditions we would have to create
a more complicated method. Additionally, this method does not work if the data is obtained using related records or a <code class="code docutils literal"><span class="pre">find()</span></code>/<code class="code docutils literal"><span class="pre">findFirst()</span></code>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;id &lt; 1000&quot;</span><span class="p">);</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;id &gt; 100 AND type = &#39;A&#39;&quot;</span><span class="p">);</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;(id &gt; 100 AND type = &#39;A&#39;) AND id &lt; 2000&quot;</span><span class="p">);</span>

<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;(id &gt; ?0 AND type = &#39;A&#39;) AND id &lt; ?1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bind&quot;</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2000</span><span class="p">],</span>
        <span class="s2">&quot;order&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>To achieve this we need to intercept the intermediate representation (IR) generated by the PHQL parser and
thus customize the cache everything possible:</p>
<p>The first is create a custom builder, so we can generate a totally customized query:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model\Query\Builder</span> <span class="k">as</span> <span class="nx">QueryBuilder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomQueryBuilder</span> <span class="k">extends</span> <span class="nx">QueryBuilder</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getQuery</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomQuery</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getPhql</span><span class="p">());</span>

        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setDI</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDI</span><span class="p">());</span>

        <span class="k">return</span> <span class="nv">$query</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Instead of directly returning a <a class="reference internal" href="../api/Phalcon_Mvc_Model_Query.html"><em>Phalcon\Mvc\Model\Query</em></a>, our custom builder returns a CustomQuery instance,
this class looks like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model\Query</span> <span class="k">as</span> <span class="nx">ModelQuery</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomQuery</span> <span class="k">extends</span> <span class="nx">ModelQuery</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * The execute method is overridden</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">$params</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$types</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Parse the intermediate representation for the SELECT</span>
        <span class="nv">$ir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">();</span>

        <span class="c1">// Check if the query has conditions</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$ir</span><span class="p">[</span><span class="s2">&quot;where&quot;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// The fields in the conditions can have any order</span>
            <span class="c1">// We need to recursively check the conditions tree</span>
            <span class="c1">// to find the info we&#39;re looking for</span>
            <span class="nv">$visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomNodeVisitor</span><span class="p">();</span>

            <span class="c1">// Recursively visits the nodes</span>
            <span class="nv">$visitor</span><span class="o">-&gt;</span><span class="na">visit</span><span class="p">(</span><span class="nv">$ir</span><span class="p">[</span><span class="s2">&quot;where&quot;</span><span class="p">]);</span>

            <span class="nv">$initial</span> <span class="o">=</span> <span class="nv">$visitor</span><span class="o">-&gt;</span><span class="na">getInitial</span><span class="p">();</span>
            <span class="nv">$final</span>   <span class="o">=</span> <span class="nv">$visitor</span><span class="o">-&gt;</span><span class="na">getFinal</span><span class="p">();</span>

            <span class="c1">// Select the cache according to the range</span>
            <span class="c1">// ...</span>

            <span class="c1">// Check if the cache has data</span>
            <span class="c1">// ...</span>
        <span class="p">}</span>

        <span class="c1">// Execute the query</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_executeSelect</span><span class="p">(</span><span class="nv">$ir</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="nv">$types</span><span class="p">);</span>

        <span class="c1">// Cache the result</span>
        <span class="c1">// ...</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Implementing a helper (CustomNodeVisitor) that recursively checks the conditions looking for fields that
tell us the possible range to be used in the cache:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CustomNodeVisitor</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$_initial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$_final</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s2">&quot;binary-op&quot;</span><span class="o">:</span>
                <span class="nv">$left</span>  <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visit</span><span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]);</span>
                <span class="nv">$right</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visit</span><span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]);</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$left</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$right</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nv">$left</span> <span class="o">===</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_final</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_final</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s2">&quot;qualified&quot;</span><span class="o">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="s2">&quot;id&quot;</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s2">&quot;literal&quot;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$node</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">];</span>

            <span class="k">default</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getInitial</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFinal</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_final</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, we can replace the find method in the Robots model to use the custom classes we&#8217;ve created:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$parameters</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$parameters</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nv">$builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomQueryBuilder</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>

        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="nb">get_called_class</span><span class="p">());</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">[</span><span class="s2">&quot;bind&quot;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">[</span><span class="s2">&quot;bind&quot;</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-of-phql-planning">
<h2>Caching of PHQL planning<a class="headerlink" href="#caching-of-phql-planning" title="Enlazar permanentemente con este título">¶</a></h2>
<p>As well as most moderns database systems PHQL internally caches the execution plan,
if the same statement is executed several times PHQL reuses the previously generated plan
improving performance, for a developer to take better advantage of this is highly recommended
build all your SQL statements passing variable parameters as bound parameters:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$phql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM Store</span><span class="se">\R</span><span class="s2">obots WHERE id = &quot;</span> <span class="o">.</span> <span class="nv">$i</span><span class="p">;</span>

    <span class="nv">$robots</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above example, ten plans were generated increasing the memory usage and processing in the application.
Rewriting the code to take advantage of bound parameters reduces the processing by both ORM and database system:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$phql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM Store</span><span class="se">\R</span><span class="s2">obots WHERE id = ?0&quot;</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$robots</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span>
        <span class="nv">$phql</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="nv">$i</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Performance can be also improved reusing the PHQL query:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$phql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM Store</span><span class="se">\R</span><span class="s2">obots WHERE id = ?0&quot;</span><span class="p">;</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$robots</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span>
        <span class="nv">$phql</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="nv">$i</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Execution plans for queries involving <a class="reference external" href="http://en.wikipedia.org/wiki/Prepared_statement">prepared statements</a> are also cached by most database systems
reducing the overall execution time, also protecting your application against <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL Injections</a>.</p>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="odm.html" title="ODM (Object-Document Mapper)"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="phql.html" title="Phalcon Query Language (PHQL)"
             >anterior</a> |</li> 
      </ul>
    </div>

      <div class="prefooter">
  <div class="container">
      <div class="row">
          <div class="col-sm-3 text-right">
              <span>Follow along:</span>
          </div>
          <div class="col-sm-6 text-center">
              <a href="https://twitter.com/phalconphp" alt="Twitter" class="btn-social btn-social-twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i></a>
              <a href="https://www.facebook.com/pages/Phalcon-Framework/134230726685897" alt="Facebook" class="btn-social btn-social-facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i></a>
              <a href="https://plus.google.com/102376109340560896457" alt="Google+" class="btn-social btn-social-googleplus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i></a>
              <a href="https://github.com/phalcon/cphalcon" alt="Github" class="btn-social btn-social-github"><i class="fa fa-fw fa-github" aria-hidden="true"></i></a>
          </div>
          <div class="col-sm-3">
          </div>
      </div>
  </div>
</div>
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-sm-3">
                <h4>Download</h4>
                <ul>
                    <li><a href="https://phalconphp.com/download">Installing Phalcon PHP</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/index.html" class="header-nav-link" target="_blank">Documentation</a></li>
                    <li><a href="https://api.phalconphp.com">API</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/reference/tutorial.html">Tutorial</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/reference/tutorial.html#sample-applications">Sample Applications</a></li>
                </ul>
            </div>
            <div class="col-xs-4 col-sm-3">
                <h4>Community</h4>
                <ul>
                    <li><a href="https://forum.phalconphp.com/" class="header-nav-link" target="_blank">Forum</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon">GitHub</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon/issues">Issue Tracker</a></li>
                    <li><a href="https://stackoverflow.com/questions/tagged/phalcon">Stack Overflow</a></li>
                    <li><a href="https://phalconphp.com/en/testimonials">Testimonials</a></li>
                    <li><a href="https://builtwith.phalconphp.com/">Built with Phalcon</a></li>
                    <li><a href="https://store.phalconphp.com/">Store</a></li>
                </ul>
            </div>
            <div class="col-xs-4 col-sm-2">
                <h4>About</h4>
                <ul>
                    <li><a class="link-black" href="http://blog.phalconphp.com/">Blog</a></li>
                    <li><a href="https://phalconphp.com/en/about">About</a></li>
                    <li><a href="https://phalconphp.com/en/team">Team</a></li>
                    <li><a href="https://phalconphp.com/en/roadmap">Roadmap</a></li>
                    <li><a href="https://phalconphp.com/en/donate">Donate</a></li>
                    <li><a href="https://phalconphp.com/en/consulting">Consulting</a></li>
                    <li><a href="https://phalconphp.com/en/hosting">Hosting</a></li>
                </ul>
            </div>
            <div id="license-spaccer" class="visible-xs"></div>
            <div id="license-wrapper" class="col-xs-12 col-sm-4">
                <p class="license">
                    Phalcon is an open-source PHP framework <br />
                    built as a C-extension. It is available under the <br />
                    <a href="http://opensource.org/licenses/BSD-3-Clause" target="_blank">new BSD License</a>.
                </p>

                <div class="design">
                    <span>Website Designed by:</span>
                </div>
                <a class="license" href="http://loudertech.com/" target="_blank" title="">
                    <span>LouderTech SAS</span>
                </a>
            </div>
        </div>
    </div>
</footer>

    </div>
    <script type="text/javascript">
    $(window).on("load", function(){
      var cx = '009733439235723428699:lh9ltjgvdz8';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
    });
    </script>

  </body>
</html>