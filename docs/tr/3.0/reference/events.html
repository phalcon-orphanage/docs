<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Events Manager &mdash; Phalcon 3.1.1 documentation (English)</title>
    <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework">
    <link rel="stylesheet" type="text/css" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="//static.phalconphp.com/www/css/phalcon.min.css" />
    <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400' rel='stylesheet' type='text/css'>
    <link href="//fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />
    <!--
    EUROPE <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=latin-ext' rel='stylesheet' type='text/css'>
    GREEK <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=greek-ext' rel='stylesheet' type='text/css'>
    RUSSIA <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=cyrillic-ext,latin' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.1.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/docs.js"></script>
    <link rel="shortcut icon" href="https://static.phalconphp.com/www/images/favicon.ico"/>
    <link rel="top" title="Phalcon 3.1.1 documentation" href="../index.html" />
    <link rel="next" title="Request Environment" href="request.html" />
    <link rel="prev" title="Working with Namespaces" href="namespaces.html" /> 
  </head>
  <body>

<header class="page-header">
    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-container">
                    <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                </button>
                <a class="navbar-brand phalcon-logo" href="/"><span itemprop="name" class="sr-only">Phalcon PHP</span></a>
            </div>

            <div class="collapse navbar-collapse navbar-right" id="main-menu-container">
                <ul class="nav navbar-nav main-menu">
                  <li class="first"><a href="//phalconphp.com/en/download" class="header-nav-link">Download</a></li>
                  <li><a href="//docs.phalconphp.com/en/latest/index.html" class="header-nav-link" target="_blank">Documentation</a></li>
                  <li><a href="//forum.phalconphp.com/" class="header-nav-link" target="_blank">Forum</a></li>
                  <li><a href="//blog.phalconphp.com/" class="header-nav-link" target="_blank">Blog</a></li>
                  <li><a href="//phalconist.com/" class="header-nav-link" target="_blank">Resources</a></li>
                  <li><a href="//phalconphp.com/en/about">About</a></li>
                  <li><div align="right">
                      <iframe src="https://ghbtns.com/github-btn.html?user=phalcon&amp;repo=cphalcon&amp;type=watch&amp;count=true&amp;size=large"
      allowtransparency="true" frameborder="0" scrolling="0" width="152px" height="30px"></iframe>
                    </div></li>
                </ul>
            </div>
        </div>
    </nav>
  </header>

<div class="heading">
    <div class="container">
        <div class="row">
            <h2>Documentation</h2>
        </div>
    </div>
</div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="request.html" title="Request Environment"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="namespaces.html" title="Working with Namespaces"
             accesskey="P">previous</a> |</li>
        <li><a href="//phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon 3.1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="100%" align="center" cellpadding="0" cellspacing="0">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            <div>
            <div id="searchbox" style="">
                <!--<form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="search" name="q" size="25" placeholder="Search">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>-->
                <div style="width:200px;padding:10px">
                  <gcse:searchbox-only></gcse:searchbox-only>
                </div>
            </div>
            </div>
            <div style="padding:5px;padding-left:10px">
              <div id="carbonads-container">
                <div class="carbonad"><div id="azcarbon"></div>
                <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=phalconphpcom" id="_carbonads_js"></script>
                </div></div>
            </div>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Events Manager</a><ul>
<li><a class="reference internal" href="#naming-convention">Naming Convention</a></li>
<li><a class="reference internal" href="#usage-example">Usage Example</a></li>
<li><a class="reference internal" href="#creating-components-that-trigger-events">Creating components that trigger Events</a></li>
<li><a class="reference internal" href="#using-services-from-the-di">Using Services From The DI</a></li>
<li><a class="reference internal" href="#event-propagation-cancellation">Event Propagation/Cancellation</a></li>
<li><a class="reference internal" href="#listener-priorities">Listener Priorities</a></li>
<li><a class="reference internal" href="#collecting-responses">Collecting Responses</a></li>
<li><a class="reference internal" href="#implementing-your-own-eventsmanager">Implementing your own EventsManager</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="namespaces.html" title="previous chapter">&lt; Working with Namespaces</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="request.html" title="next chapter">Request Environment &gt;</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/events.txt" rel="nofollow">Show Source</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body" >
                      
  <div class="section" id="events-manager">
<h1>Events Manager<a class="headerlink" href="#events-manager" title="Permalink to this headline">¶</a></h1>
<p>The purpose of this component is to intercept the execution of most of the other components of the framework by creating &#8220;hook points&#8221;. These hook
points allow the developer to obtain status information, manipulate data or change the flow of execution during the process of a component.</p>
<div class="section" id="naming-convention">
<h2>Naming Convention<a class="headerlink" href="#naming-convention" title="Permalink to this headline">¶</a></h2>
<p>Phalcon events use namespaces to avoid naming collisions. Each component in Phalcon occupies a different event namespace and you are free to create
your own as you see fit. Event names are formatted as &#8220;component:event&#8221;. For example, as <a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> occupies the &#8220;db&#8221;
namespace, its &#8220;afterQuery&#8221; event&#8217;s full name is &#8220;db:afterQuery&#8221;.</p>
<p>When attaching event listeners to the events manager, you can use &#8220;component&#8221; to catch all events from that component (eg. &#8220;db&#8221; to catch all of the
<a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> events) or &#8220;component:event&#8221; to target a specific event (eg. &#8220;db:afterQuery&#8221;).</p>
</div>
<div class="section" id="usage-example">
<h2>Usage Example<a class="headerlink" href="#usage-example" title="Permalink to this headline">¶</a></h2>
<p>In the following example, we will use the EventsManager to listen for the &#8220;afterQuery&#8221; event produced in a MySQL connection managed by
<a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Db\Adapter\Pdo\Mysql</span> <span class="k">as</span> <span class="nx">DbAdapter</span><span class="p">;</span>

<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;db:afterQuery&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DbAdapter</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;host&quot;</span>     <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;secret&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dbname&quot;</span>   <span class="o">=&gt;</span> <span class="s2">&quot;invo&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="c1">// Assign the eventsManager to the db adapter instance</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

<span class="c1">// Send a SQL command to the database server</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span>
    <span class="s2">&quot;SELECT * FROM products p WHERE p.status = 1&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Now every time a query is executed, the SQL statement will be echoed out. The first parameter passed to the lambda function contains contextual
information about the event that is running, the second is the source of the event (in this case: the connection itself). A third parameter may
also be specified which will contain arbitrary data specific to the event.</p>
<blockquote class="highlights">
<div>You must explicitly set the Events Manager to a component using the <code class="code docutils literal"><span class="pre">setEventsManager()</span></code> method in order for that component to trigger events. You can create a new Events Manager instance for each component or you can set the same Events Manager to multiple components as the naming convention will avoid conflicts.</div></blockquote>
<p>Instead of using lambda functions, you can use event listener classes instead. Event listeners also allow you to listen to multiple events. In
this example, we will implement the <a class="reference internal" href="../api/Phalcon_Db_Profiler.html"><em>Phalcon\Db\Profiler</em></a> to detect the SQL statements that are taking longer
to execute than expected:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Db\Profiler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Logger</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Logger\Adapter\File</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyDbListener</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$_profiler</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$_logger</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * Creates the profiler and starts the logging</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_profiler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Profiler</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_logger</span>   <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">(</span><span class="s2">&quot;../apps/logs/db.log&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * This is executed if the event triggered is &#39;beforeQuery&#39;</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeQuery</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_profiler</span><span class="o">-&gt;</span><span class="na">startProfile</span><span class="p">(</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * This is executed if the event triggered is &#39;afterQuery&#39;</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">afterQuery</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_logger</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">(),</span>
            <span class="nx">Logger</span><span class="o">::</span><span class="na">INFO</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_profiler</span><span class="o">-&gt;</span><span class="na">stopProfile</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getProfiler</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_profiler</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Attaching an event listener to the events manager is as simple as:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Create a database listener</span>
<span class="nv">$dbListener</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyDbListener</span><span class="p">();</span>

<span class="c1">// Listen all the database events</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;db&quot;</span><span class="p">,</span>
    <span class="nv">$dbListener</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The resulting profile data can be obtained from the listener:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Send a SQL command to the database server</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span>
    <span class="s2">&quot;SELECT * FROM products p WHERE p.status = 1&quot;</span>
<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$dbListener</span><span class="o">-&gt;</span><span class="na">getProfiler</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getProfiles</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$profile</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;SQL Statement: &quot;</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;Start Time: &quot;</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getInitialTime</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;Final Time: &quot;</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getFinalTime</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;Total Elapsed Time: &quot;</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getTotalElapsedSeconds</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-components-that-trigger-events">
<h2>Creating components that trigger Events<a class="headerlink" href="#creating-components-that-trigger-events" title="Permalink to this headline">¶</a></h2>
<p>You can create components in your application that trigger events to an EventsManager. As a consequence, there may exist listeners
that react to these events when generated. In the following example we&#8217;re creating a component called &#8220;MyComponent&#8221;.
This component is EventsManager aware (it implements <a class="reference internal" href="../api/Phalcon_Events_EventsAwareInterface.html"><em>Phalcon\Events\EventsAwareInterface</em></a>); when its <code class="code docutils literal"><span class="pre">someTask()</span></code> method is executed it triggers two events to any listener in the EventsManager:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\ManagerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\EventsAwareInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyComponent</span> <span class="k">implements</span> <span class="nx">EventsAwareInterface</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$_eventsManager</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setEventsManager</span><span class="p">(</span><span class="nx">ManagerInterface</span> <span class="nv">$eventsManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_eventsManager</span> <span class="o">=</span> <span class="nv">$eventsManager</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getEventsManager</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_eventsManager</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someTask</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_eventsManager</span><span class="o">-&gt;</span><span class="na">fire</span><span class="p">(</span><span class="s2">&quot;my-component:beforeSomeTask&quot;</span><span class="p">,</span> <span class="nv">$this</span><span class="p">);</span>

        <span class="c1">// Do some task</span>
        <span class="k">echo</span> <span class="s2">&quot;Here, someTask</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_eventsManager</span><span class="o">-&gt;</span><span class="na">fire</span><span class="p">(</span><span class="s2">&quot;my-component:afterSomeTask&quot;</span><span class="p">,</span> <span class="nv">$this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that in this example, we&#8217;re using the &#8220;my-component&#8221; event namespace. Now we need to create an event listener for this component:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeListener</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSomeTask</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$myComponent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Here, beforeSomeTask</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">afterSomeTask</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$myComponent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Here, afterSomeTask</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now let&#8217;s make everything work together:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">;</span>

<span class="c1">// Create an Events Manager</span>
<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="c1">// Create the MyComponent instance</span>
<span class="nv">$myComponent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyComponent</span><span class="p">();</span>

<span class="c1">// Bind the eventsManager to the instance</span>
<span class="nv">$myComponent</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

<span class="c1">// Attach the listener to the EventsManager</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;my-component&quot;</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">SomeListener</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">// Execute methods in the component</span>
<span class="nv">$myComponent</span><span class="o">-&gt;</span><span class="na">someTask</span><span class="p">();</span>
</pre></div>
</div>
<p>As <code class="code docutils literal"><span class="pre">someTask()</span></code> is executed, the two methods in the listener will be executed, producing the following output:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">Here, beforeSomeTask</span>
<span class="x">Here, someTask</span>
<span class="x">Here, afterSomeTask</span>
</pre></div>
</div>
<p>Additional data may also be passed when triggering an event using the third parameter of <code class="code docutils literal"><span class="pre">fire()</span></code>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">fire</span><span class="p">(</span><span class="s2">&quot;my-component:afterSomeTask&quot;</span><span class="p">,</span> <span class="nv">$this</span><span class="p">,</span> <span class="nv">$extraData</span><span class="p">);</span>
</pre></div>
</div>
<p>In a listener the third parameter also receives this data:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>

<span class="c1">// Receiving the data in the third parameter</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;my-component&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$component</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">print_r</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Receiving the data from the event context</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;my-component&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$component</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">print_r</span><span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="using-services-from-the-di">
<h2>Using Services From The DI<a class="headerlink" href="#using-services-from-the-di" title="Permalink to this headline">¶</a></h2>
<p>By extending <a class="reference internal" href="../api/Phalcon_Mvc_User_Plugin.html"><em>Phalcon\Mvc\User\Plugin</em></a>, you can access services from the DI, just like you would in a controller:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeListener</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSomeTask</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$myComponent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Here, beforeSomeTask</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">debug</span><span class="p">(</span>
            <span class="s2">&quot;beforeSomeTask has been triggered&quot;</span><span class="p">;</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">afterSomeTask</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$myComponent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Here, afterSomeTask</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">debug</span><span class="p">(</span>
            <span class="s2">&quot;afterSomeTask has been triggered&quot;</span><span class="p">;</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="event-propagation-cancellation">
<h2>Event Propagation/Cancellation<a class="headerlink" href="#event-propagation-cancellation" title="Permalink to this headline">¶</a></h2>
<p>Many listeners may be added to the same event manager. This means that for the same type of event, many listeners can be notified.
The listeners are notified in the order they were registered in the EventsManager. Some events are cancelable, indicating that
these may be stopped preventing other listeners from being notified about the event:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>

<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;db&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We stop the event if it is cancelable</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">isCancelable</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// Stop the event, so other listeners will not be notified about this</span>
            <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">stop</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>By default, events are cancelable - even most of the events produced by the framework are cancelables. You can fire a not-cancelable event
by passing <code class="code docutils literal"><span class="pre">false</span></code> in the fourth parameter of <code class="code docutils literal"><span class="pre">fire()</span></code>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">fire</span><span class="p">(</span><span class="s2">&quot;my-component:afterSomeTask&quot;</span><span class="p">,</span> <span class="nv">$this</span><span class="p">,</span> <span class="nv">$extraData</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="listener-priorities">
<h2>Listener Priorities<a class="headerlink" href="#listener-priorities" title="Permalink to this headline">¶</a></h2>
<p>When attaching listeners you can set a specific priority. With this feature you can attach listeners indicating the order
in which they must be called:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">enablePriorities</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">DbListener</span><span class="p">(),</span> <span class="mi">150</span><span class="p">);</span> <span class="c1">// More priority</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">DbListener</span><span class="p">(),</span> <span class="mi">100</span><span class="p">);</span> <span class="c1">// Normal priority</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">DbListener</span><span class="p">(),</span> <span class="mi">50</span><span class="p">);</span>  <span class="c1">// Less priority</span>
</pre></div>
</div>
</div>
<div class="section" id="collecting-responses">
<h2>Collecting Responses<a class="headerlink" href="#collecting-responses" title="Permalink to this headline">¶</a></h2>
<p>The events manager can collect every response returned by every notified listener. This example explains how it works:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">;</span>

<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="c1">// Set up the events manager to collect responses</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">collectResponses</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="c1">// Attach a listener</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;custom:custom&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;first response&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Attach a listener</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;custom:custom&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;second response&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Fire the event</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">fire</span><span class="p">(</span><span class="s2">&quot;custom:custom&quot;</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>

<span class="c1">// Get all the collected responses</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">getResponses</span><span class="p">());</span>
</pre></div>
</div>
<p>The above example produces:</p>
<div class="highlight-html"><div class="highlight"><pre>Array ( [0] =&gt; first response [1] =&gt; second response )
</pre></div>
</div>
</div>
<div class="section" id="implementing-your-own-eventsmanager">
<h2>Implementing your own EventsManager<a class="headerlink" href="#implementing-your-own-eventsmanager" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../api/Phalcon_Events_ManagerInterface.html"><em>Phalcon\Events\ManagerInterface</em></a> interface must be implemented to create your own
EventsManager replacing the one provided by Phalcon.</p>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="request.html" title="Request Environment"
             >next</a> |</li>
        <li class="right" >
          <a href="namespaces.html" title="Working with Namespaces"
             >previous</a> |</li> 
      </ul>
    </div>

      <div class="prefooter">
  <div class="container">
      <div class="row">
          <div class="col-sm-3 text-right">
              <span>Follow along:</span>
          </div>
          <div class="col-sm-6 text-center">
              <a href="https://twitter.com/phalconphp" alt="Twitter" class="btn-social btn-social-twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i></a>
              <a href="https://www.facebook.com/pages/Phalcon-Framework/134230726685897" alt="Facebook" class="btn-social btn-social-facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i></a>
              <a href="https://plus.google.com/102376109340560896457" alt="Google+" class="btn-social btn-social-googleplus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i></a>
              <a href="https://github.com/phalcon/cphalcon" alt="Github" class="btn-social btn-social-github"><i class="fa fa-fw fa-github" aria-hidden="true"></i></a>
          </div>
          <div class="col-sm-3">
          </div>
      </div>
  </div>
</div>

<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-sm-3">
                <h4>Download</h4>
                <ul>
                    <li><a href="https://phalconphp.com/download">Installing Phalcon PHP</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/index.html" class="header-nav-link" target="_blank">Documentation</a></li>
                    <li><a href="https://api.phalconphp.com">API</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/reference/tutorial.html">Tutorial</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/reference/tutorial.html#sample-applications">Sample Applications</a></li>
                </ul>
            </div>
            <div class="col-xs-4 col-sm-3">
                <h4>Community</h4>
                <ul>
                    <li><a href="https://forum.phalconphp.com/" class="header-nav-link" target="_blank">Forum</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon">GitHub</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon/issues">Issue Tracker</a></li>
                    <li><a href="https://stackoverflow.com/questions/tagged/phalcon">Stack Overflow</a></li>
                    <li><a href="https://phalconphp.com/en/testimonials">Testimonials</a></li>
                    <li><a href="https://builtwith.phalconphp.com/">Built with Phalcon</a></li>
                    <li><a href="https://store.phalconphp.com/">Store</a></li>
                </ul>
            </div>
            <div class="col-xs-4 col-sm-2">
                <h4>About</h4>
                <ul>
                    <li><a class="link-black" href="http://blog.phalconphp.com/">Blog</a></li>
                    <li><a href="https://phalconphp.com/en/about">About</a></li>
                    <li><a href="https://phalconphp.com/en/team">Team</a></li>
                    <li><a href="https://phalconphp.com/en/roadmap">Roadmap</a></li>
                    <li><a href="https://phalconphp.com/en/donate">Donate</a></li>
                    <li><a href="https://phalconphp.com/en/consulting">Consulting</a></li>
                    <li><a href="https://phalconphp.com/en/hosting">Hosting</a></li>
                </ul>
            </div>
            <div id="license-spaccer" class="visible-xs"></div>
            <div id="license-wrapper" class="col-xs-12 col-sm-4">
                <p class="license">
                    Phalcon is an open-source PHP framework <br />
                    built as a C-extension. It is available under the <br />
                    <a href="http://opensource.org/licenses/BSD-3-Clause" target="_blank">new BSD License</a>.
                </p>

                <div class="design">
                    <span>Website Designed by:</span>
                </div>
                <a class="license" href="http://loudertech.com/" target="_blank" title="">
                    <span>LouderTech SAS</span>
                </a>
            </div>
        </div>
    </div>
</footer>

    </div>
    <script type="text/javascript">
    $(window).on("load", function(){
      var cx = '009733439235723428699:lh9ltjgvdz8';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
    });
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.lazyload.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.magnific-popup.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/highlight.pack.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.ajaxchimp.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.backstretch.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/custom.js"></script>

  </body>
</html>