<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ODM (Object-Document Mapper) &mdash; Phalcon 3.1.1 documentation (English)</title>
    <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework">
    <link rel="stylesheet" type="text/css" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="//static.phalconphp.com/www/css/phalcon.min.css" />
    <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400' rel='stylesheet' type='text/css'>
    <link href="//fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />
    <!--
    EUROPE <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=latin-ext' rel='stylesheet' type='text/css'>
    GREEK <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=greek-ext' rel='stylesheet' type='text/css'>
    RUSSIA <link href='//fonts.googleapis.com/css?family=Open+Sans:700,400&subset=cyrillic-ext,latin' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.1.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/docs.js"></script>
    <link rel="shortcut icon" href="https://static.phalconphp.com/www/images/favicon.ico"/>
    <link rel="top" title="Phalcon 3.1.1 documentation" href="../index.html" />
    <link rel="next" title="Using Views" href="views.html" />
    <link rel="prev" title="Caching in the ORM" href="models-cache.html" /> 
  </head>
  <body>

<header class="page-header">
    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-container">
                    <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                </button>
                <a class="navbar-brand phalcon-logo" href="/"><span itemprop="name" class="sr-only">Phalcon PHP</span></a>
            </div>

            <div class="collapse navbar-collapse navbar-right" id="main-menu-container">
                <ul class="nav navbar-nav main-menu">
                  <li class="first"><a href="//phalconphp.com/en/download" class="header-nav-link">Download</a></li>
                  <li><a href="//docs.phalconphp.com/en/latest/index.html" class="header-nav-link" target="_blank">Documentation</a></li>
                  <li><a href="//forum.phalconphp.com/" class="header-nav-link" target="_blank">Forum</a></li>
                  <li><a href="//blog.phalconphp.com/" class="header-nav-link" target="_blank">Blog</a></li>
                  <li><a href="//phalconist.com/" class="header-nav-link" target="_blank">Resources</a></li>
                  <li><a href="//phalconphp.com/en/about">About</a></li>
                  <li><div align="right">
                      <iframe src="https://ghbtns.com/github-btn.html?user=phalcon&amp;repo=cphalcon&amp;type=watch&amp;count=true&amp;size=large"
      allowtransparency="true" frameborder="0" scrolling="0" width="152px" height="30px"></iframe>
                    </div></li>
                </ul>
            </div>
        </div>
    </nav>
  </header>

<div class="heading">
    <div class="container">
        <div class="row">
            <h2>Documentation</h2>
        </div>
    </div>
</div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="views.html" title="Using Views"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="models-cache.html" title="Caching in the ORM"
             accesskey="P">previous</a> |</li>
        <li><a href="//phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon 3.1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="100%" align="center" cellpadding="0" cellspacing="0">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            <div>
            <div id="searchbox" style="">
                <!--<form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="search" name="q" size="25" placeholder="Search">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>-->
                <div style="width:200px;padding:10px">
                  <gcse:searchbox-only></gcse:searchbox-only>
                </div>
            </div>
            </div>
            <div style="padding:5px;padding-left:10px">
              <div id="carbonads-container">
                <div class="carbonad"><div id="azcarbon"></div>
                <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=phalconphpcom" id="_carbonads_js"></script>
                </div></div>
            </div>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">ODM (Object-Document Mapper)</a><ul>
<li><a class="reference internal" href="#creating-models">Creating Models</a></li>
<li><a class="reference internal" href="#understanding-documents-to-objects">Understanding Documents To Objects</a></li>
<li><a class="reference internal" href="#models-in-namespaces">Models in Namespaces</a></li>
<li><a class="reference internal" href="#setting-a-connection">Setting a Connection</a></li>
<li><a class="reference internal" href="#finding-documents">Finding Documents</a></li>
<li><a class="reference internal" href="#aggregations">Aggregations</a></li>
<li><a class="reference internal" href="#creating-updating-records">Creating Updating/Records</a><ul>
<li><a class="reference internal" href="#validation-messages">Validation Messages</a></li>
<li><a class="reference internal" href="#validation-events-and-events-manager">Validation Events and Events Manager</a></li>
<li><a class="reference internal" href="#implementing-a-business-rule">Implementing a Business Rule</a></li>
<li><a class="reference internal" href="#validating-data-integrity">Validating Data Integrity</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deleting-records">Deleting Records</a></li>
<li><a class="reference internal" href="#validation-failed-events">Validation Failed Events</a></li>
<li><a class="reference internal" href="#implicit-ids-vs-user-primary-keys">Implicit Ids vs. User Primary Keys</a></li>
<li><a class="reference internal" href="#setting-multiple-databases">Setting multiple databases</a></li>
<li><a class="reference internal" href="#injecting-services-into-models">Injecting services into Models</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="models-cache.html" title="previous chapter">&lt; Caching in the ORM</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="views.html" title="next chapter">Using Views &gt;</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/odm.txt" rel="nofollow">Show Source</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body" >
                      
  <div class="section" id="odm-object-document-mapper">
<h1>ODM (Object-Document Mapper)<a class="headerlink" href="#odm-object-document-mapper" title="Permalink to this headline">¶</a></h1>
<p>In addition to its ability to <a class="reference internal" href="models.html"><em>map tables</em></a> in relational databases, Phalcon can map documents from NoSQL databases.
The ODM offers a CRUD functionality, events, validations among other services.</p>
<p>Due to the absence of SQL queries and planners, NoSQL databases can see real improvements in performance using the Phalcon approach.
Additionally, there are no SQL building reducing the possibility of SQL injections.</p>
<p>The following NoSQL databases are supported:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference external" href="http://www.mongodb.org/">MongoDB</a></td>
<td>MongoDB is a scalable, high-performance, open source NoSQL database.</td>
</tr>
</tbody>
</table>
<div class="section" id="creating-models">
<h2>Creating Models<a class="headerlink" href="#creating-models" title="Permalink to this headline">¶</a></h2>
<p>A model is a class that extends from <a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a>. It must be placed in the models directory. A model
file must contain a single class; its class name should be in camel case notation:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
<blockquote class="highlights">
<div>If you&#8217;re using PHP 5.4/5.5 is recommended declare each column that makes part of the model in order to save
memory and reduce the memory allocation.</div></blockquote>
<p>By default model &#8220;Robots&#8221; will refer to the collection &#8220;robots&#8221;. If you want to manually specify another name for the mapping collection,
you can use the <code class="code docutils literal"><span class="pre">setSource()</span></code> method:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setSource</span><span class="p">(</span><span class="s2">&quot;the_robots&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="understanding-documents-to-objects">
<h2>Understanding Documents To Objects<a class="headerlink" href="#understanding-documents-to-objects" title="Permalink to this headline">¶</a></h2>
<p>Every instance of a model represents a document in the collection. You can easily access collection data by reading object properties. For example,
for a collection &#8220;robots&#8221; with the documents:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mongo <span class="nb">test</span>
MongoDB shell version: 1.8.2
connecting to: <span class="nb">test</span>
&gt; db.robots.find<span class="o">()</span>
<span class="o">{</span> <span class="s2">&quot;_id&quot;</span> : ObjectId<span class="o">(</span><span class="s2">&quot;508735512d42b8c3d15ec4e1&quot;</span><span class="o">)</span>, <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;Astro Boy&quot;</span>, <span class="s2">&quot;year&quot;</span> : 1952,
    <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;mechanical&quot;</span> <span class="o">}</span>
<span class="o">{</span> <span class="s2">&quot;_id&quot;</span> : ObjectId<span class="o">(</span><span class="s2">&quot;5087358f2d42b8c3d15ec4e2&quot;</span><span class="o">)</span>, <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;Bender&quot;</span>, <span class="s2">&quot;year&quot;</span> : 1999,
    <span class="s2">&quot;type&quot;</span> : <span class="s2">&quot;mechanical&quot;</span> <span class="o">}</span>
<span class="o">{</span> <span class="s2">&quot;_id&quot;</span> : ObjectId<span class="o">(</span><span class="s2">&quot;508735d32d42b8c3d15ec4e3&quot;</span><span class="o">)</span>, <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;Wall-E&quot;</span>, <span class="s2">&quot;year&quot;</span> : <span class="m">2008</span> <span class="o">}</span>
&gt;
</pre></div>
</div>
</div>
<div class="section" id="models-in-namespaces">
<h2>Models in Namespaces<a class="headerlink" href="#models-in-namespaces" title="Permalink to this headline">¶</a></h2>
<p>Namespaces can be used to avoid class name collision. In this case it is necessary to indicate the name of the related collection using the <code class="code docutils literal"><span class="pre">setSource()</span></code> method:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Store\Toys</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setSource</span><span class="p">(</span><span class="s2">&quot;robots&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You could find a certain document by its ID and then print its name:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Find record with _id = &quot;5087358f2d42b8c3d15ec4e2&quot;</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findById</span><span class="p">(</span><span class="s2">&quot;5087358f2d42b8c3d15ec4e2&quot;</span><span class="p">);</span>

<span class="c1">// Prints &quot;Bender&quot;</span>
<span class="k">echo</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
</pre></div>
</div>
<p>Once the record is in memory, you can make modifications to its data and then save changes:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Astro Boy&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s2">&quot;Voltron&quot;</span><span class="p">;</span>

<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-a-connection">
<h2>Setting a Connection<a class="headerlink" href="#setting-a-connection" title="Permalink to this headline">¶</a></h2>
<p>Connections are retrieved from the services container. By default, Phalcon tries to find the connection in a service called &#8220;mongo&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Simple database connection to localhost</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span>
    <span class="s2">&quot;mongo&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nv">$mongo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$mongo</span><span class="o">-&gt;</span><span class="na">selectDB</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="k">true</span>
<span class="p">);</span>

<span class="c1">// Connecting to a domain socket, falling back to localhost connection</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span>
    <span class="s2">&quot;mongo&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nv">$mongo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span>
            <span class="s2">&quot;mongodb:///tmp/mongodb-27017.sock,localhost:27017&quot;</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$mongo</span><span class="o">-&gt;</span><span class="na">selectDB</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="k">true</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="finding-documents">
<h2>Finding Documents<a class="headerlink" href="#finding-documents" title="Permalink to this headline">¶</a></h2>
<p>As <a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a> relies on the Mongo PHP extension you have the same facilities
to query documents and convert them transparently to model instances:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// How many robots are there?</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">();</span>
<span class="k">echo</span> <span class="s2">&quot;There are &quot;</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$robots</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">// How many mechanical robots are there?</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;mechanical&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">);</span>
<span class="k">echo</span> <span class="s2">&quot;There are &quot;</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$robots</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">// Get and print mechanical robots ordered by name upward</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;mechanical&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;sort&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$robots</span> <span class="k">as</span> <span class="nv">$robot</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Get first 100 mechanical robots ordered by name</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;mechanical&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;sort&quot;</span>  <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;limit&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$robots</span> <span class="k">as</span> <span class="nv">$robot</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You could also use the <code class="code docutils literal"><span class="pre">findFirst()</span></code> method to get only the first record matching the given criteria:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// What&#39;s the first robot in robots collection?</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>
<span class="k">echo</span> <span class="s2">&quot;The robot name is &quot;</span><span class="p">,</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">// What&#39;s the first mechanical robot in robots collection?</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;mechanical&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">);</span>
<span class="k">echo</span> <span class="s2">&quot;The first mechanical robot name is &quot;</span><span class="p">,</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Both <code class="code docutils literal"><span class="pre">find()</span></code> and <code class="code docutils literal"><span class="pre">findFirst()</span></code> methods accept an associative array specifying the search criteria:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// First robot where type = &quot;mechanical&quot; and year = &quot;1999&quot;</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;conditions&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;mechanical&quot;</span><span class="p">,</span>
            <span class="s2">&quot;year&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="c1">// All virtual robots ordered by name downward</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;conditions&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;virtual&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;sort&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The available query options are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="72%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="code docutils literal"><span class="pre">conditions</span></code></td>
<td>Search conditions for the find operation. Is used to extract only those records that fulfill a specified criterion. By default Phalcon_model assumes the first parameter are the conditions.</td>
<td><code class="code docutils literal"><span class="pre">&quot;conditions&quot;</span> <span class="pre">=&gt;</span> <span class="pre">array('$gt'</span> <span class="pre">=&gt;</span> <span class="pre">1990)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal"><span class="pre">fields</span></code></td>
<td>Returns specific columns instead of the full fields in the collection. When using this option an incomplete object is returned</td>
<td><code class="code docutils literal"><span class="pre">&quot;fields&quot;</span> <span class="pre">=&gt;</span> <span class="pre">array('name'</span> <span class="pre">=&gt;</span> <span class="pre">true)</span></code></td>
</tr>
<tr class="row-even"><td><code class="code docutils literal"><span class="pre">sort</span></code></td>
<td>It&#8217;s used to sort the resultset. Use one or more fields as each element in the array, 1 means ordering upwards, -1 downward</td>
<td><code class="code docutils literal"><span class="pre">&quot;sort&quot;</span> <span class="pre">=&gt;</span> <span class="pre">array(&quot;name&quot;</span> <span class="pre">=&gt;</span> <span class="pre">-1,</span> <span class="pre">&quot;status&quot;</span> <span class="pre">=&gt;</span> <span class="pre">1)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="code docutils literal"><span class="pre">limit</span></code></td>
<td>Limit the results of the query to results to certain range</td>
<td><code class="code docutils literal"><span class="pre">&quot;limit&quot;</span> <span class="pre">=&gt;</span> <span class="pre">10</span></code></td>
</tr>
<tr class="row-even"><td><code class="code docutils literal"><span class="pre">skip</span></code></td>
<td>Skips a number of results</td>
<td><code class="code docutils literal"><span class="pre">&quot;skip&quot;</span> <span class="pre">=&gt;</span> <span class="pre">50</span></code></td>
</tr>
</tbody>
</table>
<p>If you have experience with SQL databases, you may want to check the <a class="reference external" href="http://www.php.net/manual/en/mongo.sqltomongo.php">SQL to Mongo Mapping Chart</a>.</p>
</div>
<div class="section" id="aggregations">
<h2>Aggregations<a class="headerlink" href="#aggregations" title="Permalink to this headline">¶</a></h2>
<p>A model can return calculations using <a class="reference external" href="http://docs.mongodb.org/manual/applications/aggregation/">aggregation framework</a> provided by Mongo. The aggregated values are calculate without having to use MapReduce.
With this option is easy perform tasks such as totaling or averaging field values:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="nx">Article</span><span class="o">::</span><span class="na">aggregate</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;</span><span class="se">\$</span><span class="s2">project&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s2">&quot;category&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="s2">&quot;</span><span class="se">\$</span><span class="s2">group&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s2">&quot;_id&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s2">&quot;category&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="se">\$</span><span class="s2">category&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;id&quot;</span>  <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s2">&quot;</span><span class="se">\$</span><span class="s2">max&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="se">\$</span><span class="s2">_id&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">],</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-updating-records">
<h2>Creating Updating/Records<a class="headerlink" href="#creating-updating-records" title="Permalink to this headline">¶</a></h2>
<p>The <code class="code docutils literal"><span class="pre">Phalcon\Mvc\Collection::save()</span></code> method allows you to create/update documents according to whether they already exist in the collection
associated with a model. The <code class="code docutils literal"><span class="pre">save()</span></code> method is called internally by the create and update methods of <a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a>.</p>
<p>Also the method executes associated validators and events that are defined in the model:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$robot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Robots</span><span class="p">();</span>

<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">=</span> <span class="s2">&quot;mechanical&quot;</span><span class="p">;</span>
<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s2">&quot;Astro Boy&quot;</span><span class="p">;</span>
<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">year</span> <span class="o">=</span> <span class="mi">1952</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">()</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;Umh, We can&#39;t store robots right now: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

    <span class="nv">$messages</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="nv">$message</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;Great, a new robot was saved successfully!&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The &#8220;_id&#8221; property is automatically updated with the <a class="reference external" href="http://www.php.net/manual/en/class.mongoid.php">MongoId</a> object created by the driver:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;The generated id is: &quot;</span><span class="p">,</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="validation-messages">
<h3>Validation Messages<a class="headerlink" href="#validation-messages" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a> has a messaging subsystem that provides a flexible way to output or store the
validation messages generated during the insert/update processes.</p>
<p>Each message consists of an instance of the class <a class="reference internal" href="../api/Phalcon_Mvc_Model_Message.html"><em>Phalcon\Mvc\Model\Message</em></a>. The set of
messages generated can be retrieved with the method getMessages(). Each message provides extended information like the field name that
generated the message or the message type:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">()</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$messages</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Message: &quot;</span><span class="p">,</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
        <span class="k">echo</span> <span class="s2">&quot;Field: &quot;</span><span class="p">,</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">getField</span><span class="p">();</span>
        <span class="k">echo</span> <span class="s2">&quot;Type: &quot;</span><span class="p">,</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">getType</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="validation-events-and-events-manager">
<h3>Validation Events and Events Manager<a class="headerlink" href="#validation-events-and-events-manager" title="Permalink to this headline">¶</a></h3>
<p>Models allow you to implement events that will be thrown when performing an insert or update. They help define business rules for a
certain model. The following are the events supported by <a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a> and their order of execution:</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="18%" />
<col width="12%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Name</th>
<th class="head">Can stop operation?</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Inserting/Updating</td>
<td><code class="code docutils literal"><span class="pre">beforeValidation</span></code></td>
<td>YES</td>
<td>Is executed before the validation process and the final insert/update to the database</td>
</tr>
<tr class="row-odd"><td>Inserting</td>
<td><code class="code docutils literal"><span class="pre">beforeValidationOnCreate</span></code></td>
<td>YES</td>
<td>Is executed before the validation process only when an insertion operation is being made</td>
</tr>
<tr class="row-even"><td>Updating</td>
<td><code class="code docutils literal"><span class="pre">beforeValidationOnUpdate</span></code></td>
<td>YES</td>
<td>Is executed before the fields are validated for not nulls or foreign keys when an updating operation is being made</td>
</tr>
<tr class="row-odd"><td>Inserting/Updating</td>
<td><code class="code docutils literal"><span class="pre">onValidationFails</span></code></td>
<td>YES (already stopped)</td>
<td>Is executed before the validation process only when an insertion operation is being made</td>
</tr>
<tr class="row-even"><td>Inserting</td>
<td><code class="code docutils literal"><span class="pre">afterValidationOnCreate</span></code></td>
<td>YES</td>
<td>Is executed after the validation process when an insertion operation is being made</td>
</tr>
<tr class="row-odd"><td>Updating</td>
<td><code class="code docutils literal"><span class="pre">afterValidationOnUpdate</span></code></td>
<td>YES</td>
<td>Is executed after the validation process when an updating operation is being made</td>
</tr>
<tr class="row-even"><td>Inserting/Updating</td>
<td><code class="code docutils literal"><span class="pre">afterValidation</span></code></td>
<td>YES</td>
<td>Is executed after the validation process</td>
</tr>
<tr class="row-odd"><td>Inserting/Updating</td>
<td><code class="code docutils literal"><span class="pre">beforeSave</span></code></td>
<td>YES</td>
<td>Runs before the required operation over the database system</td>
</tr>
<tr class="row-even"><td>Updating</td>
<td><code class="code docutils literal"><span class="pre">beforeUpdate</span></code></td>
<td>YES</td>
<td>Runs before the required operation over the database system only when an updating operation is being made</td>
</tr>
<tr class="row-odd"><td>Inserting</td>
<td><code class="code docutils literal"><span class="pre">beforeCreate</span></code></td>
<td>YES</td>
<td>Runs before the required operation over the database system only when an inserting operation is being made</td>
</tr>
<tr class="row-even"><td>Updating</td>
<td><code class="code docutils literal"><span class="pre">afterUpdate</span></code></td>
<td>NO</td>
<td>Runs after the required operation over the database system only when an updating operation is being made</td>
</tr>
<tr class="row-odd"><td>Inserting</td>
<td><code class="code docutils literal"><span class="pre">afterCreate</span></code></td>
<td>NO</td>
<td>Runs after the required operation over the database system only when an inserting operation is being made</td>
</tr>
<tr class="row-even"><td>Inserting/Updating</td>
<td><code class="code docutils literal"><span class="pre">afterSave</span></code></td>
<td>NO</td>
<td>Runs after the required operation over the database system</td>
</tr>
</tbody>
</table>
<p>To make a model to react to an event, we must to implement a method with the same name of the event:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeValidationOnCreate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;This is executed before creating a Robot!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Events can be useful to assign values before performing an operation, for example:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Products</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeCreate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Set the creation date</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">created_at</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s2">&quot;Y-m-d H:i:s&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeUpdate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Set the modification date</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modified_in</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s2">&quot;Y-m-d H:i:s&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Additionally, this component is integrated with <a class="reference internal" href="events.html"><em>Phalcon\Events\Manager</em></a>, this means we can create
listeners that run when an event is triggered.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">;</span>

<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="c1">// Attach an anonymous function as a listener for &quot;model&quot; events</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
    <span class="s2">&quot;collection:beforeSave&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$robot</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">===</span> <span class="s2">&quot;Scooby Doo&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">&quot;Scooby Doo isn&#39;t a robot!&quot;</span><span class="p">;</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="nv">$robot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Robots</span><span class="p">();</span>

<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s2">&quot;Scooby Doo&quot;</span><span class="p">;</span>
<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">year</span> <span class="o">=</span> <span class="mi">1969</span><span class="p">;</span>

<span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</pre></div>
</div>
<p>In the example given above the EventsManager only acted as a bridge between an object and a listener (the anonymous function). If we want all
objects created in our application use the same EventsManager, then we need to assign this to the Models Manager:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection\Manager</span> <span class="k">as</span> <span class="nx">CollectionManager</span><span class="p">;</span>

<span class="c1">// Registering the collectionManager service</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span>
    <span class="s2">&quot;collectionManager&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

        <span class="c1">// Attach an anonymous function as a listener for &quot;model&quot; events</span>
        <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span>
            <span class="s2">&quot;collection:beforeSave&quot;</span><span class="p">,</span>
            <span class="k">function</span> <span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$model</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$model</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;Robots&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">===</span> <span class="s2">&quot;Scooby Doo&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">echo</span> <span class="s2">&quot;Scooby Doo isn&#39;t a robot!&quot;</span><span class="p">;</span>

                        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">);</span>

        <span class="c1">// Setting a default EventsManager</span>
        <span class="nv">$modelsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CollectionManager</span><span class="p">();</span>

        <span class="nv">$modelsManager</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$modelsManager</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="k">true</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="implementing-a-business-rule">
<h3>Implementing a Business Rule<a class="headerlink" href="#implementing-a-business-rule" title="Permalink to this headline">¶</a></h3>
<p>When an insert, update or delete is executed, the model verifies if there are any methods with the names of the events listed in the table above.</p>
<p>We recommend that validation methods are declared protected to prevent that business logic implementation from being exposed publicly.</p>
<p>The following example implements an event that validates the year cannot be smaller than 0 on update or insert:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSave</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">year</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">&quot;Year cannot be smaller than zero!&quot;</span><span class="p">;</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Some events return false as an indication to stop the current operation. If an event doesn&#8217;t return anything,
<a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a> will assume a true value.</p>
</div>
<div class="section" id="validating-data-integrity">
<h3>Validating Data Integrity<a class="headerlink" href="#validating-data-integrity" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a> provides several events to validate data and implement business rules. The special &#8220;validation&#8221;
event allows us to call built-in validators over the record. Phalcon exposes a few built-in validators that can be used at this stage of validation.</p>
<p>The following example shows how to use it:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Validation</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Validation\Validator\InclusionIn</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Validation\Validator\Numericality</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">validation</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Validation</span><span class="p">();</span>

        <span class="nv">$validation</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span>
            <span class="s2">&quot;type&quot;</span><span class="p">,</span>
            <span class="k">new</span> <span class="nx">InclusionIn</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Type must be: mechanical or virtual&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;domain&quot;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="s2">&quot;Mechanical&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Virtual&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">);</span>

        <span class="nv">$validation</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span>
            <span class="s2">&quot;price&quot;</span><span class="p">,</span>
            <span class="k">new</span> <span class="nx">Numericality</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Price must be numeric&quot;</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$validation</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example given above performs a validation using the built-in validator &#8220;InclusionIn&#8221;. It checks the value of the field &#8220;type&#8221; in a domain list. If
the value is not included in the method, then the validator will fail and return false.</p>
<blockquote class="highlights">
<div>For more information on validators, see the <a class="reference internal" href="validation.html"><em>Validation documentation</em></a>.</div></blockquote>
</div>
</div>
<div class="section" id="deleting-records">
<h2>Deleting Records<a class="headerlink" href="#deleting-records" title="Permalink to this headline">¶</a></h2>
<p>The <code class="code docutils literal"><span class="pre">Phalcon\Mvc\Collection::delete()</span></code> method allows you to delete a document. You can use it as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$robot</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">()</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Sorry, we can&#39;t delete the robot right now: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

        <span class="nv">$messages</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$message</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;The robot was deleted successfully!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also delete many documents by traversing a resultset with a <code class="code docutils literal"><span class="pre">foreach</span></code> loop:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;mechanical&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$robots</span> <span class="k">as</span> <span class="nv">$robot</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">()</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Sorry, we can&#39;t delete the robot right now: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

        <span class="nv">$messages</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$message</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;The robot was deleted successfully!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following events are available to define custom business rules that can be executed when a delete operation is performed:</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="23%" />
<col width="22%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Name</th>
<th class="head">Can stop operation?</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Deleting</td>
<td><code class="code docutils literal"><span class="pre">beforeDelete</span></code></td>
<td>YES</td>
<td>Runs before the delete operation is made</td>
</tr>
<tr class="row-odd"><td>Deleting</td>
<td><code class="code docutils literal"><span class="pre">afterDelete</span></code></td>
<td>NO</td>
<td>Runs after the delete operation was made</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="validation-failed-events">
<h2>Validation Failed Events<a class="headerlink" href="#validation-failed-events" title="Permalink to this headline">¶</a></h2>
<p>Another type of events is available when the data validation process finds any inconsistency:</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="22%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Name</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Insert or Update</td>
<td><code class="code docutils literal"><span class="pre">notSave</span></code></td>
<td>Triggered when the insert/update operation fails for any reason</td>
</tr>
<tr class="row-odd"><td>Insert, Delete or Update</td>
<td><code class="code docutils literal"><span class="pre">onValidationFails</span></code></td>
<td>Triggered when any data manipulation operation fails</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="implicit-ids-vs-user-primary-keys">
<h2>Implicit Ids vs. User Primary Keys<a class="headerlink" href="#implicit-ids-vs-user-primary-keys" title="Permalink to this headline">¶</a></h2>
<p>By default <a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a> assumes that the <code class="code docutils literal"><span class="pre">_id</span></code> attribute is automatically generated using <a class="reference external" href="http://www.php.net/manual/en/class.mongoid.php">MongoIds</a>.
If a model uses custom primary keys this behavior can be overridden:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">useImplicitObjectIds</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-multiple-databases">
<h2>Setting multiple databases<a class="headerlink" href="#setting-multiple-databases" title="Permalink to this headline">¶</a></h2>
<p>In Phalcon, all models can belong to the same database connection or have an individual one. Actually, when
<a class="reference internal" href="../api/Phalcon_Mvc_Collection.html"><em>Phalcon\Mvc\Collection</em></a> needs to connect to the database it requests the &#8220;mongo&#8221; service
in the application&#8217;s services container. You can overwrite this service setting it in the initialize method:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// This service returns a mongo database at 192.168.1.100</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span>
    <span class="s2">&quot;mongo1&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nv">$mongo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span>
            <span class="s2">&quot;mongodb://scott:nekhen@192.168.1.100&quot;</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$mongo</span><span class="o">-&gt;</span><span class="na">selectDB</span><span class="p">(</span><span class="s2">&quot;management&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="k">true</span>
<span class="p">);</span>

<span class="c1">// This service returns a mongo database at localhost</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span>
    <span class="s2">&quot;mongo2&quot;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nv">$mongo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span>
            <span class="s2">&quot;mongodb://localhost&quot;</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$mongo</span><span class="o">-&gt;</span><span class="na">selectDB</span><span class="p">(</span><span class="s2">&quot;invoicing&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="k">true</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Then, in the <code class="code docutils literal"><span class="pre">initialize()</span></code> method, we define the connection service for the model:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setConnectionService</span><span class="p">(</span><span class="s2">&quot;mongo1&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="injecting-services-into-models">
<h2>Injecting services into Models<a class="headerlink" href="#injecting-services-into-models" title="Permalink to this headline">¶</a></h2>
<p>You may be required to access the application services within a model, the following example explains how to do that:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Collection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Collection</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">notSave</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Obtain the flash service from the DI container</span>
        <span class="nv">$flash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDI</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getShared</span><span class="p">(</span><span class="s2">&quot;flash&quot;</span><span class="p">);</span>

        <span class="nv">$messages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">();</span>

        <span class="c1">// Show validation messages</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span>
                <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$message</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The &#8220;notSave&#8221; event is triggered whenever a &#8220;creating&#8221; or &#8220;updating&#8221; action fails. We&#8217;re flashing the validation messages
obtaining the &#8220;flash&#8221; service from the DI container. By doing this, we don&#8217;t have to print messages after each saving.</p>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="views.html" title="Using Views"
             >next</a> |</li>
        <li class="right" >
          <a href="models-cache.html" title="Caching in the ORM"
             >previous</a> |</li> 
      </ul>
    </div>

      <div class="prefooter">
  <div class="container">
      <div class="row">
          <div class="col-sm-3 text-right">
              <span>Follow along:</span>
          </div>
          <div class="col-sm-6 text-center">
              <a href="https://twitter.com/phalconphp" alt="Twitter" class="btn-social btn-social-twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i></a>
              <a href="https://www.facebook.com/pages/Phalcon-Framework/134230726685897" alt="Facebook" class="btn-social btn-social-facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i></a>
              <a href="https://plus.google.com/102376109340560896457" alt="Google+" class="btn-social btn-social-googleplus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i></a>
              <a href="https://github.com/phalcon/cphalcon" alt="Github" class="btn-social btn-social-github"><i class="fa fa-fw fa-github" aria-hidden="true"></i></a>
          </div>
          <div class="col-sm-3">
          </div>
      </div>
  </div>
</div>

<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-sm-3">
                <h4>Download</h4>
                <ul>
                    <li><a href="https://phalconphp.com/download">Installing Phalcon PHP</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/index.html" class="header-nav-link" target="_blank">Documentation</a></li>
                    <li><a href="https://api.phalconphp.com">API</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/reference/tutorial.html">Tutorial</a></li>
                    <li><a href="https://docs.phalconphp.com/en/latest/reference/tutorial.html#sample-applications">Sample Applications</a></li>
                </ul>
            </div>
            <div class="col-xs-4 col-sm-3">
                <h4>Community</h4>
                <ul>
                    <li><a href="https://forum.phalconphp.com/" class="header-nav-link" target="_blank">Forum</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon">GitHub</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon/issues">Issue Tracker</a></li>
                    <li><a href="https://stackoverflow.com/questions/tagged/phalcon">Stack Overflow</a></li>
                    <li><a href="https://phalconphp.com/en/testimonials">Testimonials</a></li>
                    <li><a href="https://builtwith.phalconphp.com/">Built with Phalcon</a></li>
                    <li><a href="https://store.phalconphp.com/">Store</a></li>
                </ul>
            </div>
            <div class="col-xs-4 col-sm-2">
                <h4>About</h4>
                <ul>
                    <li><a class="link-black" href="http://blog.phalconphp.com/">Blog</a></li>
                    <li><a href="https://phalconphp.com/en/about">About</a></li>
                    <li><a href="https://phalconphp.com/en/team">Team</a></li>
                    <li><a href="https://phalconphp.com/en/roadmap">Roadmap</a></li>
                    <li><a href="https://phalconphp.com/en/donate">Donate</a></li>
                    <li><a href="https://phalconphp.com/en/consulting">Consulting</a></li>
                    <li><a href="https://phalconphp.com/en/hosting">Hosting</a></li>
                </ul>
            </div>
            <div id="license-spaccer" class="visible-xs"></div>
            <div id="license-wrapper" class="col-xs-12 col-sm-4">
                <p class="license">
                    Phalcon is an open-source PHP framework <br />
                    built as a C-extension. It is available under the <br />
                    <a href="http://opensource.org/licenses/BSD-3-Clause" target="_blank">new BSD License</a>.
                </p>

                <div class="design">
                    <span>Website Designed by:</span>
                </div>
                <a class="license" href="http://loudertech.com/" target="_blank" title="">
                    <span>LouderTech SAS</span>
                </a>
            </div>
        </div>
    </div>
</footer>

    </div>
    <script type="text/javascript">
    $(window).on("load", function(){
      var cx = '009733439235723428699:lh9ltjgvdz8';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
    });
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.lazyload.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.magnific-popup.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/highlight.pack.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.ajaxchimp.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/plugins/jquery.backstretch.min.js"></script>
    <script src="https://static.phalconphp.com/www/js/custom.js"></script>

  </body>
</html>