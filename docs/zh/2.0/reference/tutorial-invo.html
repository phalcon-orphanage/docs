
<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>教程 2：INVO 项目讲解（Tutorial 2: Explaining INVO） &mdash; Phalcon 1.3.0 documentation</title>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700,300italic,400italic,500italic&amp;subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/docs.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Phalcon 1.3.0 documentation" href="../index.html" />
    <link rel="next" title="教程 3：创建简单的 RESET API（Tutorial 3: Creating a Simple REST API）" href="tutorial-rest.html" />
    <link rel="prev" title="教程 1：让我们通过例子来学习（Tutorial 1: Let’s learn by example）" href="tutorial.html" /> 
  </head>
  <body>
    <div id="wrapper">

        <div class="size-wrap">

            <div class="header clear-fix">
                <a class="header-logo" href="http://phalconphp.com"><span class="logo-text">Phalcon</span></a>
                <div class="header-right">
                    <iframe src="http://ghbtns.com/github-btn.html?user=phalcon&amp;repo=cphalcon&amp;type=watch&amp;count=true&amp;size=large"
allowtransparency="true" frameborder="0" scrolling="0" width="152px" height="30px"></iframe>
                </div>
                <ul class="header-nav">
                    <li><a href="http://phalconphp.com/" class="header-nav-link">Home</a></li>
                    <li><a href="http://phalconphp.com/download" class="header-nav-link">Download</a></li>
                    <li><a href="http://forum.phalconphp.com/" class="header-nav-link active">Forum</a></li>
                    <li><a href="http://blog.phalconphp.com/" class="header-nav-link">Blog</a></li>
                    <li><a href="http://phalconphp.com/support" class="header-nav-link">Support</a></li>
                    <li><a href="http://store.phalconphp.com/" class="header-nav-link">Store</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon" class="header-nav-link">GitHub</a></li>
                </ul>
            </div>

        </div>
    <div class="header-line">
      <div class="size-wrap">
        <div class="header-line-title title-white">Documentation</div>
      </div>
    </div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="tutorial-rest.html" title="教程 3：创建简单的 RESET API（Tutorial 3: Creating a Simple REST API）"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="教程 1：让我们通过例子来学习（Tutorial 1: Let’s learn by example）"
             accesskey="P">上一页</a> |</li>
        <li><a href="http://phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon 1.3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="90%" align="center">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            <div>
            <div id="searchbox" style="">
                <!--<form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="search" name="q" size="25" placeholder="Search">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>-->
                <div style="width:200px;padding:10px">
                  <gcse:searchbox-only></gcse:searchbox-only>
                </div>
                <hr>
            </div>
            </div>
            <div style="padding:5px;padding-left:10px">
              <div id="carbonads-container">
                <div class="carbonad"><div id="azcarbon"></div>
                <script type="text/javascript">var z = document.createElement("script"); z.type = "text/javascript"; z.async = true; z.src = "http://engine.carbonads.com/z/56496/azcarbon_2_1_0_VERT"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(z, s);</script>
                </div></div>
            </div>
            <h3><a href="../index.html">內容目录</a></h3>
            <ul>
<li><a class="reference internal" href="#">教程 2：INVO 项目讲解（Tutorial 2: Explaining INVO）</a><ul>
<li><a class="reference internal" href="#project-structure">Project Structure</a></li>
<li><a class="reference internal" href="#routing">路由（Routing）</a></li>
<li><a class="reference internal" href="#configuration">配置（Configuration）</a></li>
<li><a class="reference internal" href="#autoloaders">自动加载（Autoloaders）</a></li>
<li><a class="reference internal" href="#handling-the-request">处理请求（Handling the Request）</a></li>
<li><a class="reference internal" href="#dependency-injection">依赖注入（Dependency Injection）</a></li>
<li><a class="reference internal" href="#log-into-the-application">登录应用（Log into the Application）</a></li>
<li><a class="reference internal" href="#securing-the-backend">保护后端（Securing the Backend）</a><ul>
<li><a class="reference internal" href="#events-management">事件管理（Events Management）</a></li>
<li><a class="reference internal" href="#acl-providing-an-acl-list">提供 ACL 列表（Providing an ACL list）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-components">用户组件（User Components）</a></li>
<li><a class="reference internal" href="#crud-working-with-the-crud">CRUD 的使用（Working with the CRUD）</a><ul>
<li><a class="reference internal" href="#the-search-form">搜索表单（The Search Form）</a></li>
<li><a class="reference internal" href="#performing-a-search">执行搜索（Performing a Search）</a></li>
<li><a class="reference internal" href="#creating-and-updating-records">创建和更新记录（Creating and Updating Records）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changing-the-title-dynamically">动态更改标题（Changing the Title Dynamically）</a></li>
<li><a class="reference internal" href="#conclusion">结束语（Conclusion）</a></li>
</ul>
</li>
</ul>

            <h4>上一个主题</h4>
            <p class="topless"><a href="tutorial.html" title="上一章">&lt; 教程 1：让我们通过例子来学习（Tutorial 1: Let&#8217;s learn by example）</a></p>
            <h4>下一个主题</h4>
            <p class="topless"><a href="tutorial-rest.html" title="下一章">教程 3：创建简单的 RESET API（Tutorial 3: Creating a Simple REST API） &gt;</a></p>
            <h3>本页</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/tutorial-invo.txt" rel="nofollow">显示源代码</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body" >
                      
  <div class="section" id="invo-tutorial-2-explaining-invo">
<h1>教程 2：INVO 项目讲解（Tutorial 2: Explaining INVO）<a class="headerlink" href="#invo-tutorial-2-explaining-invo" title="永久链接至标题">¶</a></h1>
<p>In this second tutorial, we&#8217;ll explain a more complete application in order to deepen the development with Phalcon.
INVO is one of the applications we have created as samples. INVO is a small website that allows their users to
generate invoices, and do other tasks such as manage their customers and products. You can clone its code from <a class="reference external" href="https://github.com/phalcon/invo">Github</a>.</p>
<p>Also, INVO was made with <a class="reference external" href="http://getbootstrap.com/">Bootstrap</a> as client-side framework. Although the application does not generate
invoices, it still serves as an example to understand how the framework works.</p>
<div class="section" id="project-structure">
<h2>Project Structure<a class="headerlink" href="#project-structure" title="永久链接至标题">¶</a></h2>
<p>Once you clone the project in your document root you&#8217;ll see the following structure:</p>
<div class="highlight-bash"><div class="highlight"><pre>invo/
    app/
        app/config/
        app/controllers/
        app/library/
        app/models/
        app/plugins/
        app/views/
    public/
        public/bootstrap/
        public/css/
        public/js/
    schemas/
</pre></div>
</div>
<p>As you know, Phalcon does not impose a particular file structure for application development. This project
provides a simple MVC structure and a public document root.</p>
<p>Once you open the application in your browser <a class="reference external" href="http://localhost/invo">http://localhost/invo</a> you&#8217;ll see something like this:</p>
<div class="figure align-center">
<img alt="../_images/invo-1.png" src="../_images/invo-1.png" />
</div>
<p>The application is divided into two parts, a frontend, that is a public part where visitors can receive information
about INVO and request contact information. The second part is the backend, an administrative area where a
registered user can manage his/her products and customers.</p>
</div>
<div class="section" id="routing">
<h2>路由（Routing）<a class="headerlink" href="#routing" title="永久链接至标题">¶</a></h2>
<p>INVO uses the standard route that is built-in with the Router component. These routes match the following
pattern: /:controller/:action/:params. This means that the first part of a URI is the controller, the second the
action and the rest are the parameters.</p>
<p>The following route /session/register executes the controller SessionController and its action registerAction.</p>
</div>
<div class="section" id="configuration">
<h2>配置（Configuration）<a class="headerlink" href="#configuration" title="永久链接至标题">¶</a></h2>
<p>INVO has a configuration file that sets general parameters in the application. This file is read in the first few lines
of the bootstrap file (public/index.php):</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Read the configuration</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Config\Adapter\Ini</span><span class="p">(</span><span class="s1">&#39;../app/config/config.ini&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference internal" href="config.html"><em>Phalcon\Config</em></a> allows us to manipulate the file in an object-oriented way. The configuration file
contains the following settings:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[database]</span>
<span class="na">host</span>     <span class="o">=</span> <span class="s">localhost</span>
<span class="na">username</span> <span class="o">=</span> <span class="s">root</span>
<span class="na">password</span> <span class="o">=</span> <span class="s">secret</span>
<span class="na">name</span>     <span class="o">=</span> <span class="s">invo</span>

<span class="k">[application]</span>
<span class="na">controllersDir</span> <span class="o">=</span> <span class="s">/../app/controllers/</span>
<span class="na">modelsDir</span>      <span class="o">=</span> <span class="s">/../app/models/</span>
<span class="na">viewsDir</span>       <span class="o">=</span> <span class="s">/../app/views/</span>
<span class="na">pluginsDir</span>     <span class="o">=</span> <span class="s">/../app/plugins/</span>
<span class="na">libraryDir</span>     <span class="o">=</span> <span class="s">/../app/library/</span>
<span class="na">baseUri</span>        <span class="o">=</span> <span class="s">/invo/</span>

<span class="c1">;[metadata]</span>
<span class="c1">;adapter = &quot;Apc&quot;</span>
<span class="c1">;suffix = my-suffix</span>
<span class="c1">;lifetime = 3600</span>
</pre></div>
</div>
<p>Phalcon hasn&#8217;t any pre-defined convention settings. Sections help us to organize the options as appropriate. In this file
there are three sections to be used later.</p>
</div>
<div class="section" id="autoloaders">
<h2>自动加载（Autoloaders）<a class="headerlink" href="#autoloaders" title="永久链接至标题">¶</a></h2>
<p>The second part that appears in the bootstrap file (public/index.php) is the autoloader. The autoloader registers a set
of directories in which the application will look for the classes that it eventually will need.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Loader</span><span class="p">();</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">registerDirs</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">controllersDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">pluginsDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">libraryDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">modelsDir</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
</pre></div>
</div>
<p>Note that the above code has registered the directories that were defined in the configuration file. The only
directory that is not registered is the viewsDir, because it contains HTML + PHP files but no classes.</p>
</div>
<div class="section" id="handling-the-request">
<h2>处理请求（Handling the Request）<a class="headerlink" href="#handling-the-request" title="永久链接至标题">¶</a></h2>
<p>If we skip to the end of the file, the request is finally handled by Phalcon\Mvc\Application
which initializes and executes all that is necessary to make the application run:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Mvc\Application</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

<span class="k">echo</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="dependency-injection">
<h2>依赖注入（Dependency Injection）<a class="headerlink" href="#dependency-injection" title="永久链接至标题">¶</a></h2>
<p>Look at the first line of the code block above, the Application class constructor is receiving the variable $di as an argument.
What is the purpose of that variable? Phalcon is a highly decoupled framework, so we need a component that acts as glue
to make everything work together. That component is Phalcon\DI. It is a service container that also performs
dependency injection, instantiating all components as they are needed by the application.</p>
<p>There are many ways of registering services in the container. In INVO, most services have been registered using
anonymous functions. Thanks to this, the objects are instantiated in a lazy way, reducing the resources needed
by the application.</p>
<p>For instance, in the following excerpt the session service is registered. The anonymous function will only be
called when the application requires access to the session data:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Start the session the first time a component requests the session service</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Session\Adapter\Files</span><span class="p">();</span>
    <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$session</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Here, we have the freedom to change the adapter, perform additional initialization and much more. Note that the service
was registered using the name &#8220;session&#8221;. This is a convention that will allow the framework to identify the active
service in the services container.</p>
<p>A request can use many services and registering each service individually can be a cumbersome task. For that reason,
the framework provides a variant of Phalcon\DI called Phalcon\DI\FactoryDefault whose task is to register
all services providing a full-stack framework.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// The FactoryDefault Dependency Injector automatically registers the</span>
<span class="c1">// right services providing a full-stack framework</span>
<span class="nv">$di</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\DI\FactoryDefault</span><span class="p">();</span>
</pre></div>
</div>
<p>It registers the majority of services with components provided by the framework as standard. If we need to override
the definition of some service we could just set it again as we did above with &#8220;session&#8221;. This is the reason for the
existence of the variable $di.</p>
</div>
<div class="section" id="log-into-the-application">
<h2>登录应用（Log into the Application）<a class="headerlink" href="#log-into-the-application" title="永久链接至标题">¶</a></h2>
<p>A &#8220;log in&#8221; facility will allow us to work on backend controllers. The separation between backend controllers and frontend ones
is only logical. All controllers are located in the same directory (app/controllers/).</p>
<p>To enter the system, users must have a valid username and password. Users are stored in the table &#8220;users&#8221;
in the database &#8220;invo&#8221;.</p>
<p>Before we can start a session, we need to configure the connection to the database in the application. A service
called &#8220;db&#8221; is set up in the service container with the connection information. As with the autoloader, we are
again taking parameters from the configuration file in order to configure a service:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Database connection is created based on parameters defined in the configuration file</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Mysql</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">&quot;host&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">host</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">,</span>
        <span class="s2">&quot;dbname&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">name</span>
    <span class="p">));</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Here, we return an instance of the MySQL connection adapter. If needed, you could do extra actions such as adding a
logger, a profiler or change the adapter, setting it up as you want.</p>
<p>The following simple form (app/views/session/index.phtml) requests the login information. We&#8217;ve removed
some HTML code to make the example more concise:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">form</span><span class="p">(</span><span class="s1">&#39;session/start&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>Username/Email<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">textField</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;30&quot;</span><span class="p">))</span> <span class="cp">?&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">passwordField</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;30&quot;</span><span class="p">))</span> <span class="cp">?&gt;</span>

    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">submitButton</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>The SessionController::startAction function (app/controllers/SessionController.php) has the task of validating the
data entered in the form including checking for a valid user in the database:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">SessionController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">startAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>

            <span class="c1">//Receiving the variables sent by POST</span>
            <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">);</span>
            <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

            <span class="nv">$password</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

            <span class="c1">//Find the user in the database</span>
            <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Users</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;email = :email: AND password = :password: AND active = &#39;Y&#39;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bind&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$password</span><span class="p">)</span>
            <span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">!=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">&#39;Welcome &#39;</span> <span class="o">.</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>

                <span class="c1">//Forward to the &#39;invoices&#39; controller if the user is valid</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;invoices&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
                <span class="p">));</span>
            <span class="p">}</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">&#39;Wrong email/password&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//Forward to the login form again</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
        <span class="p">));</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>For simplicity, we have used &#8220;<a class="reference external" href="http://php.net/manual/en/function.sha1.php">sha1</a>&#8221; to store the password hashes in the database, however, this algorithm is
not recommended in real applications, use &#8220;<a class="reference internal" href="security.html"><em>bcrypt</em></a>&#8221; instead.</p>
<p>Note that multiple public attributes are accessed in the controller like: $this-&gt;flash, $this-&gt;request or $this-&gt;session.
These are services defined in the services container from earlier. When they&#8217;re accessed the first time, they are injected as part
of the controller.</p>
<p>These services are shared, which means that we are always accessing the same instance regardless of the place
where we invoke them.</p>
<p>For instance, here we invoke the &#8220;session&#8221; service and then we store the user identity in the variable &#8220;auth&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
<span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="securing-the-backend">
<h2>保护后端（Securing the Backend）<a class="headerlink" href="#securing-the-backend" title="永久链接至标题">¶</a></h2>
<p>The backend is a private area where only registered users have access. Therefore, it is necessary to check that only
registered users have access to these controllers. If you aren&#8217;t logged into the application and you try to access,
for example, the products controller (which is private) you will see a screen like this:</p>
<div class="figure align-center">
<img alt="../_images/invo-2.png" src="../_images/invo-2.png" />
</div>
<p>Every time someone attempts to access any controller/action, the application verifies that the current role (in session)
has access to it, otherwise it displays a message like the above and forwards the flow to the home page.</p>
<p>Now let&#8217;s find out how the application accomplishes this. The first thing to know is that there is a component called
<a class="reference internal" href="dispatching.html"><em>Dispatcher</em></a>. It is informed about the route found by the <a class="reference internal" href="routing.html"><em>Routing</em></a> component. Then,
it is responsible for loading the appropriate controller and execute the corresponding action method.</p>
<p>Normally, the framework creates the Dispatcher automatically. In our case, we want to perform a verification
before executing the required action, checking if the user has access to it or not. To achieve this, we have
replaced the component by creating a function in the bootstrap:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$di</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>We now have total control over the Dispatcher used in the application. Many components in the framework trigger
events that allow us to modify their internal flow of operation. As the Dependency Injector component acts as glue
for components, a new component called <a class="reference internal" href="events.html"><em>EventsManager</em></a> allows us to intercept the events produced
by a component, routing the events to listeners.</p>
<div class="section" id="events-management">
<h3>事件管理（Events Management）<a class="headerlink" href="#events-management" title="永久链接至标题">¶</a></h3>
<p>An <a class="reference internal" href="events.html"><em>EventsManager</em></a> allows us to attach listeners to a particular type of event. The type that
interests us now is &#8220;dispatch&#8221;. The following code filters all events produced by the Dispatcher:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$di</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//Obtain the standard eventsManager from the DI</span>
    <span class="nv">$eventsManager</span> <span class="o">=</span> <span class="nv">$di</span><span class="o">-&gt;</span><span class="na">getShared</span><span class="p">(</span><span class="s1">&#39;eventsManager&#39;</span><span class="p">);</span>

    <span class="c1">//Instantiate the Security plugin</span>
    <span class="nv">$security</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Security</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

    <span class="c1">//Listen for events produced in the dispatcher using the Security plugin</span>
    <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">&#39;dispatch&#39;</span><span class="p">,</span> <span class="nv">$security</span><span class="p">);</span>

    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">();</span>

    <span class="c1">//Bind the EventsManager to the Dispatcher</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The Security plugin is a class located at (app/plugins/Security.php). This class implements the method
&#8220;beforeDispatch&#8221;. This is the same name as one of the events produced in the Dispatcher:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">,</span>
        <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">,</span>
        <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">,</span>
        <span class="nx">Phalcon\Acl</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Security</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeDispatch</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The hook events always receive a first parameter that contains contextual information of the event produced ($event)
and a second one that is the object that produced the event itself ($dispatcher). It is not mandatory that
plugins extend the class Phalcon\Mvc\User\Plugin, but by doing this they gain easier access to the services
available in the application.</p>
<p>Now, we&#8217;re verifying the role in the current session, checking if the user has access using the ACL list.
If the user does not have access we redirect to the home screen as explained before:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">,</span>
        <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">,</span>
        <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">,</span>
        <span class="nx">Phalcon\Acl</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Security</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeExecuteRoute</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//Check whether the &quot;auth&quot; variable exists in session to define the active role</span>
        <span class="nv">$auth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$auth</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">&#39;Guests&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">&#39;Users&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Take the active controller/action from the dispatcher</span>
        <span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getControllerName</span><span class="p">();</span>
        <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">();</span>

        <span class="c1">//Obtain the ACL list</span>
        <span class="nv">$acl</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getAcl</span><span class="p">();</span>

        <span class="c1">//Check if the Role have access to the controller (resource)</span>
        <span class="nv">$allowed</span> <span class="o">=</span> <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">isAllowed</span><span class="p">(</span><span class="nv">$role</span><span class="p">,</span> <span class="nv">$controller</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$allowed</span> <span class="o">!=</span> <span class="nx">Acl</span><span class="o">::</span><span class="na">ALLOW</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//If he doesn&#39;t have access forward him to the index controller</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s2">&quot;You don&#39;t have access to this module&quot;</span><span class="p">);</span>
            <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
                <span class="p">)</span>
            <span class="p">);</span>

            <span class="c1">//Returning &quot;false&quot; we tell to the dispatcher to stop the current operation</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="acl-providing-an-acl-list">
<h3>提供 ACL 列表（Providing an ACL list）<a class="headerlink" href="#acl-providing-an-acl-list" title="永久链接至标题">¶</a></h3>
<p>In the above example we have obtained the ACL using the method $this-&gt;_getAcl(). This method is also
implemented in the Plugin. Now we are going to explain step-by-step how we built the access control list (ACL):</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Create the ACL</span>
<span class="nv">$acl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Adapter\Memory</span><span class="p">();</span>

<span class="c1">//The default action is DENY access</span>
<span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">setDefaultAction</span><span class="p">(</span><span class="nx">Phalcon\Acl</span><span class="o">::</span><span class="na">DENY</span><span class="p">);</span>

<span class="c1">//Register two roles, Users is registered users</span>
<span class="c1">//and guests are users without a defined identity</span>
<span class="nv">$roles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Role</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">),</span>
    <span class="s1">&#39;guests&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Role</span><span class="p">(</span><span class="s1">&#39;Guests&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addRole</span><span class="p">(</span><span class="nv">$role</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we define the resources for each area respectively. Controller names are resources and their actions are
accesses for the resources:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Private area resources (backend)</span>
<span class="nv">$privateResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;companies&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;products&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;producttypes&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;invoices&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Phalcon\Acl\Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//Public area resources (frontend)</span>
<span class="nv">$publicResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;index&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
  <span class="s1">&#39;about&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
  <span class="s1">&#39;session&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">),</span>
  <span class="s1">&#39;contact&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;send&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Phalcon\Acl\Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The ACL now have knowledge of the existing controllers and their related actions. Role &#8220;Users&#8221; has access to
all the resources of both frontend and backend. The role &#8220;Guests&#8221; only has access to the public area:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Grant access to public areas to both users and guests</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="nv">$role</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$resource</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Grant access to private area only to role Users</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$actions</span> <span class="k">as</span> <span class="nv">$action</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="nv">$resource</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Hooray!, the ACL is now complete.</p>
</div>
</div>
<div class="section" id="user-components">
<h2>用户组件（User Components）<a class="headerlink" href="#user-components" title="永久链接至标题">¶</a></h2>
<p>All the UI elements and visual style of the application has been achieved mostly through <a class="reference external" href="http://getbootstrap.com/">Bootstrap</a>.
Some elements, such as the navigation bar changes according to the state of the application. For example, in the
upper right corner, the link &#8220;Log in / Sign Up&#8221; changes to &#8220;Log out&#8221; if an user is logged into the application.</p>
<p>This part of the application is implemented in the component &#8220;Elements&#8221; (app/library/Elements.php).</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\User\Component</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Elements</span> <span class="k">extends</span> <span class="nx">Component</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMenu</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTabs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>This class extends the Phalcon\Mvc\User\Component, it is not imposed to extend a component with this class, but
it helps to get access more quickly to the application services. Now, we register this class in the services container:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Register an user component</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;elements&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Elements</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>
<p>As controllers, plugins or components within a view, this component also has access to the services registered
in the container and by just accessing an attribute with the same name as a previously registered service:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>INVO<span class="nt">&lt;/a&gt;</span>
            <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elements</span><span class="o">-&gt;</span><span class="na">getMenu</span><span class="p">()</span> <span class="cp">?&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">()</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;hr&gt;</span>
    <span class="nt">&lt;footer&gt;</span>
        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Company 2012<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>The important part is:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elements</span><span class="o">-&gt;</span><span class="na">getMenu</span><span class="p">()</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="crud-working-with-the-crud">
<h2>CRUD 的使用（Working with the CRUD）<a class="headerlink" href="#crud-working-with-the-crud" title="永久链接至标题">¶</a></h2>
<p>Most options that manipulate data (companies, products and types of products), were developed using a basic and
common <a class="reference external" href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> (Create, Read, Update and Delete). Each CRUD contains the following files:</p>
<div class="highlight-bash"><div class="highlight"><pre>invo/
    app/
        app/controllers/
            ProductsController.php
        app/models/
            Products.php
        app/views/
            products/
                edit.phtml
                index.phtml
                new.phtml
                search.phtml
</pre></div>
</div>
<p>Each controller has the following actions:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * The start action, it shows the &quot;search&quot; view</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Execute the &quot;search&quot; based on the criteria sent from the &quot;index&quot;</span>
<span class="sd">     * Returning a paginator for the results</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">searchAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Shows the view to create a &quot;new&quot; product</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">newAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Shows the view to &quot;edit&quot; an existing product</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Updates a product based on the data entered in the &quot;edit&quot; action</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Deletes an existing product</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">deleteAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="the-search-form">
<h3>搜索表单（The Search Form）<a class="headerlink" href="#the-search-form" title="永久链接至标题">¶</a></h3>
<p>Every CRUD starts with a search form. This form shows each field that has the table (products), allowing the user
creating a search criteria from any field. Table &#8220;products&#8221; has a relationship to the table &#8220;products_types&#8221;.
In this case, we previously queried the records in this table in order to facilitate the search by that field:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * The start action, it shows the &quot;search&quot; view</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">persistent</span><span class="o">-&gt;</span><span class="na">searchParams</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">productTypes</span> <span class="o">=</span> <span class="nx">ProductTypes</span><span class="o">::</span><span class="na">find</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All the &#8220;product types&#8221; are queried and passed to the view as a local variable &#8220;productTypes&#8221;. Then, in the view
(app/views/index.phtml) we show a &#8220;select&#8221; tag filled with those results:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;product_types_id&quot;</span><span class="nt">&gt;</span>Product Type<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span>
        <span class="nv">$productTypes</span><span class="p">,</span>
        <span class="s2">&quot;using&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="s2">&quot;useDummy&quot;</span> <span class="o">=&gt;</span> <span class="k">true</span>
    <span class="p">))</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>Note that $productTypes contains the data necessary to fill the SELECT tag using Phalcon\Tag::select. Once the form
is submitted, the action &#8220;search&#8221; is executed in the controller performing the search based on the data entered by
the user.</p>
</div>
<div class="section" id="performing-a-search">
<h3>执行搜索（Performing a Search）<a class="headerlink" href="#performing-a-search" title="永久链接至标题">¶</a></h3>
<p>The action &#8220;search&#8221; has a dual behavior. When accessed via POST, it performs a search based on the data sent from the
form. But when accessed via GET it moves the current page in the paginator. To differentiate one from another HTTP method,
we check it using the <a class="reference internal" href="request.html"><em>Request</em></a> component:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Execute the &quot;search&quot; based on the criteria sent from the &quot;index&quot;</span>
<span class="sd"> * Returning a paginator for the results</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">searchAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">//create the query conditions</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//paginate using the existing conditions</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>With the help of <a class="reference internal" href="../api/Phalcon_Mvc_Model_Criteria.html"><em>Phalcon\Mvc\Model\Criteria</em></a>, we can create the search
conditions intelligently based on the data types and values sent from the form:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nx">Criteria</span><span class="o">::</span><span class="na">fromInput</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">di</span><span class="p">,</span> <span class="s2">&quot;Products&quot;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span>
</pre></div>
</div>
<p>This method verifies which values are different from &#8220;&#8221; (empty string) and null and takes them into account to create
the search criteria:</p>
<ul class="simple">
<li>If the field data type is text or similar (char, varchar, text, etc.) It uses an SQL &#8220;like&#8221; operator to filter the results.</li>
<li>If the data type is not text or similar, it&#8217;ll use the operator &#8220;=&#8221;.</li>
</ul>
<p>Additionally, &#8220;Criteria&#8221; ignores all the $_POST variables that do not match any field in the table.
Values are automatically escaped using &#8220;bound parameters&#8221;.</p>
<p>Now, we store the produced parameters in the controller&#8217;s session bag:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">persistent</span><span class="o">-&gt;</span><span class="na">searchParams</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">();</span>
</pre></div>
</div>
<p>A session bag, is a special attribute in a controller that persists between requests. When accessed, this attribute injects
a <a class="reference internal" href="../api/Phalcon_Session_Bag.html"><em>Phalcon\Session\Bag</em></a> service that is independent in each controller.</p>
<p>Then, based on the built params we perform the query:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$products</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">notice</span><span class="p">(</span><span class="s2">&quot;The search did not found any products&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the search doesn&#8217;t return any product, we forward the user to the index action again. Let&#8217;s pretend the
search returned results, then we create a paginator to navigate easily through them:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$paginator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Paginator\Adapter\Model</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">&quot;data&quot;</span> <span class="o">=&gt;</span> <span class="nv">$products</span><span class="p">,</span>    <span class="c1">//Data to paginate</span>
    <span class="s2">&quot;limit&quot;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>           <span class="c1">//Rows per page</span>
    <span class="s2">&quot;page&quot;</span> <span class="o">=&gt;</span> <span class="nv">$numberPage</span>   <span class="c1">//Active page</span>
<span class="p">));</span>

<span class="c1">//Get active page in the paginator</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$paginator</span><span class="o">-&gt;</span><span class="na">getPaginate</span><span class="p">();</span>
</pre></div>
</div>
<p>Finally we pass the returned page to view:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">setVar</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="nv">$page</span><span class="p">);</span>
</pre></div>
</div>
<p>In the view (app/views/products/search.phtml), we traverse the results corresponding to the current page:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$page</span><span class="o">-&gt;</span><span class="na">items</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getProductTypes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">price</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">active</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">linkTo</span><span class="p">(</span><span class="s2">&quot;products/edit/&quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">linkTo</span><span class="p">(</span><span class="s2">&quot;products/delete/&quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;Delete&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-and-updating-records">
<h3>创建和更新记录（Creating and Updating Records）<a class="headerlink" href="#creating-and-updating-records" title="永久链接至标题">¶</a></h3>
<p>Now let&#8217;s see how the CRUD creates and updates records. From the &#8220;new&#8221; and &#8220;edit&#8221; views the data entered by the user
are sent to the actions &#8220;create&#8221; and &#8220;save&#8221; that perform actions of &#8220;creating&#8221; and &#8220;updating&#8221; products respectively.</p>
<p>In the creation case, we recover the data submitted and assign them to a new &#8220;products&#8221; instance:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="nv">$products</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Products</span><span class="p">();</span>

    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">product_types_id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;striptags&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">price</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">active</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Data is filtered before being assigned to the object. This filtering is optional, the ORM escapes the input data and
performs additional casting according to the column types.</p>
<p>When saving we&#8217;ll know whether the data conforms to the business rules and validations implemented in the model Products:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$products</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">())</span> <span class="p">{</span>

        <span class="c1">//The store failed, the following messages were produced</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$products</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">((</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$message</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/new&quot;</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s2">&quot;Product was created successfully&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Now, in the case of product updating, first we must present to the user the data that is currently in the edited record:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Shows the view to &quot;edit&quot; an existing product</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">findFirstById</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">product_types_id</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">price</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">active</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The &#8220;setDefault&#8221; helper sets a default value in the form on the attribute with the same name. Thanks to this,
the user can change any value and then sent it back to the database through to the &#8220;save&#8221; action:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Updates a product based on the data entered in the &quot;edit&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="c1">//Find the product to update</span>
    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">findFirstById</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s2">&quot;products does not exist &quot;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//... assign the values to the object and store it</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="changing-the-title-dynamically">
<h2>动态更改标题（Changing the Title Dynamically）<a class="headerlink" href="#changing-the-title-dynamically" title="永久链接至标题">¶</a></h2>
<p>When you browse between one option and another will see that the title changes dynamically indicating where
we are currently working. This is achieved in each controller initializer:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Set the document title</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="s1">&#39;Manage your product types&#39;</span><span class="p">);</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">initialize</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Note, that the method parent::initialize() is also called, it adds more data to the title:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ControllerBase</span> <span class="k">extends</span> <span class="nx">Phalcon\Mvc\Controller</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Prepend the application name to the title</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">prependTitle</span><span class="p">(</span><span class="s1">&#39;INVO | &#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, the title is printed in the main view (app/views/index.phtml):</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tag</span><span class="o">-&gt;</span><span class="na">getTitle</span><span class="p">()</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>结束语（Conclusion）<a class="headerlink" href="#conclusion" title="永久链接至标题">¶</a></h2>
<p>This tutorial covers many more aspects of building applications with Phalcon, hope you have served to
learn more and get more out of the framework.</p>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="tutorial-rest.html" title="教程 3：创建简单的 RESET API（Tutorial 3: Creating a Simple REST API）"
             >下一页</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="教程 1：让我们通过例子来学习（Tutorial 1: Let’s learn by example）"
             >上一页</a> |</li> 
      </ul>
    </div>
        <div id="footer">

          <p>Found a typo or an error? Want to improve this document? The documentation sources are available on <a href="http://github.com/phalcon/docs">Github</a></p>
          <p>Need support or have questions? Check our <a href="http://phalconphp.com/support">Support Page</a></p>

          <p>The Phalcon PHP Framework is released under the <a href="https://github.com/phalcon/cphalcon/blob/master/docs/LICENSE.md">new BSD license</a>.</p>
          <p>Except where otherwise noted, content on this site is licensed under the
            <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License.</a></p>
             最后更新日期是 Oct 21, 2014.
            使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.

          <p>
             &copy; 版权所有 2014, Phalcon Team and contributors.
          </p>

            <div class="size-wrap footer-wrap">

                <div class="donate-wrap">
                    Donate to Phalcon: <a href="http://flattr.com/thing/1134206/Phalcon-PHP-Framework" target="_blank" class="button button-small orange">Flattr</a>
                    or
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" style="display: inline">
                        <input type="hidden" name="cmd" value="_s-xclick">
                        <input type="hidden" name="hosted_button_id" value="7LSYMNMFZNG8W">
                        <input class="button button-small orange" style="border: inherit; display: inline; font-weight: bold" type="submit" value="via Paypal" title="PayPal — The safer, easier way to pay online.">
                    </form>
                </div>

                <div class="social-links">
                    <a href="https://twitter.com/phalconphp" class="social-link tw">Twitter</a>
                    <a href="http://www.facebook.com/pages/Phalcon/134230726685897" class="social-link fb">Facebook</a>
                    <a href="https://plus.google.com/102376109340560896457" class="social-link gp">Google Plus</a>
                    <a href="http://vimeo.com/user10964377" class="social-link vm">Vimeo</a>
                </div>

            </div>

        </div>

    </div>
    <script type="text/javascript">
    $(window).on("load", function(){
      var cx = '009733439235723428699:lh9ltjgvdz8';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
      /*window.setTimeout(function(){
        $('.gsc-search-button').css({
          'background': '#f06715',
          'padding': '2px',
          'border': '0'
        });
      }, 1000)*/
    });
    </script>

  </body>
</html>