
<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutoriel 2: Expliquer INVO &mdash; Phalcon 1.3.0 documentation</title>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700,300italic,400italic,500italic&amp;subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/docs.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Phalcon 1.3.0 documentation" href="../index.html" />
    <link rel="next" title="Tutorial 3: Créer une application REST API" href="tutorial-rest.html" />
    <link rel="prev" title="Tutorial 1: Let’s learn by example" href="tutorial.html" /> 
  </head>
  <body>
    <div id="wrapper">

        <div class="size-wrap">

            <div class="header clear-fix">
                <a class="header-logo" href="http://phalconphp.com"><span class="logo-text">Phalcon</span></a>
                <div class="header-right">
                    <iframe src="http://ghbtns.com/github-btn.html?user=phalcon&amp;repo=cphalcon&amp;type=watch&amp;count=true&amp;size=large"
allowtransparency="true" frameborder="0" scrolling="0" width="152px" height="30px"></iframe>
                </div>
                <ul class="header-nav">
                    <li><a href="http://phalconphp.com/" class="header-nav-link">Home</a></li>
                    <li><a href="http://phalconphp.com/download" class="header-nav-link">Download</a></li>
                    <li><a href="http://forum.phalconphp.com/" class="header-nav-link active">Forum</a></li>
                    <li><a href="http://blog.phalconphp.com/" class="header-nav-link">Blog</a></li>
                    <li><a href="http://phalconphp.com/support" class="header-nav-link">Support</a></li>
                    <li><a href="http://store.phalconphp.com/" class="header-nav-link">Store</a></li>
                    <li><a href="https://github.com/phalcon/cphalcon" class="header-nav-link">GitHub</a></li>
                </ul>
            </div>

        </div>
    <div class="header-line">
      <div class="size-wrap">
        <div class="header-line-title title-white">Documentation</div>
      </div>
    </div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Index général"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tutorial-rest.html" title="Tutorial 3: Créer une application REST API"
             accesskey="N">suivant</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial 1: Let’s learn by example"
             accesskey="P">précédent</a> |</li>
        <li><a href="http://phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon 1.3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="90%" align="center">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            <div>
            <div id="searchbox" style="">
                <!--<form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="search" name="q" size="25" placeholder="Search">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>-->
                <div style="width:200px;padding:10px">
                  <gcse:searchbox-only></gcse:searchbox-only>
                </div>
                <hr>
            </div>
            </div>
            <div style="padding:5px;padding-left:10px">
              <div id="carbonads-container">
                <div class="carbonad"><div id="azcarbon"></div>
                <script type="text/javascript">var z = document.createElement("script"); z.type = "text/javascript"; z.async = true; z.src = "http://engine.carbonads.com/z/56496/azcarbon_2_1_0_VERT"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(z, s);</script>
                </div></div>
            </div>
            <h3><a href="../index.html">Table des matières</a></h3>
            <ul>
<li><a class="reference internal" href="#">Tutoriel 2: Expliquer INVO</a><ul>
<li><a class="reference internal" href="#structure-du-projet">Structure du projet</a></li>
<li><a class="reference internal" href="#routage">Routage</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#autoloaders">Autoloaders</a></li>
<li><a class="reference internal" href="#gerer-la-requete">Gérer la requête</a></li>
<li><a class="reference internal" href="#injection-de-dependances">Injection de dépendances</a></li>
<li><a class="reference internal" href="#se-connecter-a-l-application">Se connecter à l&#8217;application</a></li>
<li><a class="reference internal" href="#securiser-le-backend">Sécuriser le Backend</a><ul>
<li><a class="reference internal" href="#gestion-des-evenements">Gestion des évènements</a></li>
<li><a class="reference internal" href="#fournir-une-liste-acl">Fournir une liste ACL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#composants-utilisateurs">Composants utilisateurs</a></li>
<li><a class="reference internal" href="#travailler-avec-le-crud">Travailler avec le CRUD</a><ul>
<li><a class="reference internal" href="#formulaire-de-recherche">Formulaire de recherche</a></li>
<li><a class="reference internal" href="#executer-une-recherche">Exécuter une recherche</a></li>
<li><a class="reference internal" href="#creer-et-modifier-des-entrees">Créer et modifier des entrées</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changer-le-titre-de-maniere-dynamique">Changer le titre de manière dynamique</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

            <h4>Sujet précédent</h4>
            <p class="topless"><a href="tutorial.html" title="Chapitre précédent">&lt; Tutorial 1: Let&#8217;s learn by example</a></p>
            <h4>Sujet suivant</h4>
            <p class="topless"><a href="tutorial-rest.html" title="Chapitre suivant">Tutorial 3: Créer une application REST API &gt;</a></p>
            <h3>Cette page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/tutorial-invo.txt" rel="nofollow">Montrer la source</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body" >
                      
  <div class="section" id="tutoriel-2-expliquer-invo">
<h1>Tutoriel 2: Expliquer INVO<a class="headerlink" href="#tutoriel-2-expliquer-invo" title="Lien permanent vers ce titre">¶</a></h1>
<p>Dans ce second tutoriel, nous allons expliquer une application plus complète de manière à approfondir le développement de Phalcon.
INVO est l&#8217;une des applications que nous avons créé en tant qu&#8217;exemples. INVO est un petit site web qui permet aux utilisateur de générer des factures et faire
d&#8217;autres tâches comme gérer ses clients et ses produits. Vous pouvez cloner son code à partir de <a class="reference external" href="https://github.com/phalcon/invo">Github</a>.</p>
<p>Aussi, INVO utilise <a class="reference external" href="http://twitter.github.io/bootstrap/">Twitter Bootstrap</a> comme framework côté client. Même si l&#8217;application ne génère pas de factures, cela donne un exemple pour comprendre comment le framework fonctionne.</p>
<div class="section" id="structure-du-projet">
<h2>Structure du projet<a class="headerlink" href="#structure-du-projet" title="Lien permanent vers ce titre">¶</a></h2>
<p>Une fois que vous avez cloné le projet, à partir de la racine, vous verrez la structure suivante :</p>
<div class="highlight-bash"><div class="highlight"><pre>invo/
    app/
        app/config/
        app/controllers/
        app/library/
        app/models/
        app/plugins/
        app/views/
    public/
        public/bootstrap/
        public/css/
        public/js/
    schemas/
</pre></div>
</div>
<p>Comme vous l&#8217;avez vu précédemment, Phalcon n&#8217;impose pas de structure particulière pour développer une application.
Ce projet fournit une simple structure MVC et un document public à la racine.</p>
<p>Une fois l&#8217;application ouverte dans votre navigateur à l&#8217;adresse : <a class="reference external" href="http://localhost/invo">http://localhost/invo</a> vous verrez quelque chose comme ça :</p>
<div class="figure align-center">
<img alt="../_images/invo-1.png" src="../_images/invo-1.png" />
</div>
<p>Cette application est divisé en deux parties, un frontend, qui est une partie publique où les visiteurs peuvent obtenir des informations à propos d&#8217;INVO et des informations de contact.
La seconde partie est le backend, une zone administrative où un utilisateur enregistré peu gérer ses produits et ses clients.</p>
</div>
<div class="section" id="routage">
<h2>Routage<a class="headerlink" href="#routage" title="Lien permanent vers ce titre">¶</a></h2>
<p>INVO utilise le routage standard qui est construit avec le composant Router. Ces routes correspondent au schéma suivant : /:controller/:action/:params.
Cela signifie que la première partie de l&#8217;URI est le controller, la seconde est l&#8217;action et la suite sont les paramètres.</p>
<p>La route suivante /session/register exécute le controlleur &#8220;SessionController&#8221; et son action &#8220;registerAction&#8221;.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Lien permanent vers ce titre">¶</a></h2>
<p>INVO a un fichier de configuration qui définit les paramètres génèraux de l&#8217;application. Ce fichier est lu par les premières lignes du fichier boostrap (public/index.php) :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Read the configuration</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Config\Adapter\Ini</span><span class="p">(</span><span class="s1">&#39;../app/config/config.ini&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference internal" href="config.html"><em>Phalcon\Config</em></a> nous permet de manipuler le fichier comme un objet. Le fichier de configuration contient les paramètres suivants :</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[database]</span>
<span class="na">host</span>     <span class="o">=</span> <span class="s">localhost</span>
<span class="na">username</span> <span class="o">=</span> <span class="s">root</span>
<span class="na">password</span> <span class="o">=</span> <span class="s">secret</span>
<span class="na">name</span>     <span class="o">=</span> <span class="s">invo</span>

<span class="k">[application]</span>
<span class="na">controllersDir</span> <span class="o">=</span> <span class="s">/../app/controllers/</span>
<span class="na">modelsDir</span>      <span class="o">=</span> <span class="s">/../app/models/</span>
<span class="na">viewsDir</span>       <span class="o">=</span> <span class="s">/../app/views/</span>
<span class="na">pluginsDir</span>     <span class="o">=</span> <span class="s">/../app/plugins/</span>
<span class="na">libraryDir</span>     <span class="o">=</span> <span class="s">/../app/library/</span>
<span class="na">baseUri</span>        <span class="o">=</span> <span class="s">/invo/</span>

<span class="c1">;[metadata]</span>
<span class="c1">;adapter = &quot;Apc&quot;</span>
<span class="c1">;suffix = my-suffix</span>
<span class="c1">;lifetime = 3600</span>
</pre></div>
</div>
<p>Phalcon n&#8217;a pas de convention de codage défini. Les sections nous permettent d&#8217;organiser les options de manière appropriée. Dans ce fichier il y a trois sections que l&#8217;on utilisera plus tard.</p>
</div>
<div class="section" id="autoloaders">
<h2>Autoloaders<a class="headerlink" href="#autoloaders" title="Lien permanent vers ce titre">¶</a></h2>
<p>La seconde partie du fichier boostrap (public/index.php) est l&#8217;autoloader (mécanisme de chargement automatique).
L&#8217;autoloader enregistre un ensemble de dossies où l&#8217;application va chercher les classes dont il va avoir besoin.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Loader</span><span class="p">();</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">registerDirs</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">controllersDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">pluginsDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">libraryDir</span><span class="p">,</span>
        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">application</span><span class="o">-&gt;</span><span class="na">modelsDir</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
</pre></div>
</div>
<p>Notez que ce qu&#8217;il fait est d&#8217;enregistrer les dossiers qui sont définis dans le fichier de configuration.
Le seul dossier qui n&#8217;est pas enregistré est viewsDir parce qu&#8217;il ne contient pas de classes mais des fichiers de type HTML + PHP.</p>
</div>
<div class="section" id="gerer-la-requete">
<h2>Gérer la requête<a class="headerlink" href="#gerer-la-requete" title="Lien permanent vers ce titre">¶</a></h2>
<p>Allons plus loin dans le fichier, à la fin, la requête est finalement gérée par Phalcon\Mvc\Application,
cette classe initialise et exécute tous ce qui est nécessaire pour faire tourner l&#8217;application:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Mvc\Application</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

<span class="k">echo</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="injection-de-dependances">
<h2>Injection de dépendances<a class="headerlink" href="#injection-de-dependances" title="Lien permanent vers ce titre">¶</a></h2>
<p>Regardez à la premiére ligne du code juste au dessus, la variable $app reçoit une autre variable $di dans son constructeur.
Quel est le but de cette variable ? Phalcon est un framework fortement découplé, donc on a besoin d&#8217;un composant qui agit comme une sorte de colle pour que tout fonctionne ensemble, correctement.</p>
<p>Ce composant est Phalcon\DI. C&#8217;est un conteneur de services qui fait des injections de dépendances et qui instancie tous les composants quand ils sont nécessaires pour l&#8217;application.</p>
<p>Il y a différents moyens d&#8217;enregistrer les services dans un conteneur. Dans INVO la plupart des services ont été enregistrés en utilisant des fonctions anonymes.
Grace à cela, les objets sont instanciés paresseusement (= uniquement lorsque nécessaire) , ce qui réduit les ressources requises par l&#8217;application.</p>
<p>Par exemple, dans l&#8217;extrait suivant, le service de session est enregistré, la fonction anonyme sera appelée uniquement lorsque l&#8217;application aura besoin d&#8217;accéder aux données de la session:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Start the session the first time when some component request the session service</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Session\Adapter\Files</span><span class="p">();</span>
    <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$session</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Dans cette situation, on a la possibilité de changer l&#8217;adaptateur, de faire des initialisation supplémentaires ainsi que beaucoup d&#8217;autres choses.
Notez que le service est enregistré avec le nom &#8220;session&#8221;, c&#8217;est une convention qui va permettre au framework d&#8217;identifier le service actifdans le conteneur de service.</p>
<p>Une requête peux utiliser plusieurs services, enregistrer chaque services un par un peux être une lourde tâche.
Pour cette raison le framework fournit une variante à Phalcon\DI appelée Phalcon\DI\FactoryDefault qui a pour mission d&#8217;enregistrer tous les services, fournissant ainsi un framework complet.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// The FactoryDefault Dependency Injector automatically registers the</span>
<span class="c1">// right services providing a full stack framework</span>
<span class="nv">$di</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\DI\FactoryDefault</span><span class="p">();</span>
</pre></div>
</div>
<p>Cet extrait enregistre la majorité des services avec les composants fournis par le framework. Si on a besoin d&#8217;outrepasser la définition de certains services
on pourrait le modifier comme on l&#8217;a fait pour la &#8220;session&#8221; au dessus. C&#8217;est l&#8217;intérêt de la variable $di.</p>
</div>
<div class="section" id="se-connecter-a-l-application">
<h2>Se connecter à l&#8217;application<a class="headerlink" href="#se-connecter-a-l-application" title="Lien permanent vers ce titre">¶</a></h2>
<p>Se connecter va nous premettre de travailler sur les controlleurs du backend. La séparation entre les controlleurs du backend et du frontend sont purement d&#8217;ordre logique,
car tous les contrôleurs sont localisés dans le même dossier (app/controllers/).</p>
<p>Pour se connecter il faut un nom d&#8217;utilsateur et un mot de passe valide. Les utilisateurs sont stockés dans la table &#8220;users&#8221; de la base de données &#8220;invo&#8221;.</p>
<p>Avant de pouvoir commencer une session, nous devons configurer la connexion à la base de données. Un service appelé &#8220;db&#8221; est utilisé dans le conteneur de service avec cette information.
Pour ce qui est de l&#8217;autoloader, on prends en paramètres les informations du fichier de configuration de manière à configurer le service :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Database connection is created based on the parameters defined in the configuration file</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Mysql</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">&quot;host&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">host</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">,</span>
        <span class="s2">&quot;dbname&quot;</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">name</span>
    <span class="p">));</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Ici on retourne une instance de l&#8217;adaptateur de connexion à MySQL.
Si nécessaire on pourrait faire des actions supplémentaire tel qu&#8217;ajouter un logger, un profileur ou changer l&#8217;adaptateur, ...</p>
<p>Le formulaire (app/views/session/index.phtml) demande les informations de connexion.
Certaines lignes HTML ont été supprimés dans l&#8217;extrait suivant pour rendre l&#8217;exemple plus concis:</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">form</span><span class="p">(</span><span class="s1">&#39;session/start&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>Username/Email<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">textField</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;30&quot;</span><span class="p">))</span> <span class="cp">?&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">passwordField</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;30&quot;</span><span class="p">))</span> <span class="cp">?&gt;</span>

    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">submitButton</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;Login&#39;</span><span class="p">))</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>Le SessionController::startAction (app/controllers/SessionController.phtml) a pour tâche de valider les données entrées à la recherche d&#8217;un utilisateur valide dans la base de données :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">SessionController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">startAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>

            <span class="c1">//Receiving the variables sent by POST</span>
            <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">);</span>
            <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

            <span class="nv">$password</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

            <span class="c1">//Find for the user in the database</span>
            <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Users</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;email = :email: AND password = :password: AND active = &#39;Y&#39;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bind&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$password</span><span class="p">)</span>
            <span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">!=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">&#39;Welcome &#39;</span> <span class="o">.</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>

                <span class="c1">//Forward to the &#39;invoices&#39; controller if the user is valid</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;invoices&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
                <span class="p">));</span>
            <span class="p">}</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">&#39;Wrong email/password&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//Forward to the login form again</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
        <span class="p">));</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Pour des raisons de simplicité, nous avons utilisé &#8220;<a class="reference external" href="http://php.net/manual/en/function.sha1.php">sha1</a>&#8221; pour stocker le mot de passe hashé dans la base de données, cependant cet algorithme n&#8217;est pas recommandé pour une vraie application,
il est préférable d&#8217;utiliser &#8221; <a class="reference internal" href="security.html"><em>bcrypt</em></a>&#8221; à la place.</p>
<p>Veuillez noter que plusieurs attributs public sont accessibles dans le contrôleur avec $this-&gt;flash, $this-&gt;request ou $this-&gt;session.
Ceux-ci sont des servies défini dans le conteneur de service de tout à l&#8217;heure. Quand ils sont accédés pour la première fois, ils sont insérés dans le controlleur.</p>
<p>Ces services sont partagés, ce qui signifie qu&#8217;on accéde à la même instance sans tenir compte de l&#8217;endroit où on les a créés.</p>
<p>Par exemple, ici on créé le service de sessions et on enregistre l&#8217;identité de utilisateur dans la variable &#8220;auth&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
<span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="securiser-le-backend">
<h2>Sécuriser le Backend<a class="headerlink" href="#securiser-le-backend" title="Lien permanent vers ce titre">¶</a></h2>
<p>Le backend est une zone privé où seul les personnes enregistrés ont accès. Par conséquent il est nécessaire de vérifier que seul les utilisateurs enregistrés ont accés à ces contrôleurs.
Si vous n&#8217;êtes pas connectés à l&#8217;application et que vous essayez d&#8217;accéder au contrôleur product, par exemple, vous verrez le message suivant :</p>
<div class="figure align-center">
<img alt="../_images/invo-2.png" src="../_images/invo-2.png" />
</div>
<p>A chaque fois que quelqu&#8217;un essaye d&#8217;accéder à n&#8217;importe quel contrôleur/action, l&#8217;application va vérifier que le rôle de l&#8217;utilisateur (en session) lui permet d&#8217;y accéder,
sinon il affiche un message comme celui du dessus et transfert le flux à la page d&#8217;accueil.</p>
<p>Maintenant, découvrons comment l&#8217;application fait cela. La première chose à savoir est qu&#8217;il y a un composant appelé <a class="reference internal" href="dispatching.html"><em>Dispatcher</em></a>.
Il est informé de la route trouvé par le composant <a class="reference internal" href="routing.html"><em>Routing</em></a>. Puis, il est responsable de charger le contrôleur approprié et d&#8217;exécuter l&#8217;action correspondante.</p>
<p>En temps normal, le framework créé le dispatcher automatiquement. Dans notre cas, nous voulons faire une vérification avant d&#8217;exécuter l&#8217;action requise,
vérifier si l&#8217;utilisateur y a accès ou pas. Pour faire cela, nous avons remplacé le composant en créant une fonction dans le bootstrap (public/index.php):</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$di</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Nous avons maintenant un contrôle complet sur le dispatcher utilisé dans notre application.
Plusieurs composants du framework déclenchent des évènements qui nous autorisent à modifier le flux interne des opérations.
Comme l&#8217;injecteur de dépendances agit comme une &#8220;colle&#8221; pour composants, un nouveau composant appelé <a class="reference internal" href="events.html"><em>EventsManager</em></a>
nous aide à intercepter les évènements produits par un composant routant les évènements aux listeners.</p>
<div class="section" id="gestion-des-evenements">
<h3>Gestion des évènements<a class="headerlink" href="#gestion-des-evenements" title="Lien permanent vers ce titre">¶</a></h3>
<p>Un <a class="reference internal" href="events.html"><em>EventsManager</em></a> (gestionnaire d&#8217;évènement) nous permet d&#8217;attacher un ou plusieurs listeners à un type particulier d&#8217;évènement.
Le type d&#8217;évènement qui nous intéresse actuellement est le &#8220;dispatch&#8221;, la code suivant filtre tous les évènements produit par le dispatcher :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$di</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//Obtain the standard eventsManager from the DI</span>
    <span class="nv">$eventsManager</span> <span class="o">=</span> <span class="nv">$di</span><span class="o">-&gt;</span><span class="na">getShared</span><span class="p">(</span><span class="s1">&#39;eventsManager&#39;</span><span class="p">);</span>

    <span class="c1">//Instantiate the Security plugin</span>
    <span class="nv">$security</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Security</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

    <span class="c1">//Listen for events produced in the dispatcher using the Security plugin</span>
    <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">&#39;dispatch&#39;</span><span class="p">,</span> <span class="nv">$security</span><span class="p">);</span>

    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">();</span>

    <span class="c1">//Bind the EventsManager to the Dispatcher</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Le plugin de sécurité est une classe situé dans (app/plugins/Security.php). Cette classe implémente une méthode &#8220;beforeExecuteRoute&#8221;.
C&#8217;est le même nom qu&#8217;un des évènement produit dans le dispatcer :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Security</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeExecuteRoute</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Les évènements &#8220;hooks&#8221; reçoivent toujours un premier paramètre qui contient le contexte de l&#8217;information de l&#8217;évènement produit ($event)
et un second paramètre qui est l&#8217;objet produit par l&#8217;évènement lui-même ($dispatcher). Il n&#8217;est pas obligatoire de faire étendre le plugin de la classe
Phalcon\Mvc\User\Plugin, mais en faisant ainsi on a un accès facilité aux services disponibles de l&#8217;application.</p>
<p>Maintenant nous allons vérifier le rôle de la session courrante, vérifier si l&#8217;utilisateur a accès en utilisant les listes ACL (access control list).
S&#8217;il/elle n&#8217;a pas accès, il/elle sera redirigé(e) vers la page d&#8217;accueil comme expliqué précédemment.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">,</span>
    <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Security</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeExecuteRoute</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//Check whether the &quot;auth&quot; variable exists in session to define the active role</span>
        <span class="nv">$auth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$auth</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">&#39;Guests&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">&#39;Users&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Take the active controller/action from the dispatcher</span>
        <span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getControllerName</span><span class="p">();</span>
        <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">();</span>

        <span class="c1">//Obtain the ACL list</span>
        <span class="nv">$acl</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getAcl</span><span class="p">();</span>

        <span class="c1">//Check if the Role have access to the controller (resource)</span>
        <span class="nv">$allowed</span> <span class="o">=</span> <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">isAllowed</span><span class="p">(</span><span class="nv">$role</span><span class="p">,</span> <span class="nv">$controller</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$allowed</span> <span class="o">!=</span> <span class="nx">Phalcon\Acl</span><span class="o">::</span><span class="na">ALLOW</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//If he doesn&#39;t have access forward him to the index controller</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s2">&quot;You don&#39;t have access to this module&quot;</span><span class="p">);</span>
            <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;index&#39;</span>
                <span class="p">)</span>
            <span class="p">);</span>

            <span class="c1">//Returning &quot;false&quot; we tell to the dispatcher to stop the current operation</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fournir-une-liste-acl">
<h3>Fournir une liste ACL<a class="headerlink" href="#fournir-une-liste-acl" title="Lien permanent vers ce titre">¶</a></h3>
<p>Dans l&#8217;exemple précédent, nous avons obtenu les ACL en utilisant la méthode $this-&gt;_getAcl(). Cette méthode est aussi
implémentée dans Plugin. Maintenant nous allons expliquer étape par étape comment nous avons construit les ACL (access control list) :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Create the ACL</span>
<span class="nv">$acl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Adapter\Memory</span><span class="p">();</span>

<span class="c1">//The default action is DENY access</span>
<span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">setDefaultAction</span><span class="p">(</span><span class="nx">Phalcon\Acl</span><span class="o">::</span><span class="na">DENY</span><span class="p">);</span>

<span class="c1">//Register two roles, Users is registered users</span>
<span class="c1">//and guests are users without a defined identity</span>
<span class="nv">$roles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Role</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">),</span>
    <span class="s1">&#39;guests&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Phalcon\Acl\Role</span><span class="p">(</span><span class="s1">&#39;Guests&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addRole</span><span class="p">(</span><span class="nv">$role</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>On défini les ressources pour chaque zone. Le nom des contrôleurs sont des ressources et leurs actions sont accédées pour les ressources :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Private area resources (backend)</span>
<span class="nv">$privateResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;companies&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;products&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;producttypes&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
  <span class="s1">&#39;invoices&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Phalcon\Acl\Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//Public area resources (frontend)</span>
<span class="nv">$publicResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;index&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
  <span class="s1">&#39;about&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
  <span class="s1">&#39;session&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">),</span>
  <span class="s1">&#39;contact&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;send&#39;</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Phalcon\Acl\Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Les ACL ont maintenant connaissance des contrôleurs et de leurs actions. Le rôle &#8220;Users&#8221; a accès à toutes les ressources du
backend et du frontend. Le rôle &#8220;Guest&#8221; en revanche n&#8217;a accès qu&#8217;à la partie publique :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Grant access to public areas to both users and guests</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="nv">$role</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$resource</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Grant access to private area only to role Users</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$actions</span> <span class="k">as</span> <span class="nv">$action</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="nv">$resource</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Hooray!, les ACL sont maintenant terminés.</p>
</div>
</div>
<div class="section" id="composants-utilisateurs">
<h2>Composants utilisateurs<a class="headerlink" href="#composants-utilisateurs" title="Lien permanent vers ce titre">¶</a></h2>
<p>Tous les éléments graphique et visuels de l&#8217;application ont été réalisés principalement avec <a class="reference external" href="http://twitter.github.io/bootstrap/">Twitter Bootstrap</a>.
Certains éléments, comme la barre de navigation, changent en fonction de l&#8217;état de l&#8217;applicatin (connecté/déconnecté).
Par exemple dans le coin en haut à droite, les liens &#8220;Log in/Sign up&#8221; (se connecter/s&#8217;inscrire) se changent en &#8220;Log out&#8221; (Se déconnecter)
quand un utilisateur se connecte.</p>
<p>Cette partie de l&#8217;application est implémentée en utilisant le composant &#8220;Elements&#8221; (app/library/Elements.php).</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\User\Component</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Elements</span> <span class="k">extends</span> <span class="nx">Component</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMenu</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTabs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Cette classe étend de Phalcon\Mvc\User\Component,il n&#8217;est pas imposé d&#8217;étendre un composant avec cette classe, mais
cela permet d&#8217;accéder plus rapidement/facilement aux services de l&#8217;application.
Maintenant enregistrons cette classe au conteneur de service :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Register an user component</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;elements&#39;</span><span class="p">,</span> <span class="k">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Elements</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Tout comme les contrôleurs, les plugins et les composants à l&#8217;intérieur des vues, ce composant à aussi accès aux services requis dans le conteneur en accédant juste à l&#8217;attribut.</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-navbar&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.nav-collapse&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>INVO<span class="nt">&lt;/a&gt;</span>
            <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elements</span><span class="o">-&gt;</span><span class="na">getMenu</span><span class="p">()</span> <span class="cp">?&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">()</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;hr&gt;</span>
    <span class="nt">&lt;footer&gt;</span>
        <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> Company 2012<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/footer&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>La partie la plus importante est :</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elements</span><span class="o">-&gt;</span><span class="na">getMenu</span><span class="p">()</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="travailler-avec-le-crud">
<h2>Travailler avec le CRUD<a class="headerlink" href="#travailler-avec-le-crud" title="Lien permanent vers ce titre">¶</a></h2>
<p>La plupart des options qui manipulent des données (companies, products et types de products), ont été développés
en utilisant un <a class="reference external" href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> (create/read/update/delete) basique et commun. Chaque CRUD contient les fichiers suivants :</p>
<div class="highlight-bash"><div class="highlight"><pre>invo/
    app/
        app/controllers/
            ProductsController.php
        app/models/
            Products.php
        app/views/
            products/
                edit.phtml
                index.phtml
                new.phtml
                search.phtml
</pre></div>
</div>
<p>Chaque contrôleur a les actions suivantes :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * The start action, it shows the &quot;search&quot; view</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Execute the &quot;search&quot; based on the criteria sent from the &quot;index&quot;</span>
<span class="sd">     * Returning a paginator for the results</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">searchAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Shows the view to create a &quot;new&quot; product</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">newAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Shows the view to &quot;edit&quot; an existing product</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Updates a product based on the data entered in the &quot;edit&quot; action</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Deletes an existing product</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">deleteAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="formulaire-de-recherche">
<h3>Formulaire de recherche<a class="headerlink" href="#formulaire-de-recherche" title="Lien permanent vers ce titre">¶</a></h3>
<p>Tous les CRUD commencent avec le formulaire de recherche. Ce formulaire montre tous les champs que la table products possède,
permettant à l&#8217;utilisateur de filtrer ses recherches. La tâche &#8220;products&#8221; est liée à la table &#8220;products_types&#8221;.
Dans notre cas, nous avons déjà demandé des enregistrements de cette table, afin de faciliter la recherche dans ce champ :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * The start action, it shows the &quot;search&quot; view</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">persistent</span><span class="o">-&gt;</span><span class="na">searchParams</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">productTypes</span> <span class="o">=</span> <span class="nx">ProductTypes</span><span class="o">::</span><span class="na">find</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Tous les types de produits sont cherchés et passés à la vue en tant que variable locale &#8220;productType&#8221;. Puis, dans la vue
(app/views/index.phtml) on montre un champ &#8220;select&#8221; remplis avec ces résultats :</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;product_types_id&quot;</span><span class="nt">&gt;</span>Product Type<span class="nt">&lt;/label&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span>
        <span class="nv">$productTypes</span><span class="p">,</span>
        <span class="s2">&quot;using&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="s2">&quot;useDummy&quot;</span> <span class="o">=&gt;</span> <span class="k">true</span>
    <span class="p">))</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>Notez que $productTypes contient les données nécessaires pour remplir le tag SELECT en utilisant Phalcon\Tag::select.
Une fois le formulaire validé, l&#8217;action &#8220;search&#8221; est exécuté dans le contrôleur, réalisant la recherche basé sur les
données entrées par l&#8217;utilisateur.</p>
</div>
<div class="section" id="executer-une-recherche">
<h3>Exécuter une recherche<a class="headerlink" href="#executer-une-recherche" title="Lien permanent vers ce titre">¶</a></h3>
<p>L&#8217;action de recherche a un double comportement. Quand on y accéde avec POST, cela fait une recherche basé sur les données
que l&#8217;on a envoyé à partir du formulaire. Mais quand on y accéde via GET cela change la page courante dans le paginateur.
Pour différencier la méthode (GET ou POST), nous utilisons le composant <a class="reference internal" href="request.html"><em>Request</em></a> :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Execute the &quot;search&quot; based on the criteria sent from the &quot;index&quot;</span>
<span class="sd"> * Returning a paginator for the results</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">searchAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">//create the query conditions</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//paginate using the existing conditions</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Avec l&#8217;aide de <a class="reference internal" href="../api/Phalcon_Mvc_Model_Criteria.html"><em>Phalcon\Mvc\Model\Criteria</em></a> ,nous pouvons créer les conditions de recherche basé sur les types de données envoyé via le formulaire :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nx">Criteria</span><span class="o">::</span><span class="na">fromInput</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">di</span><span class="p">,</span> <span class="s2">&quot;Products&quot;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span>
</pre></div>
</div>
<p>Cette méthode vérifie quelle valeur est différente de &#8220;&#8221; (chaine vide) et &#8220;null&#8221; et les prends en compte pour créer les critères de recherche :</p>
<ul class="simple">
<li>Si le champs de données est &#8220;text&#8221; ou similaire (char, varchar, text, etc.). L&#8217;opérateur &#8220;like&#8221; sera utilisé pour filtrer les résultats.</li>
<li>Si le type de donnée est différent, l&#8217;opérateur &#8220;=&#8221; sera utilisé</li>
</ul>
<p>De plus, &#8220;Criteria&#8221; ignore toutes les variables POST qui ne correspondent à aucun champs de la table.
Les valeurs seront automatiquement échappées en utilisant les paramètres liés (bond parameters).</p>
<p>Maintenant, on va stoquer les paramètres dans le &#8220;sac&#8221; de session du contrôleur :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">persistent</span><span class="o">-&gt;</span><span class="na">searchParams</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">();</span>
</pre></div>
</div>
<p>Un sac de session est un attribut particulier dans un contrôleur qui est sauvegardé entre les requêtes.
Quand on y accède, cet attribut injecte un service <a class="reference internal" href="../api/Phalcon_Session_Bag.html"><em>Phalcon\Session\Bag</em></a> qui est indépendant de chaque contrôleur.</p>
<p>Puis, basé sur les paramètres passé, on génère la requête :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$products</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">notice</span><span class="p">(</span><span class="s2">&quot;The search did not found any products&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si la recherche ne retourne aucun produit, on transfert l&#8217;utilisateur à l&#8217;action index. Si la recherche retourne des résultats,
on créé un paginateur pour se déplacer à travers les pages facilement :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$paginator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon\Paginator\Adapter\Model</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">&quot;data&quot;</span> <span class="o">=&gt;</span> <span class="nv">$products</span><span class="p">,</span>    <span class="c1">//Data to paginate</span>
    <span class="s2">&quot;limit&quot;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>           <span class="c1">//Rows per page</span>
    <span class="s2">&quot;page&quot;</span> <span class="o">=&gt;</span> <span class="nv">$numberPage</span>   <span class="c1">//Active page</span>
<span class="p">));</span>

<span class="c1">//Get active page in the paginator</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$paginator</span><span class="o">-&gt;</span><span class="na">getPaginate</span><span class="p">();</span>
</pre></div>
</div>
<p>Enfin, on passe la page retournée à la vue:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">setVar</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="nv">$page</span><span class="p">);</span>
</pre></div>
</div>
<p>Dans la vue (app/views/products/search.phtml), on affiche le résultat correspondant à la page actuelle :</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$page</span><span class="o">-&gt;</span><span class="na">items</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getProductTypes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">price</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">active</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">linkTo</span><span class="p">(</span><span class="s2">&quot;products/edit/&quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">linkTo</span><span class="p">(</span><span class="s2">&quot;products/delete/&quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;Delete&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="creer-et-modifier-des-entrees">
<h3>Créer et modifier des entrées<a class="headerlink" href="#creer-et-modifier-des-entrees" title="Lien permanent vers ce titre">¶</a></h3>
<p>Voyons comment le CRUD créé et modifie des entrées. A partir des vues &#8220;new&#8221; et &#8220;edit&#8221;, la donnée entrée par l&#8217;utilisateur
est envoyé à l&#8217;action &#8220;create&#8221; et &#8220;save&#8221; qui exécute l&#8217;action de créer ou de modifier les produits.</p>
<p>Dans la page de création, on récupère les données envoyés et on leur assigne une nouvelle instance de produit :</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="nv">$products</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Products</span><span class="p">();</span>

    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">product_types_id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;striptags&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">price</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">);</span>
    <span class="nv">$products</span><span class="o">-&gt;</span><span class="na">active</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Les données sont filtrés avant d&#8217;être assignés à l&#8217;objet. Ce filtrage est optionnel, l&#8217;ORM échappe les données entrées et
caste les données en fonction des types des champs.</p>
<p>Quand on sauvegarde, nous saurons si la donnée est conforme aux règles et validations implémentés dans le model Products:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Creates a product based on the data entered in the &quot;new&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$products</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">())</span> <span class="p">{</span>

        <span class="c1">//The store failed, the following messages were produced</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$products</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">((</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$message</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/new&quot;</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s2">&quot;Product was created successfully&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Maintenant, dans le cas de la modification de produit, on doit présenter les données à éditer à l&#8217;utilisateur en pré-remplissant les champs:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Shows the view to &quot;edit&quot; an existing product</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">findFirstById</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;product_types_id&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">product_types_id</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">price</span><span class="p">);</span>
    <span class="nx">Tag</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">active</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>L&#8217;helper &#8220;setDefault&#8221; entre les valeurs du produit dans les champs qui portent le même nom comme valeur par défaut.
Grace à cela, l&#8217;utilisateur peut changer n&#8217;importe quelle valeur et ensuite envoyer ses modifications à la base de données avec l&#8217;action &#8220;save&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Updates a product based on the data entered in the &quot;edit&quot; action</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">saveAction</span><span class="p">()</span>
<span class="p">{</span>

    <span class="c1">//...</span>

    <span class="c1">//Find the product to update</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">findFirstById</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s2">&quot;products does not exist &quot;</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s2">&quot;products/index&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//... assign the values to the object and store it</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="changer-le-titre-de-maniere-dynamique">
<h2>Changer le titre de manière dynamique<a class="headerlink" href="#changer-le-titre-de-maniere-dynamique" title="Lien permanent vers ce titre">¶</a></h2>
<p>Quand vous naviguez sur le site, vous remarquerez que le titre change d&#8217;une page à l&#8217;autre.
Cela est réalisé dans l&#8216;&#8220;initializer&#8221; de chaque contrôleur.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Set the document title</span>
        <span class="nx">Tag</span><span class="o">::</span><span class="na">setTitle</span><span class="p">(</span><span class="s1">&#39;Manage your product types&#39;</span><span class="p">);</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">initialize</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Notez que la méthode parent::initialize() est aussi appelée, cela ajoute plus de donnée à la suite du titre:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ControllerBase</span> <span class="k">extends</span> <span class="nx">Phalcon\Mvc\Controller</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Prepend the application name to the title</span>
        <span class="nx">Phalcon\Tag</span><span class="o">::</span><span class="na">prependTitle</span><span class="p">(</span><span class="s1">&#39;INVO | &#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Enfin, le titre est affiché dans la vue principale (app/views/index.phtml) :</p>
<div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">use</span> <span class="nx">Phalcon\Tag</span> <span class="k">as</span> <span class="nx">Tag</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">getTitle</span><span class="p">()</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Lien permanent vers ce titre">¶</a></h2>
<p>Ce tutoriel a couvert plusieurs aspect de la construction d&#8217;application avec Phalcon, nous espérons qu&#8217;il vous aura
permis d&#8217;en apprendre plus sur le framework.</p>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="Index général"
             >index</a></li>
        <li class="right" >
          <a href="tutorial-rest.html" title="Tutorial 3: Créer une application REST API"
             >suivant</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial 1: Let’s learn by example"
             >précédent</a> |</li> 
      </ul>
    </div>
        <div id="footer">

          <p>Found a typo or an error? Want to improve this document? The documentation sources are available on <a href="http://github.com/phalcon/docs">Github</a></p>
          <p>Need support or have questions? Check our <a href="http://phalconphp.com/support">Support Page</a></p>

          <p>The Phalcon PHP Framework is released under the <a href="https://github.com/phalcon/cphalcon/blob/master/docs/LICENSE.md">new BSD license</a>.</p>
          <p>Except where otherwise noted, content on this site is licensed under the
            <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License.</a></p>
             Mis à jour le Oct 21, 2014.
            Créé avec <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.

          <p>
             &copy; Copyright 2014, Phalcon Team and contributors.
          </p>

            <div class="size-wrap footer-wrap">

                <div class="donate-wrap">
                    Donate to Phalcon: <a href="http://flattr.com/thing/1134206/Phalcon-PHP-Framework" target="_blank" class="button button-small orange">Flattr</a>
                    or
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" style="display: inline">
                        <input type="hidden" name="cmd" value="_s-xclick">
                        <input type="hidden" name="hosted_button_id" value="7LSYMNMFZNG8W">
                        <input class="button button-small orange" style="border: inherit; display: inline; font-weight: bold" type="submit" value="via Paypal" title="PayPal — The safer, easier way to pay online.">
                    </form>
                </div>

                <div class="social-links">
                    <a href="https://twitter.com/phalconphp" class="social-link tw">Twitter</a>
                    <a href="http://www.facebook.com/pages/Phalcon/134230726685897" class="social-link fb">Facebook</a>
                    <a href="https://plus.google.com/102376109340560896457" class="social-link gp">Google Plus</a>
                    <a href="http://vimeo.com/user10964377" class="social-link vm">Vimeo</a>
                </div>

            </div>

        </div>

    </div>
    <script type="text/javascript">
    $(window).on("load", function(){
      var cx = '009733439235723428699:lh9ltjgvdz8';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
      /*window.setTimeout(function(){
        $('.gsc-search-button').css({
          'background': '#f06715',
          'padding': '2px',
          'border': '0'
        });
      }, 1000)*/
    });
    </script>

  </body>
</html>