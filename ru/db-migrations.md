<div class='article-menu'>
  <ul>
    <li>
      <a href="#overview">Миграции базы данных</a> <ul>
        <li>
          <a href="#schema-dumping">Сохранение схемы БД</a>
        </li>
        <li>
          <a href="#migration-class-anatomy">Структура класса Migration</a>
        </li>
        <li>
          <a href="#defining-columns">Определение столбцов</a>
        </li>
        <li>
          <a href="#defining-indexes">Определение индексов</a>
        </li>
        <li>
          <a href="#defining-references">Определение ключей</a>
        </li>
        <li>
          <a href="#writing-migrations">Запись миграций</a>
        </li>
        <li>
          <a href="#running-migrations">Запуск миграций</a>
        </li>
      </ul>
    </li>
  </ul>
</div>

<a name='overview'></a>

# Миграции базы данных

Миграции — это удобный способ изменения вашей базы данных структурированным и организованным способом.

<div class="alert alert-danger">
    <p>
        Миграции доступны через <a href="/[[language]]/[[version]]/devtools-usage">Phalcon Developer Tools</a>. Вам потребуется Phalcon версии не ниже 0.5.0 для использования инструментов разработчика.
    </p>
</div>

Часто при разработке необходимо вносить изменения уже на стадии релиза приложения, на боевом сервере. Некоторые из этих изменений могут касаться изменений в базе данных: новые столбцы, новые таблицы, удаление индексов и т.д.

При миграции создается набор классов, чтобы описать, как ваша база данных структурирована в данный момент. Эти классы могут использоваться для синхронизации структуры схемы в удаленных базах данных и подготовки вашей базы данных к работе с новыми изменениями, которые реализует ваше приложение. Миграции описывают эти изменения с использованием простого PHP.

<div align='center'>
    <iframe src='https://player.vimeo.com/video/41381817' width='500' height='281' frameborder='0' webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
</div>

<a name='schema-dumping'></a>

## Сохранение схемы БД

[Phalcon Developer Tools](/[[language]]/[[version]]/devtools-usage) предоставляет скрипты для управления миграциями (генерация, запуск и откат).

Доступные опции для генерации миграций:

![](/images/content/migrations-1.png)

Запуск скрипта без каких-либо параметров делает простой дамп каждого объекта (таблиц и представлений) из вашей базы данных в классы миграции.

Каждая миграция имеет версию — идентификатор, который с ней ассоциируется. Номер версии позволяет нам определить, является ли миграция старше или новее текущей версии нашей базы данных. Версии также сообщают Phalcon о рабочем состоянии при выполнении миграции.

![](/images/content/migrations-2.png)

При генерации миграции, в консоли отображаются инструкции, описывающие шаги миграции, и время их выполнения. В конце концов, версия миграция будет создана.

По умолчанию [Phalcon Developer Tools](/[[language]]/[[version]]/devtools-usage) использует директорию `app/migrations` для сохранения файлов миграции. Вы можете изменить расположение, установив один из параметров по генерации скрипта. Каждая таблица в базе данных имеет свой соответствующий класс, созданный в отдельном файле директории, ссылающейся на её версию:

![](/images/content/migrations-2.png)

<a name='migration-class-anatomy'></a>

## Структура класса Migration

Каждый файл содержит уникальный класс, который расширяет `Phalcon\Mvc\Model\Migration`. Эти классы обычно имеют два метода: `up()` и `down()`. Метод `up()` выполняет миграцию, в то время как `down()` откатывает её.

Метод `up()` также содержит `магический` метод `morphTable()`. Магия начинается тогда, когда он распознает изменения, требующие синхронизации фактической таблицы в базе данных, к приведённому описанию.

```php
<?php

use Phalcon\Db\Column as Column;
use Phalcon\Db\Index as Index;
use Phalcon\Db\Reference as Reference;
use Phalcon\Mvc\Model\Migration;

class ProductsMigration_100 extends Migration
{
    public function up()
    {
        $this->morphTable(
            'products',
            [
                'columns' => [
                    new Column(
                        'id',
                        [
                            'type'          => Column::TYPE_INTEGER,
                            'size'          => 10,
                            'unsigned'      => true,
                            'notNull'       => true,
                            'autoIncrement' => true,
                            'first'         => true,
                        ]
                    ),
                    new Column(
                        'product_types_id',
                        [
                            'type'     => Column::TYPE_INTEGER,
                            'size'     => 10,
                            'unsigned' => true,
                            'notNull'  => true,
                            'after'    => 'id',
                        ]
                    ),
                    new Column(
                        'name',
                        [
                            'type'    => Column::TYPE_VARCHAR,
                            'size'    => 70,
                            'notNull' => true,
                            'after'   => 'product_types_id',
                        ]
                    ),
                    new Column(
                        'price',
                        [
                            'type'    => Column::TYPE_DECIMAL,
                            'size'    => 16,
                            'scale'   => 2,
                            'notNull' => true,
                            'after'   => 'name',
                        ]
                    ),
                ],
                'indexes' => [
                    new Index(
                        'PRIMARY',
                        [
                            'id',
                        ]
                    ),
                    new Index(
                        'product_types_id',
                        [
                            'product_types_id',
                        ]
                    ),
                ],
                'references' => [
                    new Reference(
                        'products_ibfk_1',
                        [
                            'referencedSchema'  => 'invo',
                            'referencedTable'   => 'product_types',
                            'columns'           => ['product_types_id'],
                            'referencedColumns' => ['id'],
                        ]
                    ),
                ],
                'options' => [
                    'TABLE_TYPE'      => 'BASE TABLE',
                    'ENGINE'          => 'InnoDB',
                    'TABLE_COLLATION' => 'utf8_general_ci',
                ],
            ]
        );
    }
}
```

Приведённый класс назван `ProductsMigration_100`. Суффикс 100 указывает на версию 1.0.0. Метод `morphTable()` принимает ассоциативный массив с 4 возможными параметрами:

| Параметр     | Описание                                                                                                                               | Опционально |
| ------------ | -------------------------------------------------------------------------------------------------------------------------------------- |:-----------:|
| `columns`    | Массив c набором столбцов таблицы.                                                                                                     |     Нет     |
| `indexes`    | Массив с набором индексов таблицы.                                                                                                     |     Да      |
| `references` | Массив с набором связей таблицы (внешние ключи).                                                                                       |     Да      |
| `options`    | Массив с набором параметров таблицы при создании. Эти параметры часто связаны с системой базы данных, в которой была создана миграция. |     Да      |

<a name='defining-columns'></a>

### Определение столбцов

`Phalcon\Db\Column` используется для определения столбцов таблицы. Этот класс инкапсулирует возможности связанные с конкретным столбцом. Его конструктор принимает в качестве первого параметра имя столбца и массив, описывающий колонки. Доступны следующие опции при описании столбцов:

| Свойство        | Описание                                                                                                                   | Опционально |
| --------------- | -------------------------------------------------------------------------------------------------------------------------- |:-----------:|
| `type`          | Тип столбца. Должен быть константой `Phalcon\Db\Column` (смотрите ниже)                                                  |     Нет     |
| `size`          | Размер, который указывается для некоторые типов столбцов, таких как `VARCHAR` или `INTEGER`                                |     Да      |
| `scale`         | Количество десятичных знаков после запятой для столбцов `DECIMAL` или `NUMBER`                                             |     Да      |
| `unsigned`      | Столбцы `INTEGER` могут быть беззнаковыми (UNSIGNED). Эту опцию не стоит применять для столбцов других типов               |     Да      |
| `notNull`       | Может ли столбец содержать значения Null?                                                                                  |     Да      |
| `default`       | Значение по умолчанию для столбца (Должно быть конкретизировано. Использование функций, таких как `NOW()`, не допускается) |     Да      |
| `autoIncrement` | С данными атрибутом числовое поле будет заполняться автоматически. Только одно поле в таблице может иметь такой атрибут.   |     Да      |
| `first`         | Столбец будет размещен первым в структуре таблицы                                                                          |     Да      |
| `after`         | Название столбца, после которого будет размещен текущий столбец                                                            |     Да      |

Миграции поддерживают следующие типы столбцов:

* `Phalcon\Db\Column::TYPE_INTEGER`
* `Phalcon\Db\Column::TYPE_VARCHAR`
* `Phalcon\Db\Column::TYPE_CHAR`
* `Phalcon\Db\Column::TYPE_DATE`
* `Phalcon\Db\Column::TYPE_DATETIME`
* `Phalcon\Db\Column::TYPE_TIMESTAMP`
* `Phalcon\Db\Column::TYPE_DECIMAL`
* `Phalcon\Db\Column::TYPE_TEXT`
* `Phalcon\Db\Column::TYPE_BOOLEAN`
* `Phalcon\Db\Column::TYPE_FLOAT`
* `Phalcon\Db\Column::TYPE_DOUBLE`
* `Phalcon\Db\Column::TYPE_TINYBLOB`
* `Phalcon\Db\Column::TYPE_BLOB`
* `Phalcon\Db\Column::TYPE_MEDIUMBLOB`
* `Phalcon\Db\Column::TYPE_LONGBLOB`
* `Phalcon\Db\Column::TYPE_JSON`
* `Phalcon\Db\Column::TYPE_JSONB`
* `Phalcon\Db\Column::TYPE_BIGINTEGER`

<a name='defining-indexes'></a>

### Определение Индексов

`Phalcon\Db\Index` определяет индексы таблицы. Для создания индекса требуется определить его имя и список столбцов. Заметим, что если любой индекс имеет название `PRIMARY`, то Phalcon создаст индекс первичного ключа в этой таблице.

<a name='defining-references'></a>

### Определение Связей

`Phalcon\Db\Reference` определяет связи таблицы (также называемые внешними ключами). Следующие параметры могут быть использованы для определения связей:

| Параметр            | Описание                                                                                                    | Опционально | Реализовано в    |
| ------------------- | ----------------------------------------------------------------------------------------------------------- |:-----------:| ---------------- |
| `referencedTable`   | Говорит само за себя. Содержит имя ссылочной таблицы.                                                       |     Нет     | Все адаптеры     |
| `columns`           | Массив с названием столбцов, которые формируют связь с внешней таблицей.                                    |     Нет     | Все адаптеры     |
| `referencedColumns` | Массив с названием столбцов связываемой (внешней) таблицы.                                                  |     Нет     | Все адаптеры     |
| `referencedSchema`  | Связываемая таблица может находится в другой схеме или базе данных. Эта опция позволяет вам определить это. |     Да      | Все адаптеры     |
| `onDelete`          | Если внешняя запись удалена, выполняет это действие с локальной записью (записями).                         |     Да      | MySQL PostgreSQL |
| `onUpdate`          | Если внешняя запись обновлена, выполняет это действие с локальной записью (записями).                       |     Да      | MySQL PostgreSQL |

<a name='writing-migrations'></a>

## Запись миграций

Миграции предназначены не только для изменения структуры таблицы. Миграция является обычным классом PHP, так что вы не ограничены этими функциями. Например, после добавления столбца можно написать код для установки значений этого столбца для существующих записей. Для более подробной информации и примеров отдельных методов, обратитесь к разделу [Уровень абстракции базы данных](/[[language]]/[[version]]/db).

```php
<?php

use Phalcon\Mvc\Model\Migration;

class ProductsMigration_100 extends Migration
{
    public function up()
    {
        // ...

        self::$_connection->insert(
            'products',
            [
                'Malabar spinach',
                14.50,
            ],
            [
                'name',
                'price',
            ]
        );
    }
}
```

<a name='running-migrations'></a>

## Запуск миграций

Как только сгенерированные миграции загружены на целевой сервер, вы можете легко запустить их, как показано в следующем примере:

![](/images/content/migrations-4.png)

![](/images/content/migrations-5.png)

В зависимости от того, насколько сильно устаревшей является текущая версия базы данных, Phalcon может запускать несколько версий миграции в одном процессе миграции. Если указать целевую версию, Phalcon будет запускать нужные миграций пока не достигнет указанной версии.